"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1388],{1388(Z1,t1,A){A.d(t1,{WorkbookPageModule:()=>K1});var P,q=A(2200),l1=A(4341),c1=A(7343),$=A(8132),_=A(467),R=A(8517),W=function(i,o){var s=function(){if(typeof window>"u")return new Map;if(!P){var i=window;i.Ionicons=i.Ionicons||{},P=i.Ionicons.map=i.Ionicons.map||new Map}return P}(),a=s.get(i);void 0===a?s.set(i,o):a!==o&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(i,'". Ensure that multiple icons are not mapped to the same icon name.'))};function J(i,o,s,a){if(0===i.length)return.15*o;const n=i.map(l=>"width"===s?l.maxX-l.minX:l.maxY-l.minY).filter(l=>l>5);if(0===n.length)return.15*o;n.sort((l,r)=>l-r);const e=n[Math.floor(n.length/2)]*a.charSizeMultiplier;return Math.max(o*a.minCharSizeRatio,Math.min(o*a.maxCharSizeRatio,e))}function x1(i,o){if(o.length<3)return!1;let s=!1;for(let a=0,n=o.length-1;a<o.length;n=a++){const c=o[a].x,e=o[a].y,g=o[n].y;e>i.y!=g>i.y&&i.x<(o[n].x-c)*(i.y-e)/(g-e)+c&&(s=!s)}return s}function Q(i,o,s){const a=[];for(let n=0;n<i.length;n++){const c=i[n];if(0===c.length)continue;let e=0;for(const g of c)x1(g,o)&&e++;e/c.length>=s&&a.push(n)}return a}function T(i,o,s,a){for(const n of a){if(n.strokeIndices.length<2)continue;const c=n.strokeIndices.filter(l=>l<s.length).map(l=>s[l]);if(c.length<2)continue;const e=c.map(l=>"x"===o?l.centerX:l.centerY),v=Math.min(...e),g=Math.max(...e);if(i>v&&i<g)return!0}return!1}function E(i,o){const s=o.length+1,a=Array.from({length:s},()=>[]),n=o.map(c=>c.intercept).sort((c,e)=>c-e);for(const c of i){let e=0;for(let g=0;g<n.length;g++)c.centerX>n[g]&&(e=g+1);a[s-1-e].push(c.strokeIndex)}return a}function Y(i,o,s,a){if(0===o.length||0===a.length)return{minX:Math.min(...a.map(r=>r.minX)),maxX:Math.max(...a.map(r=>r.maxX))};const n=o.map(r=>r.intercept).sort((r,w)=>r-w),c=s-1-i,e=Math.min(...a.map(r=>r.minX)),v=Math.max(...a.map(r=>r.maxX));return{minX:c>0?n[c-1]:e,maxX:c<n.length?n[c]:v}}function K(i,o,s,a,n,c){return i.map((e,v)=>{if(e.length<2)return[];const g=e.map(r=>o[r]),l=Y(v,s,i.length,g);return function k1(i,o,s,a,n,c){if(i.length<2)return[];const e=[...i].sort((l,r)=>l.centerY-r.centerY),v=[],g=o*n.minRowGapRatio;for(let l=0;l<e.length-1;l++){const x=e[l].maxY,d=e[l+1].minY,h=d-x;h>=g&&v.push({gapStart:x,gapEnd:d,gapSize:h})}return v.map(l=>({slope:0,intercept:(l.gapStart+l.gapEnd)/2,start:s.minX-10,end:s.maxX+10})).filter(l=>!T(l.intercept,"y",a,c))}(g,a,l,o,n,c)})}function y(i){if(i.length<=1)return 1;const o=Math.min(...i),s=Math.max(...i);return o>0?s/o:1/0}function Z(i,o,s,a,n,c){return i.map((v,g)=>{const l=o[g];if(0===l.length)return v;const r=l.map(u=>s[u]),w=Math.min(...r.map(u=>u.minY)),x=Math.max(...r.map(u=>u.maxY)),d=Y(g,a,o.length,r);let h=[...v];for(let u=0;u<10;u++){const k=[w,...h.map(B=>B.intercept).sort((B,C)=>B-C),x],f=[];for(let B=0;B<k.length-1;B++)f.push(k[B+1]-k[B]);if(f.length<=1)break;const M=y(f);if(M<=c.maxSizeRatio)break;let m=null,z=M,j=0,H=-1;const O=f.indexOf(Math.max(...f)),b=(k[O]+k[O+1])/2;if(!T(b,"y",s,n)){const B=[...f],C=f[O]/2;B.splice(O,1,C,C);const V=y(B);V<z&&(z=V,m="split",j=b)}if(h.length>0){const B=f.indexOf(Math.min(...f));if(B>0){const C=[...f];C[B-1]+=C[B],C.splice(B,1);const V=y(C);V<z&&(z=V,m="merge",H=B-1)}if(B<f.length-1){const C=[...f];C[B]+=C[B+1],C.splice(B+1,1);const V=y(C);V<z&&(z=V,m="merge",H=B)}}if("split"===m)h.push({slope:0,intercept:j,start:d.minX-10,end:d.maxX+10}),h.sort((C,V)=>C.intercept-V.intercept);else{if(!("merge"===m&&H>=0&&H<h.length))break;{const B=[...h].sort((C,V)=>C.intercept-V.intercept);B.splice(H,1),h=B}}}return h})}function U(i,o,s){return o.map((a,n)=>({index:n,points:a,strokeIndices:Q(i,a,s)}))}const o1=[0,165,330,135,300,105,270,75,240,45,210,15,180,345,150,315,120,285,90,255,60,225,30,195];function s1(i,o,s,a){const n=[];for(const c of i){const e=c.start,v=c.end;n.push(`  <line x1="${c.slope*e+c.intercept}" y1="${e}" x2="${c.slope*v+c.intercept}" y2="${v}" stroke="rgba(128,128,128,0.8)" stroke-width="2" stroke-dasharray="4,4" />`)}for(const c of o)for(const e of c){const v=e.start,g=e.end;n.push(`  <line x1="${v}" y1="${e.slope*v+e.intercept}" x2="${g}" y2="${e.slope*g+e.intercept}" stroke="rgba(128,128,128,0.8)" stroke-width="2" stroke-dasharray="4,4" />`)}return`<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${a}" viewBox="0 0 ${s} ${a}">\n${n.join("\n")}\n</svg>`}const j1={minColumnGapRatio:.25,minRowGapRatio:.25,charSizeMultiplier:2,minCharSizeRatio:.08,maxCharSizeRatio:.4,maxSizeRatio:2,lassoContainmentThreshold:.5};class a1{constructor(o){this.config=function O1(i){return{...j1,...i}}(o)}segment(o){const s=function A1(i,o){const{strokes:s,lassos:a,canvasWidth:n,canvasHeight:c}=i,e=a.map(m=>m.points);if(0===s.length)return{characters:[],strokes:[],lassos:U(s,e,o.lassoContainmentThreshold),columnDividers:[],rowDividers:[]};if(1===i.maxCharacters)return function S1(i,o,s){let a=1/0,n=-1/0,c=1/0,e=-1/0;for(const r of i)for(const w of r)a=Math.min(a,w.x),n=Math.max(n,w.x),c=Math.min(c,w.y),e=Math.max(e,w.y);a===1/0&&(a=n=c=e=0);const v={index:0,strokes:[...i],bounds:{minX:a,maxX:n,minY:c,maxY:e,width:n-a,height:e-c}},g=i.map((r,w)=>({index:w,points:r,characterIndex:0}));return{characters:[v],strokes:g,lassos:U(i,o,s.lassoContainmentThreshold),columnDividers:[],rowDividers:[]}}(s,e,o);const v=s.map((m,z)=>function p1(i,o){if(0===i.length)return{strokeIndex:o,minX:0,maxX:0,minY:0,maxY:0,centerX:0,centerY:0};let s=1/0,a=-1/0,n=1/0,c=-1/0;for(const e of i)s=Math.min(s,e.x),a=Math.max(a,e.x),n=Math.min(n,e.y),c=Math.max(c,e.y);return{strokeIndex:o,minX:s,maxX:a,minY:n,maxY:c,centerX:(s+a)/2,centerY:(n+c)/2}}(m,z)),g={minX:Math.min(...v.map(m=>m.minX)),maxX:Math.max(...v.map(m=>m.maxX)),minY:Math.min(...v.map(m=>m.minY)),maxY:Math.max(...v.map(m=>m.maxY))},l=J(v,n,"width",o),r=J(v,c,"height",o),w=function u1(i,o,s){const a=[];for(const n of o){const c=Q(i,n,s);c.length>0&&a.push({strokeIndices:c})}return a}(s,e,o.lassoContainmentThreshold);let x=function z1(i,o,s,a){if(i.length<2)return[];const n=Math.min(...i.map(l=>l.minY)),c=Math.max(...i.map(l=>l.maxY)),e=[...i].sort((l,r)=>l.centerX-r.centerX),v=[],g=o*s.minColumnGapRatio;for(let l=0;l<e.length-1;l++){const x=e[l].maxX,d=e[l+1].minX,h=d-x;h>=g&&v.push({gapStart:x,gapEnd:d,gapSize:h})}return v.map(l=>({slope:0,intercept:(l.gapStart+l.gapEnd)/2,start:n-10,end:c+10})).filter(l=>!T(l.intercept,"x",i,a))}(v,l,o,w);x=function M1(i,o,s,a){if(s.length<2)return i;const n=[];for(let l=0;l<s.length;l++){const r=s[l];if(0===r.strokeIndices.length)continue;const w=r.strokeIndices.filter(p=>p<o.length).map(p=>o[p]);if(0===w.length)continue;const x=Math.min(...w.map(p=>"x"===a?p.minX:p.minY)),d=Math.max(...w.map(p=>"x"===a?p.maxX:p.maxY)),h=Math.min(...w.map(p=>"x"===a?p.minY:p.minX)),u=Math.max(...w.map(p=>"x"===a?p.maxY:p.maxX));n.push({lassoIdx:l,min:x,max:d,perpMin:h,perpMax:u})}if(n.length<2)return i;n.sort((l,r)=>l.min-r.min);const c=[...i],e=new Set(i.map(l=>l.intercept)),v=Math.min(...o.map("x"===a?l=>l.minY:l=>l.minX)),g=Math.max(...o.map("x"===a?l=>l.maxY:l=>l.maxX));for(let l=0;l<n.length-1;l++){const r=n[l],w=n[l+1],x=r.max-w.min,u=Math.min(r.max-r.min,w.max-w.min),p=Math.min(r.perpMax,w.perpMax)-Math.max(r.perpMin,w.perpMin),M=Math.min(r.perpMax-r.perpMin,w.perpMax-w.perpMin);if(u>0&&x>.5*u&&!(M>0&&p>.3*M))continue;const z=(r.max+w.min)/2;[...e].some(H=>Math.abs(H-z)<10)||(c.push({slope:0,intercept:z,start:v-10,end:g+10}),e.add(z))}return c.sort((l,r)=>l.intercept-r.intercept)}(x,v,w,"x"),x=function B1(i,o,s,a,n){if(0===o.length)return i;let e=[...i];for(let v=0;v<10;v++){const g=e.map(M=>M.intercept).sort((M,m)=>M-m),l=[s.minX,...g,s.maxX],r=[];for(let M=0;M<l.length-1;M++)r.push(l[M+1]-l[M]);if(r.length<=1)break;const w=y(r);if(w<=n.maxSizeRatio)break;let x=null,d=w,h=0,u=-1;const p=r.indexOf(Math.max(...r)),k=(l[p]+l[p+1])/2;if(!T(k,"x",o,a)){const M=[...r],m=r[p]/2;M.splice(p,1,m,m);const z=y(M);z<d&&(d=z,x="split",h=k)}if(e.length>0){const M=r.indexOf(Math.min(...r));if(M>0){const m=[...r];m[M-1]+=m[M],m.splice(M,1);const z=y(m);z<d&&(d=z,x="merge",u=M-1)}if(M<r.length-1){const m=[...r];m[M]+=m[M+1],m.splice(M+1,1);const z=y(m);z<d&&(d=z,x="merge",u=M)}}if("split"===x)e.push({slope:0,intercept:h,start:s.minY-10,end:s.maxY+10}),e.sort((m,z)=>m.intercept-z.intercept);else{if(!("merge"===x&&u>=0&&u<e.length))break;{const M=[...e].sort((m,z)=>m.intercept-z.intercept);M.splice(u,1),e=M}}}return e}(x,v,g,w,o);let d=E(v,x),h=K(d,v,x,r,o,w);h=function f1(i,o,s,a,n,c){return n.length<2?i:i.map((e,v)=>{const g=o[v];if(g.length<2)return e;const l=g.map(h=>s[h]),r=c(v,a,o.length,l),w=[];for(let h=0;h<n.length;h++){const p=n[h].strokeIndices.filter(m=>g.includes(m));if(0===p.length)continue;const k=p.map(m=>s[m]),f=Math.min(...k.map(m=>m.minY)),M=Math.max(...k.map(m=>m.maxY));w.push({lassoIdx:h,minY:f,maxY:M})}if(w.length<2)return e;w.sort((h,u)=>h.minY-u.minY);const x=[...e],d=new Set(e.map(h=>h.intercept));for(let h=0;h<w.length-1;h++){const u=w[h],p=w[h+1],k=u.maxY-p.minY,m=Math.min(u.maxY-u.minY,p.maxY-p.minY);if(m>0&&k>.5*m)continue;const z=(u.maxY+p.minY)/2;[...d].some(H=>Math.abs(H-z)<10)||(x.push({slope:0,intercept:z,start:r.minX-10,end:r.maxX+10}),d.add(z))}return x.sort((h,u)=>h.intercept-u.intercept)})}(h,d,v,x,w,Y),h=Z(h,d,v,x,w,o);const u=function L1(i,o,s,a,n,c,e){let g=[...i],l=[...o];for(let r=0;r<10&&!(g.length+1<=Math.max(...l.map(f=>f.length+1),1)||0===g.length);r++){const d=[...g].sort((f,M)=>f.intercept-M.intercept),h=[n.minX,...d.map(f=>f.intercept),n.maxX];let u=0,p=1/0;for(let f=0;f<d.length;f++){const z=h[f+1]-h[f]+(h[f+2]-h[f+1]);z<p&&(p=z,u=f)}d.splice(u,1),g=d;const k=E(s,g);l=K(k,s,g,a,e,c),l=Z(l,k,s,g,c,e)}return{columnDividers:g,rowDividers:l}}(x,h,v,r,g,w,o);x=u.columnDividers,h=u.rowDividers,d=E(v,x);const p=function C1(i,o,s,a){const n=[],c=i.length;for(let e=0;e<c;e++){const v=i[e],g=a[e]||[];if(0===v.length)continue;const l=v.map(h=>o[h]),r=Math.min(...l.map(h=>h.minY)),w=Math.max(...l.map(h=>h.maxY)),x=g.map(h=>h.intercept).sort((h,u)=>h-u),d=x.length+1;for(let h=0;h<d;h++){const u=0===h?r-5:x[h-1],p=h===d-1?w+5:x[h],k=v.filter(m=>{const z=o[m];return z.centerY>=u&&z.centerY<=p});if(0===k.length)continue;const f=k.map(m=>o[m]),M={minX:Math.min(...f.map(m=>m.minX)),maxX:Math.max(...f.map(m=>m.maxX)),minY:Math.min(...f.map(m=>m.minY)),maxY:Math.max(...f.map(m=>m.maxY))};n.push({column:e,row:h,strokeIndices:k,bounds:M})}}return n}(d,v,0,h),k=function H1(i,o){return[...i].sort((a,n)=>a.column!==n.column?a.column-n.column:a.row-n.row).map((a,n)=>{const c=a.strokeIndices.map(r=>o[r]);let e=1/0,v=-1/0,g=1/0,l=-1/0;for(const r of c)for(const w of r)e=Math.min(e,w.x),v=Math.max(v,w.x),g=Math.min(g,w.y),l=Math.max(l,w.y);return e===1/0&&(e=v=g=l=0),{index:n,strokes:c,bounds:{minX:e,maxX:v,minY:g,maxY:l,width:v-e,height:l-g}}})}(p,s),f=function V1(i,o){const s=new Map;return[...o].sort((n,c)=>n.column!==c.column?n.column-c.column:n.row-c.row).forEach((n,c)=>{for(const e of n.strokeIndices)s.set(e,c)}),i.map((n,c)=>({index:c,points:n,characterIndex:s.get(c)??-1}))}(s,p);return{characters:k,strokes:f,lassos:U(s,e,o.lassoContainmentThreshold),columnDividers:x,rowDividers:h}}(o,this.config),a=1===o.maxCharacters?s1([],[],o.canvasWidth,o.canvasHeight):s1(s.columnDividers,s.rowDividers,o.canvasWidth,o.canvasHeight),n=function y1(i,o,s){const a=[];for(let n=0;n<i.length;n++){const c=i[n];if(c.length<3)continue;const e=o1[n%o1.length],v=c.map(g=>`${g.x},${g.y}`).join(" ");a.push(`  <polygon points="${v}" fill="hsla(${e},55%,78%,0.15)" stroke="hsla(${e},55%,78%,0.7)" stroke-width="2" stroke-dasharray="6,4" />`)}return`<svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${s}" viewBox="0 0 ${o} ${s}">\n${a.join("\n")}\n</svg>`}(o.lassos.map(c=>c.points),o.canvasWidth,o.canvasHeight);return{characters:s.characters,strokes:s.strokes,lassos:s.lassos,segmentationSvg:a,lassoSvg:n}}}var t=A(3664),L=A(2615),n1=A(4185);let b1=(()=>{var i;class o{constructor(a){this.cardsService=a,this.API_URL="https://inputtools.google.com/request?itc=ja-t-i0-handwrit&app=translate"}recognize(a,n,c){var e=this;return(0,_.A)(function*(){if(0===a.length)return[];const v=a.map(l=>{const r=[],w=[],x=[];for(const d of l)r.push(Math.round(d.x)),w.push(Math.round(d.y)),x.push(d.t);return[r,w,x]}),g={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:[{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:c,writing_area_width:n},ink:v}]};try{const r=yield(yield fetch(e.API_URL,{method:"POST",body:JSON.stringify(g),headers:{"Content-Type":"application/json"}})).json();return e.parseResponse(r)}catch(l){throw console.error("Recognition failed:",l),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}recognizeBatch(a){var n=this;return(0,_.A)(function*(){if(0===a.length)return[];const c=a.map(v=>{const g=v.strokes.map(l=>{const r=[],w=[],x=[];for(const d of l)r.push(Math.round(d.x)),w.push(Math.round(d.y)),x.push(d.t);return[r,w,x]});return{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:Math.round(v.bounds.height),writing_area_width:Math.round(v.bounds.width)},ink:g}}),e={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:c};try{const g=yield(yield fetch(n.API_URL,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}})).json();return n.parseBatchResponse(g,a.length)}catch(v){throw console.error("Batch recognition failed:",v),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}parseBatchResponse(a,n){if(!a||"SUCCESS"!==a[0])return Array(n).fill([]);const c=[],e=a[1]||[];for(let v=0;v<n;v++){const g=e[v]?.[1];if(!g||0===g.length){c.push([]);continue}const l=g.map(r=>r.replace(/\s+/g,"")).filter(r=>1===[...r].length).map((r,w)=>({character:r,score:Math.max(100-10*w,10)}));c.push(l)}return c}parseResponse(a){if(!a||"SUCCESS"!==a[0])return[];const n=a[1]?.[0]?.[1];return n&&0!==n.length?n.map((c,e)=>({character:c.replace(/\s+/g,""),score:Math.max(100-10*e,10)})):[]}getExpectedStrokeCount(a){return this.cardsService.getStrokeCount(a)}static#o=i=()=>(this.\u0275fac=function(n){return new(n||o)(L.KVO(n1.D))},this.\u0275prov=L.jDH({token:o,factory:o.\u0275fac,providedIn:"root"}))}return i(),o})(),_1=(()=>{var i;class o{constructor(){this.USER_ID_KEY="mojidoodle_collection_user_id",this.WORKER_URL="https://data-collection.mojidoodle.ai/collect"}getUserId(){let a=localStorage.getItem(this.USER_ID_KEY);return a||(a=this.generateUUID(),localStorage.setItem(this.USER_ID_KEY,a)),a}exportSample(a){var n=this;return(0,_.A)(function*(){const c=n.buildSample(a);try{yield n.sendToWorker(c)}catch(e){console.error("Failed to send to worker:",e)}})()}sendToWorker(a){var n=this;return(0,_.A)(function*(){const c=yield fetch(n.WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!c.ok)throw new Error(`Worker returned ${c.status}: ${c.statusText}`);const e=yield c.json();console.log("Sample sent to worker:",e)})()}buildSample(a){const{strokes:n,canvasWidth:c,canvasHeight:e,segmentResult:v,answers:g,recognitionResults:l,success:r,cardId:w}=a;let x=[];if(v){const u=new Map;for(const p of v.strokes)p.characterIndex>=0&&(u.has(p.characterIndex)||u.set(p.characterIndex,[]),u.get(p.characterIndex).push(p.index));x=v.characters.map(p=>({characterIndex:p.index,strokeIndices:u.get(p.index)||[],bounds:p.bounds}))}let d=null;v&&v.lassos.length>0&&(d=v.lassos.map(u=>({points:[...u.points],strokeIndices:[...u.strokeIndices]})));let h=null;return r&&(h=this.inferGroundTruth(n,x,g)),{version:2,strokes:n,canvasWidth:c,canvasHeight:e,characterAssignments:x,selectionLassos:d,answers:g,recognitionResults:l,groundTruth:h,success:r,id:this.generateUUID(),userId:this.getUserId(),cardId:w,timestamp:Date.now()}}inferGroundTruth(a,n,c){const v=[...c[0].replace(/\s+/g,"")];return n.length<=1?[{strokeIndices:a.map((g,l)=>l),character:v[0]||""}]:n.map((g,l)=>({strokeIndices:g.strokeIndices,character:v[l]||""}))}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const n=16*Math.random()|0;return("x"===a?n:3&n|8).toString(16)})}static#o=i=()=>(this.\u0275fac=function(n){return new(n||o)},this.\u0275prov=L.jDH({token:o,factory:o.\u0275fac,providedIn:"root"}))}return i(),o})();var i1,R1=A(345);const q1=["canvas"];function I1(i,o){1&i&&t.nrm(0,"canvas",13,0)}function T1(i,o){if(1&i){const s=t.RV6();t.j41(0,"div",14)(1,"ion-button",15),t.bIt("click",function(){L.eBV(s);const n=t.XpG();return L.Njj(n.onSkip())}),t.nrm(2,"ion-icon",16),t.k0s(),t.j41(3,"ion-button",15),t.bIt("click",function(){L.eBV(s);const n=t.XpG();return L.Njj(n.onUndo())}),t.nrm(4,"ion-icon",17),t.k0s(),t.j41(5,"ion-button",15),t.bIt("click",function(){L.eBV(s);const n=t.XpG();return L.Njj(n.onClearAll())}),t.nrm(6,"ion-icon",18),t.k0s(),t.j41(7,"ion-button",15),t.bIt("click",function(){L.eBV(s);const n=t.XpG();return L.Njj(n.setDrawMode("brush"))}),t.nrm(8,"ion-icon",19),t.k0s(),t.j41(9,"ion-button",15),t.bIt("click",function(){L.eBV(s);const n=t.XpG();return L.Njj(n.setDrawMode("lasso"))}),t.nrm(10,"ion-icon",20),t.k0s()()}if(2&i){const s=t.XpG();t.R7$(7),t.AVh("active","brush"===s.drawMode),t.R7$(2),t.AVh("active","lasso"===s.drawMode)}}function P1(i,o){1&i&&(t.j41(0,"div",21)(1,"div",22),t.EFF(2,"\u304a\u3081\u3067\u3068\u3046\u{1f973}"),t.k0s(),t.j41(3,"div",23),t.EFF(4,"You're all caught up. Come back again soon for more lessons!"),t.k0s()())}function F1(i,o){1&i&&t.nrm(0,"ion-spinner",27)}function D1(i,o){if(1&i&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&i){const s=t.XpG(2);t.R7$(),t.JRh(s.checkButtonText)}}function E1(i,o){if(1&i){const s=t.RV6();t.j41(0,"ion-button",24),t.bIt("click",function(){L.eBV(s);const n=t.XpG();return L.Njj(n.onCheck())}),t.DNE(1,F1,1,0,"ion-spinner",25)(2,D1,2,1,"span",26),t.k0s()}if(2&i){const s=t.XpG();t.Y8G("disabled",s.isChecking),t.R7$(),t.Y8G("ngIf",s.isChecking),t.R7$(),t.Y8G("ngIf",!s.isChecking)}}function Y1(i,o){1&i&&(t.j41(0,"span"),t.EFF(1,"\u25ef"),t.k0s())}function U1(i,o){1&i&&(t.j41(0,"span"),t.EFF(1,"\uff1f"),t.k0s())}function X1(i,o){1&i&&(t.j41(0,"span"),t.EFF(1,"\u2715"),t.k0s())}function $1(i,o){if(1&i&&(t.j41(0,"div",40)(1,"span",41),t.EFF(2),t.k0s()()),2&i){const s=o.$implicit;t.R7$(2),t.JRh(s.character)}}function N1(i,o){if(1&i&&(t.j41(0,"div",36)(1,"div",37),t.EFF(2,"Recognized:"),t.k0s(),t.j41(3,"div",38),t.DNE(4,$1,3,1,"div",39),t.k0s()()),2&i){const s=t.XpG(2);t.R7$(4),t.Y8G("ngForOf",s.displayMatches)}}function W1(i,o){if(1&i&&(t.j41(0,"div",42)(1,"div",43),t.EFF(2,"Answer:"),t.k0s(),t.j41(3,"div",44),t.EFF(4),t.k0s()()),2&i){const s=t.XpG(2);t.R7$(4),t.JRh(s.correctAnswer)}}function G1(i,o){if(1&i){const s=t.RV6();t.j41(0,"div",28),t.bIt("click",function(){L.eBV(s);const n=t.XpG();return L.Njj(n.dismissResults())}),t.j41(1,"div",29),t.bIt("click",function(n){return L.eBV(s),L.Njj(n.stopPropagation())}),t.j41(2,"div",30),t.DNE(3,Y1,2,0,"span",26)(4,U1,2,0,"span",26)(5,X1,2,0,"span",26),t.k0s(),t.j41(6,"div",31),t.EFF(7),t.k0s(),t.j41(8,"div",32),t.EFF(9),t.k0s(),t.DNE(10,N1,5,1,"div",33)(11,W1,5,1,"div",34),t.j41(12,"ion-button",35),t.bIt("click",function(){L.eBV(s);const n=t.XpG();return L.Njj(n.dismissResults())}),t.EFF(13),t.k0s()()()}if(2&i){const s=t.XpG();t.R7$(),t.HbH(s.resultStatus),t.R7$(2),t.Y8G("ngIf","correct"===s.resultStatus),t.R7$(),t.Y8G("ngIf","befuddled"===s.resultStatus),t.R7$(),t.Y8G("ngIf","wrong"===s.resultStatus),t.R7$(2),t.JRh(s.resultFeedback),t.R7$(2),t.JRh(s.strokeCountInfo),t.R7$(),t.Y8G("ngIf",s.displayMatches.length>0),t.R7$(),t.Y8G("ngIf","wrong"===s.resultStatus&&s.correctAnswer),t.R7$(2),t.JRh(s.dismissButtonText)}}class S{getLassoColorFromIndex(o,s=1){return`hsla(${this.LASSO_HUES[o%this.LASSO_HUES.length]}, 55%, 78%, ${s})`}kanaMatch(o,s){if(o===s||S.CHOON_EQUIVALENTS.has(o)&&S.CHOON_EQUIVALENTS.has(s)||S.WAVE_DASH_EQUIVALENTS.has(o)&&S.WAVE_DASH_EQUIVALENTS.has(s))return!0;const a=S.SMALL_TO_BIG_KANA[o];if(a&&a===s)return!0;const n=S.SMALL_TO_BIG_KANA[s];return!!(n&&n===o||a&&n&&a===n)}constructor(o,s,a,n){var i;this.strokeRecognition=o,this.cardsService=s,this.collectionService=a,this.sanitizer=n,this.isDrawing=!1,this.strokes=[],this.currentStroke=[],this.drawStartTime=0,this.currentCharacter="",this.promptText="",this.promptColor="#FFFFFF",this.noCardsAvailable=!1,this.isChecking=!1,this.showResults=!1,this.resultStatus="",this.resultFeedback="",this.strokeCountInfo="",this.topMatches=[],this.displayMatches=[],this.correctAnswer="",this.cardAvailabilitySubscription=null,this.segmentationTimer=null,this.segmentResult=null,this.SEGMENTATION_DELAY_MS=500,this.segmenter=new a1,this.lassoSvgContent="",this.segmentationSvgContent="",this.lastBatchResults=[],this.drawMode="brush",this.lassos=[],this.currentLasso=[],this.lassoStartPos=null,this.LASSO_HUES=[0,165,330,135,300,105,270,75,240,45,210,15,180,345,150,315,120,285,90,255,60,225,30,195],this.correctFeedback=["\u6b63\u89e3!","\u307e\u308b!","\u306f\u306a\u307e\u308b!","\u3088\u304f\u3084\u3063\u305f!","\u3059\u3054\u3044!","\u304b\u3093\u307a\u304d!","\u3070\u3063\u3061\u308a!","\u305d\u306e\u8abf\u5b50!"],this.wrongFeedback=["\u3061\u304c\u3046!","\u3056\u3093\u306d\u3093!","\u306f\u305a\u308c!","\u3075\u305b\u3044\u304b\u3044!","\u30d0\u30c4!"],this.checkButtonLabels=["\u3088\u3057!","\u5224\u5b9a!","\u3067\u304d\u305f!","\u3044\u3056!","\u78ba\u8a8d"],this.dismissButtonLabels=["\u6b21!","\u3064\u304e!","\u3088\u3057!","\u30aa\u30c3\u30b1\u30fc!","\u306f\u3044!","\u4e86\u89e3!","\u3044\u304f\u305e!"],this.checkButtonText="",this.dismissButtonText="",this.minBrushSize=3,this.maxBrushSize=24,this.brushSmoothing=.05,this.lastBrushSize=0,i={backspace:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M403.13 96H156.87a44.9 44.9 0 00-33.68 15.27 15.88 15.88 0 00-1.91 2.7L32 247.75a16 16 0 000 16.5l89.15 133.57a16.24 16.24 0 002 2.88 44.89 44.89 0 0033.7 15.3h246.28A44.92 44.92 0 00448 371.13V140.87A44.92 44.92 0 00403.13 96zM348 311a16 16 0 11-22.63 22.62L271.67 280 218 333.65A16 16 0 01195.35 311L249 257.33l-53.69-53.69A16 16 0 01218 181l53.69 53.7 53.67-53.7A16 16 0 01348 203.64l-53.7 53.69z'/></svg>",trashOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/><path stroke-linecap='round' stroke-miterlimit='10' d='M80 112h352' class='ionicon-stroke-width'/><path d='M192 112V72h0a23.93 23.93 0 0124-24h80a23.93 23.93 0 0124 24h0v40M256 176v224M184 176l8 224M328 176l-8 224' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",brushOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M452.37 59.63h0a40.49 40.49 0 00-57.26 0L184 294.74c23.08 4.7 46.12 27.29 49.26 49.26l219.11-227.11a40.49 40.49 0 000-57.26zM138 336c-29.88 0-54 24.5-54 54.86 0 23.95-20.88 36.57-36 36.57C64.56 449.74 92.82 464 120 464c39.78 0 72-32.73 72-73.14 0-30.36-24.12-54.86-54-54.86z' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",ellipseOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><circle cx='256' cy='256' r='192' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",playSkipForwardOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M112 111v290c0 17.44 17 28.52 31 20.16l247.9-148.37c12.12-7.25 12.12-26.33 0-33.58L143 90.84c-14-8.36-31 2.72-31 20.16z' stroke-miterlimit='10' class='ionicon-fill-none ionicon-stroke-width'/><path stroke-linecap='round' stroke-miterlimit='10' d='M400 80v352' class='ionicon-fill-none ionicon-stroke-width'/></svg>"},Object.keys(i).forEach(function(o){W(o,i[o]);var s=o.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();o!==s&&W(s,i[o])})}ngOnInit(){var o=this;return(0,_.A)(function*(){o.checkButtonText=o.randomFrom(o.checkButtonLabels),yield o.cardsService.initialize(),o.loadRandomCard(),o.cardAvailabilitySubscription=o.cardsService.cardAvailability$.subscribe(s=>{o.noCardsAvailable&&s>0&&o.loadRandomCard()})})()}loadRandomCard(){this.currentCard=this.cardsService.getRandomUnlockedCard(),this.currentCard?(this.currentCharacter=this.currentCard.answers[0],this.promptText=this.currentCard.prompt,this.promptColor=this.cardsService.getStageColor(this.currentCard.stage),this.noCardsAvailable=!1):(this.noCardsAvailable=!0,this.promptText="",this.promptColor="#FFFFFF")}ngAfterViewInit(){setTimeout(()=>this.setupCanvas(),100)}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.cardAvailabilitySubscription&&this.cardAvailabilitySubscription.unsubscribe(),this.cancelSegmentation()}setupCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(s),this.ctx=o.getContext("2d"),this.setCanvasStyle(),o.addEventListener("mousedown",this.handleMouseDown.bind(this)),o.addEventListener("mousemove",this.handleMouseMove.bind(this)),o.addEventListener("mouseup",this.handleMouseUp.bind(this)),o.addEventListener("mouseleave",this.handleMouseUp.bind(this)),o.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),o.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),o.addEventListener("touchend",this.handleTouchEnd.bind(this)))}resizeCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(o.width=s.clientWidth,o.height=s.clientHeight,this.ctx&&this.setCanvasStyle())}setCanvasStyle(){this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff",this.ctx.lineCap="round",this.ctx.lineJoin="round"}handleMouseDown(o){this.cancelSegmentation(),this.isDrawing=!0;const s=this.getMousePos(o);"lasso"===this.drawMode?(this.lassoStartPos={x:s.x,y:s.y},this.currentLasso=[{x:s.x,y:s.y}]):(this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize))}handleMouseMove(o){if(!this.isDrawing)return;const s=this.getMousePos(o);if("lasso"===this.drawMode)this.currentLasso.push({x:s.x,y:s.y}),this.fullRedraw();else{const a=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(a,s)}}handleMouseUp(){this.isDrawing&&("lasso"===this.drawMode?(this.lassoStartPos&&this.currentLasso.length>0&&(this.currentLasso.length>=5?this.completeLasso():(this.handleLassoTap(this.lassoStartPos.x,this.lassoStartPos.y),this.currentLasso=[])),this.lassoStartPos=null):this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1)}handleTouchStart(o){o.preventDefault(),this.cancelSegmentation(),this.isDrawing=!0;const s=this.getTouchPos(o);"lasso"===this.drawMode?(this.lassoStartPos={x:s.x,y:s.y},this.currentLasso=[{x:s.x,y:s.y}]):(this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize))}handleTouchMove(o){if(!this.isDrawing)return;o.preventDefault();const s=this.getTouchPos(o);if("lasso"===this.drawMode)this.currentLasso.push({x:s.x,y:s.y}),this.fullRedraw();else{const a=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(a,s)}}handleTouchEnd(){this.isDrawing&&("lasso"===this.drawMode?(this.lassoStartPos&&this.currentLasso.length>0&&(this.currentLasso.length>=5?this.completeLasso():(this.handleLassoTap(this.lassoStartPos.x,this.lassoStartPos.y),this.currentLasso=[])),this.lassoStartPos=null):this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1)}getMousePos(o){const s=this.canvasRef.nativeElement,a=s.getBoundingClientRect(),n=s.width/a.width,c=s.height/a.height,e=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=e),{x:(o.clientX-a.left)*n,y:(o.clientY-a.top)*c,t:e-this.drawStartTime}}getTouchPos(o){const s=this.canvasRef.nativeElement,a=s.getBoundingClientRect(),n=s.width/a.width,c=s.height/a.height,e=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=e),{x:(o.touches[0].clientX-a.left)*n,y:(o.touches[0].clientY-a.top)*c,t:e-this.drawStartTime}}calculateBrushSize(o,s){const a=s.x-o.x,n=s.y-o.y,c=Math.max(s.t-o.t,1),v=Math.sqrt(a*a+n*n)/c,g=Math.min(v/1.5,1),r=this.lastBrushSize+(this.maxBrushSize-g*(this.maxBrushSize-this.minBrushSize)-this.lastBrushSize)*this.brushSmoothing;return this.lastBrushSize=r,r}drawBrushPoint(o,s,a){this.ctx.beginPath(),this.ctx.arc(o,s,a/2,0,2*Math.PI),this.ctx.fill()}drawBrushSegment(o,s){const a=this.calculateBrushSize(o,s);this.ctx.lineWidth=a,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.drawBrushPoint(s.x,s.y,a)}drawHarai(o){if(o.length<3)return;const s=Math.min(5,o.length),a=o.slice(-s),n=a[a.length-1],c=a[0],e=n.x-c.x,v=n.y-c.y,g=Math.sqrt(e*e+v*v);if(g<5)return;const l=e/g,r=v/g,w=Math.max(n.t-c.t,1),d=Math.min(g/w*20,40);if(d<8)return;const u=this.lastBrushSize;for(let p=0;p<8;p++){const f=(p+1)/8,M=1-Math.pow(1-p/8,2),m=1-Math.pow(1-f,2),z=n.x+l*d*M,j=n.y+r*d*M,H=n.x+l*d*m,O=n.y+r*d*m,b=u*(1-f);b>.5&&(this.ctx.lineWidth=b,this.ctx.beginPath(),this.ctx.moveTo(z,j),this.ctx.lineTo(H,O),this.ctx.stroke())}}onCheck(){var o=this;return(0,_.A)(function*(){if(0!==o.strokes.length&&o.currentCard){o.isChecking=!0;try{const s=o.canvasRef.nativeElement,a=Math.max(...o.currentCard.answers.map(l=>[...l.replace(/\s+/g,"")].length));let n;if(a>1){const l=o.segmenter.segment({strokes:o.strokes,lassos:o.lassos,canvasWidth:s.width,canvasHeight:s.height,maxCharacters:a});if(o.segmentResult=l,l.characters.length<=1)o.lastBatchResults=[],n=yield o.strokeRecognition.recognize(o.strokes,s.width,s.height);else{const r=l.characters.map(d=>({strokes:d.strokes,bounds:{width:d.bounds.width,height:d.bounds.height}})),w=yield o.strokeRecognition.recognizeBatch(r);o.lastBatchResults=w,n=[{character:w.map(d=>d[0]?.character||"?").join(""),score:100}],console.log("Cell interpretations (Japanese reading order):",w.map((d,h)=>({cell:h,top5:d.slice(0,5).map(u=>u.character)})))}}else o.segmentResult=null,o.lastBatchResults=[],n=yield o.strokeRecognition.recognize(o.strokes,s.width,s.height);o.topMatches=n.slice(0,5);const c=o.currentCard.answers.map(l=>l.replace(/\s+/g,""));let e=!1,v="";if(o.lastBatchResults.length>0){for(const l of c){const r=[...l];if(r.length===o.lastBatchResults.length&&r.every((x,d)=>{const h=o.lastBatchResults[d].slice(0,5).map(p=>p.character),u=h.some(p=>o.kanaMatch(x,p));return console.log(`  Cell ${d}: target='${x}' (code=${x.charCodeAt(0)}), candidates=[${h.map(p=>`'${p}'(${p.charCodeAt(0)})`).join(", ")}], matched=${u}`),u})){e=!0,v=l;break}}console.log("Grading multi-char:",{targets:c,cellResults:o.lastBatchResults.map(l=>l.slice(0,5).map(r=>r.character)),isCorrect:e,matchedAnswer:v})}else{const l=o.topMatches.map(r=>r.character);for(const r of c)if(l.some(w=>o.kanaMatch(r,w))){e=!0,v=r;break}}if(e)o.resultStatus="correct",o.resultFeedback=o.randomFrom(o.correctFeedback),o.displayMatches=[{character:v,score:1}],o.correctAnswer="",o.cardsService.advanceCard(o.currentCard.id);else{let l;if(o.lastBatchResults.length>0)console.log("Checking befuddlers:",o.currentCard.befuddlers.map(r=>({answers:r.answers,toast:r.toast.slice(0,30)}))),l=o.currentCard.befuddlers.find(r=>(console.log("  Befuddler answers:",r.answers),r.answers.some(w=>{const x=[...w.replace(/\s+/g,"")];if(console.log(`    Checking "${w}": ${x.length} chars vs ${o.lastBatchResults.length} cells`),x.length!==o.lastBatchResults.length)return!1;const d=x.every((h,u)=>{const p=o.lastBatchResults[u].slice(0,5).map(f=>f.character),k=p.some(f=>o.kanaMatch(h,f));return console.log(`      Cell ${u}: '${h}' vs [${p.join(",")}] = ${k}`),k});return console.log(`    Result: ${d}`),d})));else{const r=o.topMatches.map(w=>w.character);l=o.currentCard.befuddlers.find(w=>w.answers.some(x=>r.some(d=>o.kanaMatch(x.replace(/\s+/g,""),d))))}l?(o.resultStatus="befuddled",o.resultFeedback=l.toast,o.displayMatches=o.topMatches,o.correctAnswer=""):(o.resultStatus="wrong",o.resultFeedback=o.randomFrom(o.wrongFeedback),o.displayMatches=o.topMatches,o.correctAnswer=o.currentCard.answers[0],o.cardsService.demoteCard(o.currentCard.id))}const g=o.strokeRecognition.getExpectedStrokeCount(o.currentCharacter);o.strokeCountInfo=`Strokes: ${o.strokes.length}/${g}`,o.exportCollectionSample(e)}catch(s){console.error("Recognition error:",s),o.resultStatus="wrong",o.resultFeedback=s.message||"Recognition failed. Please try on a device.",o.topMatches=[],o.displayMatches=[],o.strokeCountInfo=""}o.isChecking=!1,o.checkButtonText=o.randomFrom(o.checkButtonLabels),o.dismissButtonText=o.randomFrom(o.dismissButtonLabels),o.showResults=!0}})()}dismissResults(){this.showResults=!1,this.clearCanvas(),("correct"===this.resultStatus||"wrong"===this.resultStatus)&&this.loadRandomCard()}onSkip(){this.clearCanvas(),this.loadRandomCard()}onUndo(){this.strokes.length>0&&(this.strokes.pop(),this.fullRedraw(),this.scheduleSegmentation())}clearCanvas(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.strokes=[],this.lassos=[],this.currentLasso=[],this.drawStartTime=0,this.drawMode="brush",this.cancelSegmentation(),this.segmentResult=null,this.lassoSvgContent="",this.segmentationSvgContent=""}randomFrom(o){return o[Math.floor(Math.random()*o.length)]}setDrawMode(o){this.drawMode=o}onClearAll(){this.clearCanvas(),this.lassos=[]}isPointInPolygon(o,s){if(s.length<3)return!1;let a=!1;for(let n=0,c=s.length-1;n<s.length;c=n++){const e=s[n].x,v=s[n].y,l=s[c].y;v>o.y!=l>o.y&&o.x<(s[c].x-e)*(o.y-v)/(l-v)+e&&(a=!a)}return a}getStrokeColorFromResult(o){if(!this.segmentResult)return"#fff";for(let s=0;s<this.segmentResult.lassos.length;s++)if(this.segmentResult.lassos[s].strokeIndices.includes(o))return this.getLassoColorFromIndex(s);return"#fff"}handleLassoTap(o,s){for(let a=this.lassos.length-1;a>=0;a--)if(this.isPointInPolygon({x:o,y:s},this.lassos[a].points))return this.lassos.splice(a,1),this.analyzeAndVisualize(),!0;return!1}completeLasso(){this.currentLasso.length<3?this.currentLasso=[]:(this.lassos.push({points:[...this.currentLasso]}),this.currentLasso=[],this.analyzeAndVisualize())}drawCurrentLasso(){if(!(this.currentLasso.length<2)){this.ctx.save(),this.ctx.strokeStyle=this.getLassoColorFromIndex(this.lassos.length,.5),this.ctx.lineWidth=2,this.ctx.setLineDash([6,4]),this.ctx.beginPath(),this.ctx.moveTo(this.currentLasso[0].x,this.currentLasso[0].y);for(let o=1;o<this.currentLasso.length;o++)this.ctx.lineTo(this.currentLasso[o].x,this.currentLasso[o].y);this.ctx.stroke(),this.ctx.restore()}}drawStrokeWithColor(o,s){if(0!==o.length){this.ctx.save(),this.ctx.fillStyle=s,this.ctx.strokeStyle=s,this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.ctx.beginPath(),this.ctx.arc(o[0].x,o[0].y,1.5*this.minBrushSize/2,0,2*Math.PI),this.ctx.fill();for(let a=1;a<o.length;a++){const n=this.calculateBrushSize(o[a-1],o[a]);this.ctx.lineWidth=n,this.ctx.beginPath(),this.ctx.moveTo(o[a-1].x,o[a-1].y),this.ctx.lineTo(o[a].x,o[a].y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(o[a].x,o[a].y,n/2,0,2*Math.PI),this.ctx.fill()}if(o.length>=3){const a=Math.min(5,o.length),n=o.slice(-a),c=n[n.length-1],e=n[0],v=c.x-e.x,g=c.y-e.y,l=Math.sqrt(v*v+g*g);if(l>=5){const r=v/l,w=g/l,x=Math.max(c.t-e.t,1),h=Math.min(l/x*20,40);if(h>=8){const p=this.lastBrushSize;for(let k=0;k<8;k++){const M=(k+1)/8,m=1-Math.pow(1-k/8,2),z=1-Math.pow(1-M,2),j=c.x+r*h*m,H=c.y+w*h*m,O=c.x+r*h*z,b=c.y+w*h*z,X=p*(1-M);X>.5&&(this.ctx.lineWidth=X,this.ctx.beginPath(),this.ctx.moveTo(j,H),this.ctx.lineTo(O,b),this.ctx.stroke())}}}}this.ctx.restore()}}fullRedraw(){const o=this.canvasRef.nativeElement;if(this.ctx.clearRect(0,0,o.width,o.height),this.lassoSvgContent=this.sanitizer.bypassSecurityTrustHtml(this.segmentResult?.lassoSvg??""),this.segmentationSvgContent=this.sanitizer.bypassSecurityTrustHtml(this.segmentResult?.segmentationSvg??""),this.currentLasso.length>1&&this.drawCurrentLasso(),this.segmentResult)for(const s of this.segmentResult.strokes){const a=this.getStrokeColorFromResult(s.index);this.drawStrokeWithColor(this.strokes[s.index],a)}else for(const s of this.strokes)this.drawStrokeWithColor(s,"#fff")}scheduleSegmentation(){if(this.cancelSegmentation(),0===this.strokes.length)return this.segmentResult=null,this.lassoSvgContent="",void(this.segmentationSvgContent="");this.segmentationTimer=setTimeout(()=>{this.analyzeAndVisualize()},this.SEGMENTATION_DELAY_MS)}cancelSegmentation(){null!==this.segmentationTimer&&(clearTimeout(this.segmentationTimer),this.segmentationTimer=null)}analyzeAndVisualize(){if(0===this.strokes.length||!this.currentCard)return this.segmentResult=null,void this.fullRedraw();const o=Math.max(...this.currentCard.answers.map(a=>[...a.replace(/\s+/g,"")].length));if(o<=1)return this.segmentResult=null,void this.fullRedraw();const s=this.canvasRef.nativeElement;this.segmentResult=this.segmenter.segment({strokes:this.strokes,lassos:this.lassos,canvasWidth:s.width,canvasHeight:s.height,maxCharacters:o}),this.fullRedraw()}exportCollectionSample(o){if(!this.currentCard||"opted-in"!==this.cardsService.getDataCollectionStatus())return;const s=this.canvasRef.nativeElement;let a=null;this.lastBatchResults.length>0?a=this.lastBatchResults:this.topMatches.length>0&&(a=[this.topMatches]),this.collectionService.exportSample({strokes:this.strokes,canvasWidth:s.width,canvasHeight:s.height,segmentResult:this.segmentResult,answers:this.currentCard.answers,recognitionResults:a,success:o,cardId:this.currentCard.id})}static#o=i1=()=>(this.SMALL_TO_BIG_KANA={\u3063:"\u3064",\u3083:"\u3084",\u3085:"\u3086",\u3087:"\u3088",\u3041:"\u3042",\u3043:"\u3044",\u3045:"\u3046",\u3047:"\u3048",\u3049:"\u304a",\u308e:"\u308f",\u30c3:"\u30c4",\u30e3:"\u30e4",\u30e5:"\u30e6",\u30e7:"\u30e8",\u30a1:"\u30a2",\u30a3:"\u30a4",\u30a5:"\u30a6",\u30a7:"\u30a8",\u30a9:"\u30aa",\u30ee:"\u30ef"},this.CHOON_EQUIVALENTS=new Set(["\u30fc","|","\uff5c"]),this.WAVE_DASH_EQUIVALENTS=new Set(["\u301c","~","\uff5e"]),this.\u0275fac=function(s){return new(s||S)(t.rXU(b1),t.rXU(n1.D),t.rXU(_1),t.rXU(R1.up))},this.\u0275cmp=t.VBU({type:S,selectors:[["app-workbook"]],viewQuery:function(s,a){if(1&s&&t.GBs(q1,5),2&s){let n;t.mGM(n=t.lsd())&&(a.canvasRef=n.first)}},decls:13,vars:12,consts:[["canvas",""],[1,"workbook-content",3,"fullscreen","scrollY"],[1,"prompt-bar"],["color","light"],[1,"prompt-text"],[1,"canvas-wrapper"],["class","drawing-canvas",4,"ngIf"],[1,"lasso-overlay",3,"innerHTML"],[1,"segmentation-overlay",3,"innerHTML"],["class","tool-column",4,"ngIf"],["class","caught-up-box",4,"ngIf"],["class","check-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","results-overlay",3,"click",4,"ngIf"],[1,"drawing-canvas"],[1,"tool-column"],["fill","clear",1,"tool-btn",3,"click"],["name","play-skip-forward-outline"],["name","backspace"],["name","trash-outline"],["name","brush-outline"],["name","ellipse-outline"],[1,"caught-up-box"],[1,"caught-up-title"],[1,"caught-up-message"],["color","primary",1,"check-btn",3,"click","disabled"],["name","crescent",4,"ngIf"],[4,"ngIf"],["name","crescent"],[1,"results-overlay",3,"click"],[1,"results-card",3,"click"],[1,"status-display"],[1,"feedback"],[1,"stroke-info"],["class","matches-section",4,"ngIf"],["class","correct-answer-section",4,"ngIf"],["expand","block",3,"click"],[1,"matches-section"],[1,"matches-title"],[1,"matches-list"],["class","match-item",4,"ngFor","ngForOf"],[1,"match-item"],[1,"match-char"],[1,"correct-answer-section"],[1,"correct-answer-title"],[1,"correct-answer"]],template:function(s,a){1&s&&(t.j41(0,"ion-content",1)(1,"div",2),t.nrm(2,"ion-menu-button",3),t.j41(3,"span",4),t.EFF(4),t.k0s()(),t.j41(5,"div",5),t.DNE(6,I1,2,0,"canvas",6),t.nrm(7,"div",7)(8,"div",8),t.DNE(9,T1,11,4,"div",9)(10,P1,5,0,"div",10),t.k0s(),t.DNE(11,E1,3,3,"ion-button",11)(12,G1,14,10,"div",12),t.k0s()),2&s&&(t.Y8G("fullscreen",!0)("scrollY",!1),t.R7$(3),t.xc7("color",a.promptColor),t.R7$(),t.JRh(a.promptText),t.R7$(2),t.Y8G("ngIf",!a.noCardsAvailable),t.R7$(),t.Y8G("innerHTML",a.lassoSvgContent,t.npT),t.R7$(),t.Y8G("innerHTML",a.segmentationSvgContent,t.npT),t.R7$(),t.Y8G("ngIf",!a.noCardsAvailable),t.R7$(),t.Y8G("ngIf",a.noCardsAvailable),t.R7$(),t.Y8G("ngIf",!a.noCardsAvailable),t.R7$(),t.Y8G("ngIf",a.showResults))},dependencies:[R.W9,R.MC,R.Jm,R.iq,R.w2,q.MD,q.Sq,q.bT],styles:[".workbook-content[_ngcontent-%COMP%]{--background: #000}.prompt-bar[_ngcontent-%COMP%]{display:flex;align-items:center;height:144px;background:#111;padding:0 8px}.prompt-text[_ngcontent-%COMP%]{flex:1;text-align:center;font-size:24px;color:#fff;margin-right:40px;white-space:pre-line}.canvas-wrapper[_ngcontent-%COMP%]{position:absolute;inset:144px 0 0;background:#000}.drawing-canvas[_ngcontent-%COMP%]{width:100%;height:100%;touch-action:none;display:block}.lasso-overlay[_ngcontent-%COMP%], .segmentation-overlay[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.tool-column[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:8px}.tool-btn[_ngcontent-%COMP%]{--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:20px}.tool-btn.active[_ngcontent-%COMP%]{--color: #fff;background:#ffffff1a;border-radius:8px}.results-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000e6;display:flex;align-items:center;justify-content:center;z-index:100}.results-card[_ngcontent-%COMP%]{background:#1a1a1a;border-radius:16px;padding:24px;min-width:280px;max-width:90%;text-align:center}.results-card.correct[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.correct[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#e63946}.results-card.befuddled[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.befuddled[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#f7b731}.results-card.wrong[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.wrong[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#4a90d9}.status-display[_ngcontent-%COMP%]{font-size:64px;font-weight:700;margin-bottom:8px}.feedback[_ngcontent-%COMP%]{font-family:Shippori Mincho B1,serif;font-size:18px;margin-bottom:16px;white-space:pre-line}.stroke-info[_ngcontent-%COMP%]{font-size:14px;color:#888;margin-bottom:20px}.matches-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.matches-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.matches-list[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:16px}.match-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.match-char[_ngcontent-%COMP%]{font-size:32px;color:#fff}.correct-answer-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.correct-answer-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.correct-answer[_ngcontent-%COMP%]{font-size:36px;color:#4a90d9}.check-btn[_ngcontent-%COMP%]{position:absolute;bottom:32px;left:50%;transform:translate(-50%);--background: #222;--background-hover: #333;--color: #fff;--border-radius: 32px;--padding-start: 12vw;--padding-end: 12vw;--padding-top: 16px;--padding-bottom: 16px;min-height:60px;font-family:Shippori Mincho B1,serif;font-size:clamp(20px,5vw,28px);font-weight:600;letter-spacing:2px}.results-card[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{font-family:Shippori Mincho B1,serif;font-weight:700}.caught-up-box[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border-radius:16px;padding:32px;text-align:center;max-width:90%;width:320px}.caught-up-title[_ngcontent-%COMP%]{font-size:36px;margin-bottom:16px}.caught-up-message[_ngcontent-%COMP%]{font-size:16px;color:#ccc;line-height:1.5}"]}))}i1();const J1=[{path:"",component:S}];let Q1=(()=>{var i;class o{static#o=i=()=>(this.\u0275fac=function(n){return new(n||o)},this.\u0275mod=t.$C({type:o}),this.\u0275inj=L.G2t({imports:[$.iI.forChild(J1),$.iI]}))}return i(),o})(),K1=(()=>{var i;class o{static#o=i=()=>(this.\u0275fac=function(n){return new(n||o)},this.\u0275mod=t.$C({type:o}),this.\u0275inj=L.G2t({imports:[q.MD,l1.YN,c1.bv,Q1,S]}))}return i(),o})()}}]);