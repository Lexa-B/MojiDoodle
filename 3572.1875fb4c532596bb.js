"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3572],{3572(z1,$,S){S.d($,{WorkbookPageModule:()=>M1});var F,q=S(2200),J=S(4341),Q=S(7343),I=S(8132),_=S(467),O=S(6299),X=function(n,e){var m=function(){if(typeof window>"u")return new Map;if(!F){var n=window;n.Ionicons=n.Ionicons||{},F=n.Ionicons.map=n.Ionicons.map||new Map}return F}(),o=m.get(n);void 0===o?m.set(n,e):o!==e&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(n,'". Ensure that multiple icons are not mapped to the same icon name.'))},a=S(3664),V=S(2615),U=S(4185);let a1=(()=>{var n;class e{constructor(o){this.cardsService=o,this.API_URL="https://inputtools.google.com/request?itc=ja-t-i0-handwrit&app=translate"}recognize(o,s,i){var t=this;return(0,_.A)(function*(){if(0===o.length)return[];const r=o.map(c=>{const g=[],l=[],h=[];for(const w of c)g.push(Math.round(w.x)),l.push(Math.round(w.y)),h.push(w.t);return[g,l,h]}),v={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:[{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:i,writing_area_width:s},ink:r}]};try{const g=yield(yield fetch(t.API_URL,{method:"POST",body:JSON.stringify(v),headers:{"Content-Type":"application/json"}})).json();return t.parseResponse(g)}catch(c){throw console.error("Recognition failed:",c),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}recognizeBatch(o){var s=this;return(0,_.A)(function*(){if(0===o.length)return[];const i=o.map(r=>{const v=r.strokes.map(c=>{const g=[],l=[],h=[];for(const w of c)g.push(Math.round(w.x)),l.push(Math.round(w.y)),h.push(w.t);return[g,l,h]});return{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:Math.round(r.bounds.height),writing_area_width:Math.round(r.bounds.width)},ink:v}}),t={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:i};try{const v=yield(yield fetch(s.API_URL,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json();return s.parseBatchResponse(v,o.length)}catch(r){throw console.error("Batch recognition failed:",r),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}parseBatchResponse(o,s){if(!o||"SUCCESS"!==o[0])return Array(s).fill([]);const i=[],t=o[1]||[];for(let r=0;r<s;r++){const v=t[r]?.[1];if(!v||0===v.length){i.push([]);continue}const c=/^[\p{P}\p{S}\p{M}]$/u,g=v.map(l=>l.replace(/\s+/g,"")).filter(l=>{const h=[...l];return!(1!==h.length||c.test(h[0]))}).map((l,h)=>({character:l,score:Math.max(100-10*h,10)}));i.push(g)}return i}parseResponse(o){if(!o||"SUCCESS"!==o[0])return[];const s=o[1]?.[0]?.[1];return s&&0!==s.length?s.map((i,t)=>({character:i.replace(/\s+/g,""),score:Math.max(100-10*t,10)})):[]}getExpectedStrokeCount(o){return this.cardsService.getStrokeCount(o)}static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)(V.KVO(U.D))},this.\u0275prov=V.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return n(),e})(),i1=(()=>{var n;class e{constructor(){this.config={minColumnGapRatio:.25,maxColumnAngle:10,minRowGapRatio:.25,maxRowAngle:10,charSizeMultiplier:2,minCharSizeRatio:.08,maxCharSizeRatio:.4},this.MAX_SIZE_RATIO=2}segment(o,s,i){if(0===o.length)return this.emptyResult();const t=o.map((k,x)=>this.calculateStrokeBounds(k,x)),r={minX:Math.min(...t.map(k=>k.minX)),maxX:Math.max(...t.map(k=>k.maxX)),minY:Math.min(...t.map(k=>k.minY)),maxY:Math.max(...t.map(k=>k.maxY))},v=this.estimateCharSize(t,s,"width"),c=this.estimateCharSize(t,i,"height");let g=this.findColumnDividers(t,v,i);g=this.enforceColumnUniformity(g,t,r);const l=this.assignStrokesToColumns(t,g);let h=this.findAllRowDividers(l,t,g,c);h=this.enforceRowUniformity(h,l,t,g);const w=this.enforceColumnsNotExceedRows(g,h,t,c,r);g=w.columnDividers,h=w.rowDividers;const M=this.assignStrokesToColumns(t,g),d=this.createCellGrid(M,t,g,h),u=g.length+1,p=Math.max(...h.map(k=>k.length+1),1);return{grid:{columnDividers:g,rowDividers:h,cells:d,columns:u,maxRows:p},estimatedCharHeight:c,estimatedCharWidth:v}}emptyResult(){return{grid:{columnDividers:[],rowDividers:[],cells:[],columns:0,maxRows:0},estimatedCharHeight:0,estimatedCharWidth:0}}calculateStrokeBounds(o,s){if(0===o.length)return{strokeIndex:s,minX:0,maxX:0,minY:0,maxY:0,centerX:0,centerY:0};let i=1/0,t=-1/0,r=1/0,v=-1/0;for(const c of o)i=Math.min(i,c.x),t=Math.max(t,c.x),r=Math.min(r,c.y),v=Math.max(v,c.y);return{strokeIndex:s,minX:i,maxX:t,minY:r,maxY:v,centerX:(i+t)/2,centerY:(r+v)/2}}estimateCharSize(o,s,i){if(0===o.length)return.15*s;const t=o.map(l=>"width"===i?l.maxX-l.minX:l.maxY-l.minY).filter(l=>l>5);if(0===t.length)return.15*s;t.sort((l,h)=>l-h);let v=t[Math.floor(t.length/2)]*this.config.charSizeMultiplier;return Math.max(s*this.config.minCharSizeRatio,Math.min(s*this.config.maxCharSizeRatio,v))}findColumnDividers(o,s,i){if(o.length<2)return[];const t=Math.min(...o.map(l=>l.minY)),r=Math.max(...o.map(l=>l.maxY)),v=[...o].sort((l,h)=>l.centerX-h.centerX),c=[],g=s*this.config.minColumnGapRatio;for(let l=0;l<v.length-1;l++){const M=v[l].maxX,d=v[l+1].minX,u=d-M;u>=g&&c.push({gapStart:M,gapEnd:d,gapSize:u})}return c.map(l=>({slope:0,intercept:(l.gapStart+l.gapEnd)/2,start:t-10,end:r+10}))}assignStrokesToColumns(o,s){const i=s.length+1,t=Array.from({length:i},()=>[]),r=s.map(v=>v.intercept).sort((v,c)=>v-c);for(const v of o){let c=0;for(let l=0;l<r.length;l++)v.centerX>r[l]&&(c=l+1);t[i-1-c].push(v.strokeIndex)}return t}findAllRowDividers(o,s,i,t){return o.map((r,v)=>{if(r.length<2)return[];const c=r.map(l=>s[l]),g=this.getColumnXBounds(v,i,o.length,c);return this.findRowDividers(c,t,g)})}getColumnXBounds(o,s,i,t){if(0===s.length||0===t.length)return{minX:Math.min(...t.map(w=>w.minX)),maxX:Math.max(...t.map(w=>w.maxX))};const r=s.map(w=>w.intercept).sort((w,M)=>w-M),v=i-1-o,c=Math.min(...t.map(w=>w.minX)),g=Math.max(...t.map(w=>w.maxX));return{minX:v>0?r[v-1]:c,maxX:v<r.length?r[v]:g}}findRowDividers(o,s,i){if(o.length<2)return[];const t=[...o].sort((c,g)=>c.centerY-g.centerY),r=[],v=s*this.config.minRowGapRatio;for(let c=0;c<t.length-1;c++){const h=t[c].maxY,w=t[c+1].minY,M=w-h;M>=v&&r.push({gapStart:h,gapEnd:w,gapSize:M})}return r.map(c=>({slope:0,intercept:(c.gapStart+c.gapEnd)/2,start:i.minX-10,end:i.maxX+10}))}createCellGrid(o,s,i,t){const r=[],v=o.length;for(let c=0;c<v;c++){const g=o[c],l=t[c]||[];if(0===g.length)continue;const h=g.map(p=>s[p]),w=Math.min(...h.map(p=>p.minY)),M=Math.max(...h.map(p=>p.maxY)),d=l.map(p=>p.intercept).sort((p,k)=>p-k),u=d.length+1;for(let p=0;p<u;p++){const k=0===p?w-5:d[p-1],x=p===u-1?M+5:d[p],C=g.filter(f=>{const L=s[f];return L.centerY>=k&&L.centerY<=x});if(0===C.length)continue;const H=C.map(f=>s[f]),z={minX:Math.min(...H.map(f=>f.minX)),maxX:Math.max(...H.map(f=>f.maxX)),minY:Math.min(...H.map(f=>f.minY)),maxY:Math.max(...H.map(f=>f.maxY))};r.push({column:c,row:p,strokeIndices:C,bounds:z})}}return r}calculateRatio(o){if(o.length<=1)return 1;const s=Math.min(...o),i=Math.max(...o);return s>0?i/s:1/0}enforceColumnUniformity(o,s,i){if(0===s.length)return o;let r=[...o];for(let v=0;v<10;v++){const c=r.map(z=>z.intercept).sort((z,f)=>z-f),g=[i.minX,...c,i.maxX],l=[];for(let z=0;z<g.length-1;z++)l.push(g[z+1]-g[z]);if(l.length<=1)break;const h=this.calculateRatio(l);if(h<=this.MAX_SIZE_RATIO)break;let w=null,M=h,d=0,u=-1;const p=l.indexOf(Math.max(...l)),k=(g[p]+g[p+1])/2,x=[...l],C=l[p]/2;x.splice(p,1,C,C);const H=this.calculateRatio(x);if(H<M&&(M=H,w="split",d=k),r.length>0){const z=l.indexOf(Math.min(...l));if(z>0){const f=[...l];f[z-1]+=f[z],f.splice(z,1);const L=this.calculateRatio(f);L<M&&(M=L,w="merge",u=z-1)}if(z<l.length-1){const f=[...l];f[z]+=f[z+1],f.splice(z+1,1);const L=this.calculateRatio(f);L<M&&(M=L,w="merge",u=z)}}if("split"===w)r.push({slope:0,intercept:d,start:i.minY-10,end:i.maxY+10}),r.sort((f,L)=>f.intercept-L.intercept);else{if(!("merge"===w&&u>=0&&u<r.length))break;{const z=[...r].sort((f,L)=>f.intercept-L.intercept);z.splice(u,1),r=z}}}return r}enforceRowUniformity(o,s,i,t){return o.map((v,c)=>{const g=s[c];if(0===g.length)return v;const l=g.map(u=>i[u]),h=Math.min(...l.map(u=>u.minY)),w=Math.max(...l.map(u=>u.maxY)),M=this.getColumnXBounds(c,t,s.length,l);let d=[...v];for(let u=0;u<10;u++){const k=[h,...d.map(B=>B.intercept).sort((B,A)=>B-A),w],x=[];for(let B=0;B<k.length-1;B++)x.push(k[B+1]-k[B]);if(x.length<=1)break;const C=this.calculateRatio(x);if(C<=this.MAX_SIZE_RATIO)break;let H=null,z=C,f=0,L=-1;const j=x.indexOf(Math.max(...x)),P=(k[j]+k[j+1])/2,b=[...x],N=x[j]/2;b.splice(j,1,N,N);const G=this.calculateRatio(b);if(G<z&&(z=G,H="split",f=P),d.length>0){const B=x.indexOf(Math.min(...x));if(B>0){const A=[...x];A[B-1]+=A[B],A.splice(B,1);const y=this.calculateRatio(A);y<z&&(z=y,H="merge",L=B-1)}if(B<x.length-1){const A=[...x];A[B]+=A[B+1],A.splice(B+1,1);const y=this.calculateRatio(A);y<z&&(z=y,H="merge",L=B)}}if("split"===H)d.push({slope:0,intercept:f,start:M.minX-10,end:M.maxX+10}),d.sort((A,y)=>A.intercept-y.intercept);else{if(!("merge"===H&&L>=0&&L<d.length))break;{const B=[...d].sort((A,y)=>A.intercept-y.intercept);B.splice(L,1),d=B}}}return d})}enforceColumnsNotExceedRows(o,s,i,t,r){let c=[...o],g=[...s];for(let l=0;l<10&&!(c.length+1<=Math.max(...g.map(x=>x.length+1),1)||0===c.length);l++){const M=[...c].sort((x,C)=>x.intercept-C.intercept),d=[r.minX,...M.map(x=>x.intercept),r.maxX];let u=0,p=1/0;for(let x=0;x<M.length;x++){const z=d[x+1]-d[x]+(d[x+2]-d[x+1]);z<p&&(p=z,u=x)}M.splice(u,1),c=M;const k=this.assignStrokesToColumns(i,c);g=this.findAllRowDividers(k,i,c,t),g=this.enforceRowUniformity(g,k,i,c)}return{columnDividers:c,rowDividers:g}}static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275prov=V.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return n(),e})();const n1=["canvas"];function t1(n,e){1&n&&a.nrm(0,"canvas",11,0)}function l1(n,e){if(1&n){const m=a.RV6();a.j41(0,"ion-button",12),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.onUndo())}),a.nrm(1,"ion-icon",13),a.k0s()}}function c1(n,e){1&n&&(a.j41(0,"div",14)(1,"div",15),a.EFF(2,"\u304a\u3081\u3067\u3068\u3046\u{1f973}"),a.k0s(),a.j41(3,"div",16),a.EFF(4,"You're all caught up. Come back again soon for more lessons!"),a.k0s()())}function e1(n,e){1&n&&a.nrm(0,"ion-spinner",20)}function r1(n,e){if(1&n&&(a.j41(0,"span"),a.EFF(1),a.k0s()),2&n){const m=a.XpG(2);a.R7$(),a.JRh(m.checkButtonText)}}function v1(n,e){if(1&n){const m=a.RV6();a.j41(0,"ion-button",17),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.onCheck())}),a.DNE(1,e1,1,0,"ion-spinner",18)(2,r1,2,1,"span",19),a.k0s()}if(2&n){const m=a.XpG();a.Y8G("disabled",m.isChecking),a.R7$(),a.Y8G("ngIf",m.isChecking),a.R7$(),a.Y8G("ngIf",!m.isChecking)}}function g1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\u25ef"),a.k0s())}function h1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\uff1f"),a.k0s())}function w1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\u2715"),a.k0s())}function d1(n,e){if(1&n&&(a.j41(0,"div",32)(1,"span",33),a.EFF(2),a.k0s()()),2&n){const m=e.$implicit;a.R7$(2),a.JRh(m.character)}}function m1(n,e){if(1&n&&(a.j41(0,"div",28)(1,"div",29),a.EFF(2,"Recognized:"),a.k0s(),a.j41(3,"div",30),a.DNE(4,d1,3,1,"div",31),a.k0s()()),2&n){const m=a.XpG(2);a.R7$(4),a.Y8G("ngForOf",m.displayMatches)}}function p1(n,e){if(1&n){const m=a.RV6();a.j41(0,"div",21),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.dismissResults())}),a.j41(1,"div",22),a.bIt("click",function(s){return V.eBV(m),V.Njj(s.stopPropagation())}),a.j41(2,"div",23),a.DNE(3,g1,2,0,"span",19)(4,h1,2,0,"span",19)(5,w1,2,0,"span",19),a.k0s(),a.j41(6,"div",24),a.EFF(7),a.k0s(),a.j41(8,"div",25),a.EFF(9),a.k0s(),a.DNE(10,m1,5,1,"div",26),a.j41(11,"ion-button",27),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.dismissResults())}),a.EFF(12),a.k0s()()()}if(2&n){const m=a.XpG();a.R7$(),a.HbH(m.resultStatus),a.R7$(2),a.Y8G("ngIf","correct"===m.resultStatus),a.R7$(),a.Y8G("ngIf","befuddled"===m.resultStatus),a.R7$(),a.Y8G("ngIf","wrong"===m.resultStatus),a.R7$(2),a.JRh(m.resultFeedback),a.R7$(2),a.JRh(m.strokeCountInfo),a.R7$(),a.Y8G("ngIf",m.displayMatches.length>0),a.R7$(2),a.JRh(m.dismissButtonText)}}let W=(()=>{var n;class e{kanaMatch(o,s){if(o===s)return!0;const i=e.SMALL_TO_BIG_KANA[o];if(i&&i===s)return!0;const t=e.SMALL_TO_BIG_KANA[s];return!!(t&&t===o||i&&t&&i===t)}constructor(o,s,i){this.strokeRecognition=o,this.cardsService=s,this.segmentationService=i,this.isDrawing=!1,this.strokes=[],this.currentStroke=[],this.drawStartTime=0,this.currentCharacter="",this.promptText="",this.promptColor="#FFFFFF",this.noCardsAvailable=!1,this.isChecking=!1,this.showResults=!1,this.resultStatus="",this.resultFeedback="",this.strokeCountInfo="",this.topMatches=[],this.displayMatches=[],this.cardAvailabilitySubscription=null,this.segmentationTimer=null,this.segmentationResult=null,this.SEGMENTATION_DELAY_MS=500,this.lastBatchResults=[],this.correctFeedback=["\u6b63\u89e3!","\u307e\u308b!","\u306f\u306a\u307e\u308b!","\u3088\u304f\u3084\u3063\u305f!","\u3059\u3054\u3044!","\u304b\u3093\u307a\u304d!","\u3070\u3063\u3061\u308a!","\u305d\u306e\u8abf\u5b50!"],this.wrongFeedback=["\u3061\u304c\u3046!","\u3056\u3093\u306d\u3093!","\u306f\u305a\u308c!","\u3075\u305b\u3044\u304b\u3044!","\u30d0\u30c4!"],this.checkButtonLabels=["\u3088\u3057!","\u5224\u5b9a!","\u3067\u304d\u305f!","\u3044\u3056!","\u78ba\u8a8d"],this.dismissButtonLabels=["\u6b21!","\u3064\u304e!","\u3088\u3057!","\u30aa\u30c3\u30b1\u30fc!","\u306f\u3044!","\u4e86\u89e3!","\u3044\u304f\u305e!"],this.checkButtonText="",this.dismissButtonText="",this.minBrushSize=3,this.maxBrushSize=24,this.brushSmoothing=.05,this.lastBrushSize=0,function(n){Object.keys(n).forEach(function(e){X(e,n[e]);var m=e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();e!==m&&X(m,n[e])})}({backspace:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M403.13 96H156.87a44.9 44.9 0 00-33.68 15.27 15.88 15.88 0 00-1.91 2.7L32 247.75a16 16 0 000 16.5l89.15 133.57a16.24 16.24 0 002 2.88 44.89 44.89 0 0033.7 15.3h246.28A44.92 44.92 0 00448 371.13V140.87A44.92 44.92 0 00403.13 96zM348 311a16 16 0 11-22.63 22.62L271.67 280 218 333.65A16 16 0 01195.35 311L249 257.33l-53.69-53.69A16 16 0 01218 181l53.69 53.7 53.67-53.7A16 16 0 01348 203.64l-53.7 53.69z'/></svg>"})}ngOnInit(){var o=this;return(0,_.A)(function*(){o.checkButtonText=o.randomFrom(o.checkButtonLabels),yield o.cardsService.initialize(),o.loadRandomCard(),o.cardAvailabilitySubscription=o.cardsService.cardAvailability$.subscribe(s=>{o.noCardsAvailable&&s>0&&o.loadRandomCard()})})()}loadRandomCard(){this.currentCard=this.cardsService.getRandomUnlockedCard(),this.currentCard?(this.currentCharacter=this.currentCard.answers[0],this.promptText=this.currentCard.prompt,this.promptColor=this.cardsService.getStageColor(this.currentCard.stage),this.noCardsAvailable=!1):(this.noCardsAvailable=!0,this.promptText="",this.promptColor="#FFFFFF")}ngAfterViewInit(){setTimeout(()=>this.setupCanvas(),100)}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.cardAvailabilitySubscription&&this.cardAvailabilitySubscription.unsubscribe(),this.cancelSegmentation()}setupCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(s),this.ctx=o.getContext("2d"),this.setCanvasStyle(),o.addEventListener("mousedown",this.handleMouseDown.bind(this)),o.addEventListener("mousemove",this.handleMouseMove.bind(this)),o.addEventListener("mouseup",this.handleMouseUp.bind(this)),o.addEventListener("mouseleave",this.handleMouseUp.bind(this)),o.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),o.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),o.addEventListener("touchend",this.handleTouchEnd.bind(this)))}resizeCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(o.width=s.clientWidth,o.height=s.clientHeight,this.ctx&&this.setCanvasStyle())}setCanvasStyle(){this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff",this.ctx.lineCap="round",this.ctx.lineJoin="round"}handleMouseDown(o){this.cancelSegmentation(),this.isDrawing=!0;const s=this.getMousePos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleMouseMove(o){if(!this.isDrawing)return;const s=this.getMousePos(o),i=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(i,s)}handleMouseUp(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}handleTouchStart(o){o.preventDefault(),this.cancelSegmentation(),this.isDrawing=!0;const s=this.getTouchPos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleTouchMove(o){if(!this.isDrawing)return;o.preventDefault();const s=this.getTouchPos(o),i=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(i,s)}handleTouchEnd(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}getMousePos(o){const s=this.canvasRef.nativeElement,i=s.getBoundingClientRect(),t=s.width/i.width,r=s.height/i.height,v=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=v),{x:(o.clientX-i.left)*t,y:(o.clientY-i.top)*r,t:v-this.drawStartTime}}getTouchPos(o){const s=this.canvasRef.nativeElement,i=s.getBoundingClientRect(),t=s.width/i.width,r=s.height/i.height,v=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=v),{x:(o.touches[0].clientX-i.left)*t,y:(o.touches[0].clientY-i.top)*r,t:v-this.drawStartTime}}calculateBrushSize(o,s){const i=s.x-o.x,t=s.y-o.y,r=Math.max(s.t-o.t,1),c=Math.sqrt(i*i+t*t)/r,g=Math.min(c/1.5,1),h=this.lastBrushSize+(this.maxBrushSize-g*(this.maxBrushSize-this.minBrushSize)-this.lastBrushSize)*this.brushSmoothing;return this.lastBrushSize=h,h}drawBrushPoint(o,s,i){this.ctx.beginPath(),this.ctx.arc(o,s,i/2,0,2*Math.PI),this.ctx.fill()}drawBrushSegment(o,s){const i=this.calculateBrushSize(o,s);this.ctx.lineWidth=i,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.drawBrushPoint(s.x,s.y,i)}drawHarai(o){if(o.length<3)return;const s=Math.min(5,o.length),i=o.slice(-s),t=i[i.length-1],r=i[0],v=t.x-r.x,c=t.y-r.y,g=Math.sqrt(v*v+c*c);if(g<5)return;const l=v/g,h=c/g,w=Math.max(t.t-r.t,1),d=Math.min(g/w*20,40);if(d<8)return;const p=this.lastBrushSize;for(let k=0;k<8;k++){const C=(k+1)/8,H=1-Math.pow(1-k/8,2),z=1-Math.pow(1-C,2),f=t.x+l*d*H,L=t.y+h*d*H,j=t.x+l*d*z,P=t.y+h*d*z,b=p*(1-C);b>.5&&(this.ctx.lineWidth=b,this.ctx.beginPath(),this.ctx.moveTo(f,L),this.ctx.lineTo(j,P),this.ctx.stroke())}}onCheck(){var o=this;return(0,_.A)(function*(){if(0!==o.strokes.length&&o.currentCard){o.isChecking=!0;try{const s=o.canvasRef.nativeElement;o.segmentationResult||(o.segmentationResult=o.segmentationService.segment(o.strokes,s.width,s.height));const r=[...o.segmentationResult.grid.cells.filter(h=>h.strokeIndices.length>0)].sort((h,w)=>h.column!==w.column?h.column-w.column:h.row-w.row);let v;if(r.length<=1)o.lastBatchResults=[],v=yield o.strokeRecognition.recognize(o.strokes,s.width,s.height);else{const h=r.map(d=>({strokes:d.strokeIndices.map(x=>o.strokes[x]),bounds:{width:d.bounds.maxX-d.bounds.minX,height:d.bounds.maxY-d.bounds.minY}})),w=yield o.strokeRecognition.recognizeBatch(h);o.lastBatchResults=w,v=[{character:w.map(d=>d[0]?.character||"?").join(""),score:100}],console.log("Cell interpretations (Japanese reading order):",w.map((d,u)=>({cell:u,position:`col ${r[u].column}, row ${r[u].row}`,top5:d.slice(0,5).map(p=>p.character)})))}o.topMatches=v.slice(0,5);const c=o.currentCard.answers.map(h=>h.replace(/\s+/g,""));let g=!1;if(o.lastBatchResults.length>0)g=c.some(h=>{const w=[...h];return w.length===o.lastBatchResults.length&&w.every((M,d)=>o.lastBatchResults[d].slice(0,5).map(p=>p.character).some(p=>o.kanaMatch(M,p)))}),console.log("Grading multi-char:",{targets:c,cellResults:o.lastBatchResults.map(h=>h.slice(0,5).map(w=>w.character)),isCorrect:g});else{const h=o.topMatches.map(w=>w.character);g=c.some(w=>h.some(M=>o.kanaMatch(w,M)))}if(g)o.resultStatus="correct",o.resultFeedback=o.randomFrom(o.correctFeedback),o.displayMatches=o.topMatches.slice(0,1),o.cardsService.advanceCard(o.currentCard.id);else{let h;if(o.lastBatchResults.length>0)h=o.currentCard.befuddlers.find(w=>w.answers.some(M=>{const d=[...M.replace(/\s+/g,"")];return d.length===o.lastBatchResults.length&&d.every((u,p)=>o.lastBatchResults[p].slice(0,5).map(x=>x.character).some(x=>o.kanaMatch(u,x)))}));else{const w=o.topMatches.map(M=>M.character);h=o.currentCard.befuddlers.find(M=>M.answers.some(d=>w.some(u=>o.kanaMatch(d.replace(/\s+/g,""),u))))}h?(o.resultStatus="befuddled",o.resultFeedback=h.toast,o.displayMatches=o.topMatches):(o.resultStatus="wrong",o.resultFeedback=o.randomFrom(o.wrongFeedback),o.displayMatches=o.topMatches)}const l=o.strokeRecognition.getExpectedStrokeCount(o.currentCharacter);o.strokeCountInfo=`Strokes: ${o.strokes.length}/${l}`}catch(s){console.error("Recognition error:",s),o.resultStatus="wrong",o.resultFeedback=s.message||"Recognition failed. Please try on a device.",o.topMatches=[],o.displayMatches=[],o.strokeCountInfo=""}o.isChecking=!1,o.checkButtonText=o.randomFrom(o.checkButtonLabels),o.dismissButtonText=o.randomFrom(o.dismissButtonLabels),o.showResults=!0}})()}dismissResults(){this.showResults=!1,this.clearCanvas(),("correct"===this.resultStatus||"wrong"===this.resultStatus)&&this.loadRandomCard()}onUndo(){this.strokes.length>0&&(this.strokes.pop(),this.redrawStrokes(),this.scheduleSegmentation())}redrawStrokes(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.setCanvasStyle();for(const s of this.strokes)if(0!==s.length){this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s[0].x,s[0].y,1.5*this.minBrushSize);for(let i=1;i<s.length;i++)this.drawBrushSegment(s[i-1],s[i]);this.drawHarai(s)}}clearCanvas(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.strokes=[],this.drawStartTime=0,this.cancelSegmentation(),this.segmentationResult=null}randomFrom(o){return o[Math.floor(Math.random()*o.length)]}scheduleSegmentation(){this.cancelSegmentation(),0!==this.strokes.length?this.segmentationTimer=setTimeout(()=>{this.analyzeAndVisualize()},this.SEGMENTATION_DELAY_MS):this.segmentationResult=null}cancelSegmentation(){null!==this.segmentationTimer&&(clearTimeout(this.segmentationTimer),this.segmentationTimer=null)}analyzeAndVisualize(){if(0===this.strokes.length)return void(this.segmentationResult=null);const o=this.canvasRef.nativeElement;this.segmentationResult=this.segmentationService.segment(this.strokes,o.width,o.height),this.redrawWithBoundaries()}redrawWithBoundaries(){if(this.redrawStrokes(),this.segmentationResult){const o=this.segmentationResult.grid;(o.columnDividers.length>0||o.rowDividers.some(i=>i.length>0))&&this.drawDividers(o)}}drawDividers(o){this.ctx.save(),this.ctx.strokeStyle="rgba(128, 128, 128, 0.4)",this.ctx.lineWidth=1,this.ctx.setLineDash([4,4]);for(const s of o.columnDividers){const i=s.start,t=s.end,r=s.slope*i+s.intercept,v=s.slope*t+s.intercept;this.ctx.beginPath(),this.ctx.moveTo(r,i),this.ctx.lineTo(v,t),this.ctx.stroke()}for(const s of o.rowDividers)for(const i of s){const t=i.start,r=i.end,v=i.slope*t+i.intercept,c=i.slope*r+i.intercept;this.ctx.beginPath(),this.ctx.moveTo(t,v),this.ctx.lineTo(r,c),this.ctx.stroke()}this.ctx.restore()}static#o=n=()=>(this.SMALL_TO_BIG_KANA={\u3063:"\u3064",\u3083:"\u3084",\u3085:"\u3086",\u3087:"\u3088",\u3041:"\u3042",\u3043:"\u3044",\u3045:"\u3046",\u3047:"\u3048",\u3049:"\u304a",\u308e:"\u308f",\u30c3:"\u30c4",\u30e3:"\u30e4",\u30e5:"\u30e6",\u30e7:"\u30e8",\u30a1:"\u30a2",\u30a3:"\u30a4",\u30a5:"\u30a6",\u30a7:"\u30a8",\u30a9:"\u30aa",\u30ee:"\u30ef"},this.\u0275fac=function(s){return new(s||e)(a.rXU(a1),a.rXU(U.D),a.rXU(i1))},this.\u0275cmp=a.VBU({type:e,selectors:[["app-workbook"]],viewQuery:function(s,i){if(1&s&&a.GBs(n1,5),2&s){let t;a.mGM(t=a.lsd())&&(i.canvasRef=t.first)}},decls:11,vars:10,consts:[["canvas",""],[1,"workbook-content",3,"fullscreen","scrollY"],[1,"prompt-bar"],["color","light"],[1,"prompt-text"],[1,"canvas-wrapper"],["class","drawing-canvas",4,"ngIf"],["class","undo-btn","fill","clear",3,"click",4,"ngIf"],["class","caught-up-box",4,"ngIf"],["class","check-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","results-overlay",3,"click",4,"ngIf"],[1,"drawing-canvas"],["fill","clear",1,"undo-btn",3,"click"],["name","backspace"],[1,"caught-up-box"],[1,"caught-up-title"],[1,"caught-up-message"],["color","primary",1,"check-btn",3,"click","disabled"],["name","crescent",4,"ngIf"],[4,"ngIf"],["name","crescent"],[1,"results-overlay",3,"click"],[1,"results-card",3,"click"],[1,"status-display"],[1,"feedback"],[1,"stroke-info"],["class","matches-section",4,"ngIf"],["expand","block",3,"click"],[1,"matches-section"],[1,"matches-title"],[1,"matches-list"],["class","match-item",4,"ngFor","ngForOf"],[1,"match-item"],[1,"match-char"]],template:function(s,i){1&s&&(a.j41(0,"ion-content",1)(1,"div",2),a.nrm(2,"ion-menu-button",3),a.j41(3,"span",4),a.EFF(4),a.k0s()(),a.j41(5,"div",5),a.DNE(6,t1,2,0,"canvas",6)(7,l1,2,0,"ion-button",7)(8,c1,5,0,"div",8),a.k0s(),a.DNE(9,v1,3,3,"ion-button",9)(10,p1,13,9,"div",10),a.k0s()),2&s&&(a.Y8G("fullscreen",!0)("scrollY",!1),a.R7$(3),a.xc7("color",i.promptColor),a.R7$(),a.JRh(i.promptText),a.R7$(2),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",i.showResults))},dependencies:[O.W9,O.MC,O.Jm,O.iq,O.w2,q.MD,q.Sq,q.bT],styles:[".workbook-content[_ngcontent-%COMP%]{--background: #000}.prompt-bar[_ngcontent-%COMP%]{display:flex;align-items:center;height:144px;background:#111;padding:0 8px}.prompt-text[_ngcontent-%COMP%]{flex:1;text-align:center;font-size:28px;color:#fff;margin-right:40px}.canvas-wrapper[_ngcontent-%COMP%]{position:absolute;inset:144px 0 0;background:#000}.drawing-canvas[_ngcontent-%COMP%]{width:100%;height:100%;touch-action:none;display:block}.undo-btn[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:24px}.results-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000e6;display:flex;align-items:center;justify-content:center;z-index:100}.results-card[_ngcontent-%COMP%]{background:#1a1a1a;border-radius:16px;padding:24px;min-width:280px;max-width:90%;text-align:center}.results-card.correct[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.correct[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#e63946}.results-card.befuddled[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.befuddled[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#f7b731}.results-card.wrong[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.wrong[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#4a90d9}.status-display[_ngcontent-%COMP%]{font-size:64px;font-weight:700;margin-bottom:8px}.feedback[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-size:18px;margin-bottom:16px;white-space:pre-line}.stroke-info[_ngcontent-%COMP%]{font-size:14px;color:#888;margin-bottom:20px}.matches-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.matches-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.matches-list[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:16px}.match-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.match-char[_ngcontent-%COMP%]{font-size:32px;color:#fff}.check-btn[_ngcontent-%COMP%]{position:absolute;bottom:32px;left:50%;transform:translate(-50%);--background: #222;--background-hover: #333;--color: #fff;--border-radius: 32px;--padding-start: 12vw;--padding-end: 12vw;--padding-top: 16px;--padding-bottom: 16px;min-height:60px;font-family:Shippori Mincho,serif;font-size:clamp(20px,5vw,28px);font-weight:600;letter-spacing:2px}.results-card[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-weight:700}.caught-up-box[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border-radius:16px;padding:32px;text-align:center;max-width:90%;width:320px}.caught-up-title[_ngcontent-%COMP%]{font-size:36px;margin-bottom:16px}.caught-up-message[_ngcontent-%COMP%]{font-size:16px;color:#ccc;line-height:1.5}"]}))}return n(),e})();const x1=[{path:"",component:W}];let u1=(()=>{var n;class e{static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275mod=a.$C({type:e}),this.\u0275inj=V.G2t({imports:[I.iI.forChild(x1),I.iI]}))}return n(),e})(),M1=(()=>{var n;class e{static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275mod=a.$C({type:e}),this.\u0275inj=V.G2t({imports:[q.MD,J.YN,Q.bv,u1,W]}))}return n(),e})()}}]);