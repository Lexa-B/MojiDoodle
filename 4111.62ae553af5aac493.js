"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4111],{4111(C1,G,O){O.d(G,{WorkbookPageModule:()=>L1});var T,q=O(2200),$=O(4341),J=O(7343),E=O(8132),_=O(467),R=O(6299),X=function(l,s){var a=function(){if(typeof window>"u")return new Map;if(!T){var l=window;l.Ionicons=l.Ionicons||{},T=l.Ionicons.map=l.Ionicons.map||new Map}return T}(),o=a.get(l);void 0===o?a.set(l,s):o!==s&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(l,'". Ensure that multiple icons are not mapped to the same icon name.'))},t=O(3664),H=O(2615),N=O(4185);let t1=(()=>{var l;class s{constructor(o){this.cardsService=o,this.API_URL="https://inputtools.google.com/request?itc=ja-t-i0-handwrit&app=translate"}recognize(o,i,n){var e=this;return(0,_.A)(function*(){if(0===o.length)return[];const r=o.map(h=>{const w=[],c=[],g=[];for(const v of h)w.push(Math.round(v.x)),c.push(Math.round(v.y)),g.push(v.t);return[w,c,g]}),d={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:[{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:n,writing_area_width:i},ink:r}]};try{const w=yield(yield fetch(e.API_URL,{method:"POST",body:JSON.stringify(d),headers:{"Content-Type":"application/json"}})).json();return e.parseResponse(w)}catch(h){throw console.error("Recognition failed:",h),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}recognizeBatch(o){var i=this;return(0,_.A)(function*(){if(0===o.length)return[];const n=o.map(r=>{const d=r.strokes.map(h=>{const w=[],c=[],g=[];for(const v of h)w.push(Math.round(v.x)),c.push(Math.round(v.y)),g.push(v.t);return[w,c,g]});return{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:Math.round(r.bounds.height),writing_area_width:Math.round(r.bounds.width)},ink:d}}),e={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:n};try{const d=yield(yield fetch(i.API_URL,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}})).json();return i.parseBatchResponse(d,o.length)}catch(r){throw console.error("Batch recognition failed:",r),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}parseBatchResponse(o,i){if(!o||"SUCCESS"!==o[0])return Array(i).fill([]);const n=[],e=o[1]||[];for(let r=0;r<i;r++){const d=e[r]?.[1];if(!d||0===d.length){n.push([]);continue}const h=d.map(w=>w.replace(/\s+/g,"")).filter(w=>1===[...w].length).map((w,c)=>({character:w,score:Math.max(100-10*c,10)}));n.push(h)}return n}parseResponse(o){if(!o||"SUCCESS"!==o[0])return[];const i=o[1]?.[0]?.[1];return i&&0!==i.length?i.map((n,e)=>({character:n.replace(/\s+/g,""),score:Math.max(100-10*e,10)})):[]}getExpectedStrokeCount(o){return this.cardsService.getStrokeCount(o)}static#s=l=()=>(this.\u0275fac=function(i){return new(i||s)(H.KVO(N.D))},this.\u0275prov=H.jDH({token:s,factory:s.\u0275fac,providedIn:"root"}))}return l(),s})(),n1=(()=>{var l;class s{constructor(){this.config={minColumnGapRatio:.25,maxColumnAngle:10,minRowGapRatio:.25,maxRowAngle:10,charSizeMultiplier:2,minCharSizeRatio:.08,maxCharSizeRatio:.4},this.MAX_SIZE_RATIO=2}segment(o,i,n,e){if(0===o.length)return this.emptyResult();const r=o.map((B,u)=>this.calculateStrokeBounds(B,u)),d={minX:Math.min(...r.map(B=>B.minX)),maxX:Math.max(...r.map(B=>B.maxX)),minY:Math.min(...r.map(B=>B.minY)),maxY:Math.max(...r.map(B=>B.maxY))},h=this.estimateCharSize(r,i,"width"),w=this.estimateCharSize(r,n,"height");let c=this.findColumnDividers(r,h,n,e||[]);c=this.addInterLassoDividers(c,r,e||[],"x",n),c=this.enforceColumnUniformity(c,r,d,e||[]);const g=this.assignStrokesToColumns(r,c);let v=this.findAllRowDividers(g,r,c,w,e||[]);v=this.addInterLassoRowDividers(v,g,r,c,e||[]),v=this.enforceRowUniformity(v,g,r,c,e||[]);const x=this.enforceColumnsNotExceedRows(c,v,r,w,d,e||[]);c=x.columnDividers,v=x.rowDividers;const M=this.assignStrokesToColumns(r,c),m=this.createCellGrid(M,r,c,v),p=c.length+1,L=Math.max(...v.map(B=>B.length+1),1);return{grid:{columnDividers:c,rowDividers:v,cells:m,columns:p,maxRows:L},estimatedCharHeight:w,estimatedCharWidth:h}}emptyResult(){return{grid:{columnDividers:[],rowDividers:[],cells:[],columns:0,maxRows:0},estimatedCharHeight:0,estimatedCharWidth:0}}calculateStrokeBounds(o,i){if(0===o.length)return{strokeIndex:i,minX:0,maxX:0,minY:0,maxY:0,centerX:0,centerY:0};let n=1/0,e=-1/0,r=1/0,d=-1/0;for(const h of o)n=Math.min(n,h.x),e=Math.max(e,h.x),r=Math.min(r,h.y),d=Math.max(d,h.y);return{strokeIndex:i,minX:n,maxX:e,minY:r,maxY:d,centerX:(n+e)/2,centerY:(r+d)/2}}estimateCharSize(o,i,n){if(0===o.length)return.15*i;const e=o.map(c=>"width"===n?c.maxX-c.minX:c.maxY-c.minY).filter(c=>c>5);if(0===e.length)return.15*i;e.sort((c,g)=>c-g);let d=e[Math.floor(e.length/2)]*this.config.charSizeMultiplier;return Math.max(i*this.config.minCharSizeRatio,Math.min(i*this.config.maxCharSizeRatio,d))}findColumnDividers(o,i,n,e){if(o.length<2)return[];const r=Math.min(...o.map(g=>g.minY)),d=Math.max(...o.map(g=>g.maxY)),h=[...o].sort((g,v)=>g.centerX-v.centerX),w=[],c=i*this.config.minColumnGapRatio;for(let g=0;g<h.length-1;g++){const M=h[g].maxX,m=h[g+1].minX,p=m-M;p>=c&&w.push({gapStart:M,gapEnd:m,gapSize:p})}return w.map(g=>({slope:0,intercept:(g.gapStart+g.gapEnd)/2,start:r-10,end:d+10})).filter(g=>!this.wouldSplitProtectedGroup(g.intercept,"x",o,e))}assignStrokesToColumns(o,i){const n=i.length+1,e=Array.from({length:n},()=>[]),r=i.map(d=>d.intercept).sort((d,h)=>d-h);for(const d of o){let h=0;for(let c=0;c<r.length;c++)d.centerX>r[c]&&(h=c+1);e[n-1-h].push(d.strokeIndex)}return e}findAllRowDividers(o,i,n,e,r){return o.map((d,h)=>{if(d.length<2)return[];const w=d.map(g=>i[g]),c=this.getColumnXBounds(h,n,o.length,w);return this.findRowDividers(w,e,c,i,r)})}getColumnXBounds(o,i,n,e){if(0===i.length||0===e.length)return{minX:Math.min(...e.map(v=>v.minX)),maxX:Math.max(...e.map(v=>v.maxX))};const r=i.map(v=>v.intercept).sort((v,x)=>v-x),d=n-1-o,h=Math.min(...e.map(v=>v.minX)),w=Math.max(...e.map(v=>v.maxX));return{minX:d>0?r[d-1]:h,maxX:d<r.length?r[d]:w}}findRowDividers(o,i,n,e,r){if(o.length<2)return[];const d=[...o].sort((c,g)=>c.centerY-g.centerY),h=[],w=i*this.config.minRowGapRatio;for(let c=0;c<d.length-1;c++){const x=d[c].maxY,M=d[c+1].minY,m=M-x;m>=w&&h.push({gapStart:x,gapEnd:M,gapSize:m})}return h.map(c=>({slope:0,intercept:(c.gapStart+c.gapEnd)/2,start:n.minX-10,end:n.maxX+10})).filter(c=>!this.wouldSplitProtectedGroup(c.intercept,"y",e,r))}createCellGrid(o,i,n,e){const r=[],d=o.length;for(let h=0;h<d;h++){const w=o[h],c=e[h]||[];if(0===w.length)continue;const g=w.map(p=>i[p]),v=Math.min(...g.map(p=>p.minY)),x=Math.max(...g.map(p=>p.maxY)),M=c.map(p=>p.intercept).sort((p,L)=>p-L),m=M.length+1;for(let p=0;p<m;p++){const L=0===p?v-5:M[p-1],B=p===m-1?x+5:M[p],u=w.filter(k=>{const S=i[k];return S.centerY>=L&&S.centerY<=B});if(0===u.length)continue;const f=u.map(k=>i[k]),z={minX:Math.min(...f.map(k=>k.minX)),maxX:Math.max(...f.map(k=>k.maxX)),minY:Math.min(...f.map(k=>k.minY)),maxY:Math.max(...f.map(k=>k.maxY))};r.push({column:h,row:p,strokeIndices:u,bounds:z})}}return r}calculateRatio(o){if(o.length<=1)return 1;const i=Math.min(...o),n=Math.max(...o);return i>0?n/i:1/0}wouldSplitProtectedGroup(o,i,n,e){for(const r of e){if(r.strokeIndices.length<2)continue;const d=r.strokeIndices.filter(g=>g<n.length).map(g=>n[g]);if(d.length<2)continue;const h=d.map(g=>"x"===i?g.centerX:g.centerY),w=Math.min(...h),c=Math.max(...h);if(o>w&&o<c)return!0}return!1}addInterLassoDividers(o,i,n,e,r){if(n.length<2)return o;const d=[];for(let v=0;v<n.length;v++){const x=n[v];if(0===x.strokeIndices.length)continue;const M=x.strokeIndices.filter(u=>u<i.length).map(u=>i[u]);if(0===M.length)continue;const m=Math.min(...M.map(u=>"x"===e?u.minX:u.minY)),p=Math.max(...M.map(u=>"x"===e?u.maxX:u.maxY)),L=Math.min(...M.map(u=>"x"===e?u.minY:u.minX)),B=Math.max(...M.map(u=>"x"===e?u.maxY:u.maxX));d.push({lassoIdx:v,min:m,max:p,perpMin:L,perpMax:B})}if(d.length<2)return o;d.sort((v,x)=>v.min-x.min);const h=[...o],w=new Set(o.map(v=>v.intercept)),c=Math.min(...i.map("x"===e?v=>v.minY:v=>v.minX)),g=Math.max(...i.map("x"===e?v=>v.maxY:v=>v.maxX));for(let v=0;v<d.length-1;v++){const x=d[v],M=d[v+1],m=x.max-M.min,B=Math.min(x.max-x.min,M.max-M.min),u=Math.min(x.perpMax,M.perpMax)-Math.max(x.perpMin,M.perpMin),k=Math.min(x.perpMax-x.perpMin,M.perpMax-M.perpMin);if(B>0&&m>.5*B&&!(k>0&&u>.3*k))continue;const A=(x.max+M.min)/2;[...w].some(I=>Math.abs(I-A)<10)||(h.push({slope:0,intercept:A,start:c-10,end:g+10}),w.add(A))}return h.sort((v,x)=>v.intercept-x.intercept)}addInterLassoRowDividers(o,i,n,e,r){return r.length<2?o:o.map((d,h)=>{const w=i[h];if(w.length<2)return d;const c=w.map(m=>n[m]),g=this.getColumnXBounds(h,e,i.length,c),v=[];for(let m=0;m<r.length;m++){const L=r[m].strokeIndices.filter(z=>w.includes(z));if(0===L.length)continue;const B=L.map(z=>n[z]),u=Math.min(...B.map(z=>z.minY)),f=Math.max(...B.map(z=>z.maxY));v.push({lassoIdx:m,minY:u,maxY:f})}if(v.length<2)return d;v.sort((m,p)=>m.minY-p.minY);const x=[...d],M=new Set(d.map(m=>m.intercept));for(let m=0;m<v.length-1;m++){const p=v[m],L=v[m+1],B=p.maxY-L.minY,z=Math.min(p.maxY-p.minY,L.maxY-L.minY);if(z>0&&B>.5*z)continue;const k=(p.maxY+L.minY)/2;[...M].some(A=>Math.abs(A-k)<10)||(x.push({slope:0,intercept:k,start:g.minX-10,end:g.maxX+10}),M.add(k))}return x.sort((m,p)=>m.intercept-p.intercept)})}enforceColumnUniformity(o,i,n,e){if(0===i.length)return o;let d=[...o];for(let h=0;h<10;h++){const w=d.map(f=>f.intercept).sort((f,z)=>f-z),c=[n.minX,...w,n.maxX],g=[];for(let f=0;f<c.length-1;f++)g.push(c[f+1]-c[f]);if(g.length<=1)break;const v=this.calculateRatio(g);if(v<=this.MAX_SIZE_RATIO)break;let x=null,M=v,m=0,p=-1;const L=g.indexOf(Math.max(...g)),B=(c[L]+c[L+1])/2;if(!this.wouldSplitProtectedGroup(B,"x",i,e)){const f=[...g],z=g[L]/2;f.splice(L,1,z,z);const k=this.calculateRatio(f);k<M&&(M=k,x="split",m=B)}if(d.length>0){const f=g.indexOf(Math.min(...g));if(f>0){const z=[...g];z[f-1]+=z[f],z.splice(f,1);const k=this.calculateRatio(z);k<M&&(M=k,x="merge",p=f-1)}if(f<g.length-1){const z=[...g];z[f]+=z[f+1],z.splice(f+1,1);const k=this.calculateRatio(z);k<M&&(M=k,x="merge",p=f)}}if("split"===x)d.push({slope:0,intercept:m,start:n.minY-10,end:n.maxY+10}),d.sort((z,k)=>z.intercept-k.intercept);else{if(!("merge"===x&&p>=0&&p<d.length))break;{const f=[...d].sort((z,k)=>z.intercept-k.intercept);f.splice(p,1),d=f}}}return d}enforceRowUniformity(o,i,n,e,r){return o.map((h,w)=>{const c=i[w];if(0===c.length)return h;const g=c.map(p=>n[p]),v=Math.min(...g.map(p=>p.minY)),x=Math.max(...g.map(p=>p.maxY)),M=this.getColumnXBounds(w,e,i.length,g);let m=[...h];for(let p=0;p<10;p++){const B=[v,...m.map(C=>C.intercept).sort((C,V)=>C-V),x],u=[];for(let C=0;C<B.length-1;C++)u.push(B[C+1]-B[C]);if(u.length<=1)break;const f=this.calculateRatio(u);if(f<=this.MAX_SIZE_RATIO)break;let z=null,k=f,S=0,A=-1;const b=u.indexOf(Math.max(...u)),I=(B[b]+B[b+1])/2;if(!this.wouldSplitProtectedGroup(I,"y",n,r)){const C=[...u],V=u[b]/2;C.splice(b,1,V,V);const y=this.calculateRatio(C);y<k&&(k=y,z="split",S=I)}if(m.length>0){const C=u.indexOf(Math.min(...u));if(C>0){const V=[...u];V[C-1]+=V[C],V.splice(C,1);const y=this.calculateRatio(V);y<k&&(k=y,z="merge",A=C-1)}if(C<u.length-1){const V=[...u];V[C]+=V[C+1],V.splice(C+1,1);const y=this.calculateRatio(V);y<k&&(k=y,z="merge",A=C)}}if("split"===z)m.push({slope:0,intercept:S,start:M.minX-10,end:M.maxX+10}),m.sort((V,y)=>V.intercept-y.intercept);else{if(!("merge"===z&&A>=0&&A<m.length))break;{const C=[...m].sort((V,y)=>V.intercept-y.intercept);C.splice(A,1),m=C}}}return m})}enforceColumnsNotExceedRows(o,i,n,e,r,d){let w=[...o],c=[...i];for(let g=0;g<10&&!(w.length+1<=Math.max(...c.map(u=>u.length+1),1)||0===w.length);g++){const M=[...w].sort((u,f)=>u.intercept-f.intercept),m=[r.minX,...M.map(u=>u.intercept),r.maxX];let p=0,L=1/0;for(let u=0;u<M.length;u++){const k=m[u+1]-m[u]+(m[u+2]-m[u+1]);k<L&&(L=k,p=u)}M.splice(p,1),w=M;const B=this.assignStrokesToColumns(n,w);c=this.findAllRowDividers(B,n,w,e,d),c=this.enforceRowUniformity(c,B,n,w,d)}return{columnDividers:w,rowDividers:c}}static#s=l=()=>(this.\u0275fac=function(i){return new(i||s)},this.\u0275prov=H.jDH({token:s,factory:s.\u0275fac,providedIn:"root"}))}return l(),s})(),l1=(()=>{var l;class s{constructor(){this.USER_ID_KEY="mojidoodle_collection_user_id",this.WORKER_URL="https://mojidoodle.lexa.digital/collect"}getUserId(){let o=localStorage.getItem(this.USER_ID_KEY);return o||(o=this.generateUUID(),localStorage.setItem(this.USER_ID_KEY,o)),o}exportSample(o){var i=this;return(0,_.A)(function*(){const n=i.buildSample(o);try{yield i.sendToWorker(n)}catch(e){console.error("Failed to send to worker:",e)}})()}sendToWorker(o){var i=this;return(0,_.A)(function*(){const n=yield fetch(i.WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!n.ok)throw new Error(`Worker returned ${n.status}: ${n.statusText}`);const e=yield n.json();console.log("Sample sent to worker:",e)})()}buildSample(o){const{strokes:i,canvasWidth:n,canvasHeight:e,segmentationResult:r,sortedCells:d,answers:h,recognitionResults:w,success:c,cardId:g,lassos:v}=o;let x=null;r&&(x={columnDividers:r.grid.columnDividers,rowDividers:r.grid.rowDividers});let M=null;c&&(M=this.inferGroundTruth(i,d,h));let m=null;return v&&v.length>0&&(m=v.map(p=>({points:p.points,strokeIndices:this.findStrokesInLasso(i,p.points)}))),{strokes:i,canvasWidth:n,canvasHeight:e,segmentation:x,selectionLassos:m,answers:h,recognitionResults:w,groundTruth:M,success:c,id:this.generateUUID(),userId:this.getUserId(),cardId:g,timestamp:Date.now()}}findStrokesInLasso(o,i){const n=[];for(let e=0;e<o.length;e++){const r=o[e];if(0===r.length)continue;let d=0;for(const w of r)this.isPointInPolygon(w,i)&&d++;d/r.length>=.5&&n.push(e)}return n}isPointInPolygon(o,i){if(i.length<3)return!1;let n=!1;for(let e=0,r=i.length-1;e<i.length;r=e++){const d=i[e].x,h=i[e].y,c=i[r].y;h>o.y!=c>o.y&&o.x<(i[r].x-d)*(o.y-h)/(c-h)+d&&(n=!n)}return n}inferGroundTruth(o,i,n){const r=[...n[0].replace(/\s+/g,"")];return i.length<=1?[{strokeIndices:o.map((d,h)=>h),character:r[0]||""}]:i.map((d,h)=>({strokeIndices:d.strokeIndices,character:r[h]||""}))}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const i=16*Math.random()|0;return("x"===o?i:3&i|8).toString(16)})}static#s=l=()=>(this.\u0275fac=function(i){return new(i||s)},this.\u0275prov=H.jDH({token:s,factory:s.\u0275fac,providedIn:"root"}))}return l(),s})();var W;const c1=["canvas"];function e1(l,s){1&l&&t.nrm(0,"canvas",12,0)}function r1(l,s){if(1&l){const a=t.RV6();t.j41(0,"ion-button",13),t.bIt("click",function(){H.eBV(a);const i=t.XpG();return H.Njj(i.onUndo())}),t.nrm(1,"ion-icon",14),t.k0s()}}function v1(l,s){if(1&l){const a=t.RV6();t.j41(0,"div",15)(1,"ion-button",16),t.bIt("click",function(){H.eBV(a);const i=t.XpG();return H.Njj(i.onClearAll())}),t.nrm(2,"ion-icon",17),t.k0s(),t.j41(3,"ion-button",16),t.bIt("click",function(){H.eBV(a);const i=t.XpG();return H.Njj(i.setDrawMode("brush"))}),t.nrm(4,"ion-icon",18),t.k0s(),t.j41(5,"ion-button",16),t.bIt("click",function(){H.eBV(a);const i=t.XpG();return H.Njj(i.setDrawMode("lasso"))}),t.nrm(6,"ion-icon",19),t.k0s()()}if(2&l){const a=t.XpG();t.R7$(3),t.AVh("active","brush"===a.drawMode),t.R7$(2),t.AVh("active","lasso"===a.drawMode)}}function g1(l,s){1&l&&(t.j41(0,"div",20)(1,"div",21),t.EFF(2,"\u304a\u3081\u3067\u3068\u3046\u{1f973}"),t.k0s(),t.j41(3,"div",22),t.EFF(4,"You're all caught up. Come back again soon for more lessons!"),t.k0s()())}function h1(l,s){1&l&&t.nrm(0,"ion-spinner",26)}function w1(l,s){if(1&l&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&l){const a=t.XpG(2);t.R7$(),t.JRh(a.checkButtonText)}}function d1(l,s){if(1&l){const a=t.RV6();t.j41(0,"ion-button",23),t.bIt("click",function(){H.eBV(a);const i=t.XpG();return H.Njj(i.onCheck())}),t.DNE(1,h1,1,0,"ion-spinner",24)(2,w1,2,1,"span",25),t.k0s()}if(2&l){const a=t.XpG();t.Y8G("disabled",a.isChecking),t.R7$(),t.Y8G("ngIf",a.isChecking),t.R7$(),t.Y8G("ngIf",!a.isChecking)}}function m1(l,s){1&l&&(t.j41(0,"span"),t.EFF(1,"\u25ef"),t.k0s())}function p1(l,s){1&l&&(t.j41(0,"span"),t.EFF(1,"\uff1f"),t.k0s())}function x1(l,s){1&l&&(t.j41(0,"span"),t.EFF(1,"\u2715"),t.k0s())}function u1(l,s){if(1&l&&(t.j41(0,"div",39)(1,"span",40),t.EFF(2),t.k0s()()),2&l){const a=s.$implicit;t.R7$(2),t.JRh(a.character)}}function M1(l,s){if(1&l&&(t.j41(0,"div",35)(1,"div",36),t.EFF(2,"Recognized:"),t.k0s(),t.j41(3,"div",37),t.DNE(4,u1,3,1,"div",38),t.k0s()()),2&l){const a=t.XpG(2);t.R7$(4),t.Y8G("ngForOf",a.displayMatches)}}function f1(l,s){if(1&l&&(t.j41(0,"div",41)(1,"div",42),t.EFF(2,"Answer:"),t.k0s(),t.j41(3,"div",43),t.EFF(4),t.k0s()()),2&l){const a=t.XpG(2);t.R7$(4),t.JRh(a.correctAnswer)}}function z1(l,s){if(1&l){const a=t.RV6();t.j41(0,"div",27),t.bIt("click",function(){H.eBV(a);const i=t.XpG();return H.Njj(i.dismissResults())}),t.j41(1,"div",28),t.bIt("click",function(i){return H.eBV(a),H.Njj(i.stopPropagation())}),t.j41(2,"div",29),t.DNE(3,m1,2,0,"span",25)(4,p1,2,0,"span",25)(5,x1,2,0,"span",25),t.k0s(),t.j41(6,"div",30),t.EFF(7),t.k0s(),t.j41(8,"div",31),t.EFF(9),t.k0s(),t.DNE(10,M1,5,1,"div",32)(11,f1,5,1,"div",33),t.j41(12,"ion-button",34),t.bIt("click",function(){H.eBV(a);const i=t.XpG();return H.Njj(i.dismissResults())}),t.EFF(13),t.k0s()()()}if(2&l){const a=t.XpG();t.R7$(),t.HbH(a.resultStatus),t.R7$(2),t.Y8G("ngIf","correct"===a.resultStatus),t.R7$(),t.Y8G("ngIf","befuddled"===a.resultStatus),t.R7$(),t.Y8G("ngIf","wrong"===a.resultStatus),t.R7$(2),t.JRh(a.resultFeedback),t.R7$(2),t.JRh(a.strokeCountInfo),t.R7$(),t.Y8G("ngIf",a.displayMatches.length>0),t.R7$(),t.Y8G("ngIf","wrong"===a.resultStatus&&a.correctAnswer),t.R7$(2),t.JRh(a.dismissButtonText)}}class j{getLassoColor(s,a=.7){return`hsla(${this.LASSO_HUES[s%this.LASSO_HUES.length]}, 55%, 78%, ${a})`}kanaMatch(s,a){if(s===a||j.CHOON_EQUIVALENTS.has(s)&&j.CHOON_EQUIVALENTS.has(a)||j.WAVE_DASH_EQUIVALENTS.has(s)&&j.WAVE_DASH_EQUIVALENTS.has(a))return!0;const o=j.SMALL_TO_BIG_KANA[s];if(o&&o===a)return!0;const i=j.SMALL_TO_BIG_KANA[a];return!!(i&&i===s||o&&i&&o===i)}constructor(s,a,o,i){var l;this.strokeRecognition=s,this.cardsService=a,this.segmentationService=o,this.collectionService=i,this.isDrawing=!1,this.strokes=[],this.currentStroke=[],this.drawStartTime=0,this.currentCharacter="",this.promptText="",this.promptColor="#FFFFFF",this.noCardsAvailable=!1,this.isChecking=!1,this.showResults=!1,this.resultStatus="",this.resultFeedback="",this.strokeCountInfo="",this.topMatches=[],this.displayMatches=[],this.correctAnswer="",this.cardAvailabilitySubscription=null,this.segmentationTimer=null,this.segmentationResult=null,this.SEGMENTATION_DELAY_MS=500,this.lastBatchResults=[],this.lastSortedCells=[],this.drawMode="brush",this.lassos=[],this.currentLasso=[],this.lassoStartPos=null,this.LASSO_HUES=[0,165,330,135,300,105,270,75,240,45,210,15,180,345,150,315,120,285,90,255,60,225,30,195],this.correctFeedback=["\u6b63\u89e3!","\u307e\u308b!","\u306f\u306a\u307e\u308b!","\u3088\u304f\u3084\u3063\u305f!","\u3059\u3054\u3044!","\u304b\u3093\u307a\u304d!","\u3070\u3063\u3061\u308a!","\u305d\u306e\u8abf\u5b50!"],this.wrongFeedback=["\u3061\u304c\u3046!","\u3056\u3093\u306d\u3093!","\u306f\u305a\u308c!","\u3075\u305b\u3044\u304b\u3044!","\u30d0\u30c4!"],this.checkButtonLabels=["\u3088\u3057!","\u5224\u5b9a!","\u3067\u304d\u305f!","\u3044\u3056!","\u78ba\u8a8d"],this.dismissButtonLabels=["\u6b21!","\u3064\u304e!","\u3088\u3057!","\u30aa\u30c3\u30b1\u30fc!","\u306f\u3044!","\u4e86\u89e3!","\u3044\u304f\u305e!"],this.checkButtonText="",this.dismissButtonText="",this.minBrushSize=3,this.maxBrushSize=24,this.brushSmoothing=.05,this.lastBrushSize=0,l={backspace:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M403.13 96H156.87a44.9 44.9 0 00-33.68 15.27 15.88 15.88 0 00-1.91 2.7L32 247.75a16 16 0 000 16.5l89.15 133.57a16.24 16.24 0 002 2.88 44.89 44.89 0 0033.7 15.3h246.28A44.92 44.92 0 00448 371.13V140.87A44.92 44.92 0 00403.13 96zM348 311a16 16 0 11-22.63 22.62L271.67 280 218 333.65A16 16 0 01195.35 311L249 257.33l-53.69-53.69A16 16 0 01218 181l53.69 53.7 53.67-53.7A16 16 0 01348 203.64l-53.7 53.69z'/></svg>",trashOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/><path stroke-linecap='round' stroke-miterlimit='10' d='M80 112h352' class='ionicon-stroke-width'/><path d='M192 112V72h0a23.93 23.93 0 0124-24h80a23.93 23.93 0 0124 24h0v40M256 176v224M184 176l8 224M328 176l-8 224' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",brushOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M452.37 59.63h0a40.49 40.49 0 00-57.26 0L184 294.74c23.08 4.7 46.12 27.29 49.26 49.26l219.11-227.11a40.49 40.49 0 000-57.26zM138 336c-29.88 0-54 24.5-54 54.86 0 23.95-20.88 36.57-36 36.57C64.56 449.74 92.82 464 120 464c39.78 0 72-32.73 72-73.14 0-30.36-24.12-54.86-54-54.86z' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",ellipseOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><circle cx='256' cy='256' r='192' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>"},Object.keys(l).forEach(function(s){X(s,l[s]);var a=s.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();s!==a&&X(a,l[s])})}ngOnInit(){var s=this;return(0,_.A)(function*(){s.checkButtonText=s.randomFrom(s.checkButtonLabels),yield s.cardsService.initialize(),s.loadRandomCard(),s.cardAvailabilitySubscription=s.cardsService.cardAvailability$.subscribe(a=>{s.noCardsAvailable&&a>0&&s.loadRandomCard()})})()}loadRandomCard(){this.currentCard=this.cardsService.getRandomUnlockedCard(),this.currentCard?(this.currentCharacter=this.currentCard.answers[0],this.promptText=this.currentCard.prompt,this.promptColor=this.cardsService.getStageColor(this.currentCard.stage),this.noCardsAvailable=!1):(this.noCardsAvailable=!0,this.promptText="",this.promptColor="#FFFFFF")}ngAfterViewInit(){setTimeout(()=>this.setupCanvas(),100)}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.cardAvailabilitySubscription&&this.cardAvailabilitySubscription.unsubscribe(),this.cancelSegmentation()}setupCanvas(){const s=this.canvasRef.nativeElement,a=s.parentElement;a&&(this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(a),this.ctx=s.getContext("2d"),this.setCanvasStyle(),s.addEventListener("mousedown",this.handleMouseDown.bind(this)),s.addEventListener("mousemove",this.handleMouseMove.bind(this)),s.addEventListener("mouseup",this.handleMouseUp.bind(this)),s.addEventListener("mouseleave",this.handleMouseUp.bind(this)),s.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),s.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),s.addEventListener("touchend",this.handleTouchEnd.bind(this)))}resizeCanvas(){const s=this.canvasRef.nativeElement,a=s.parentElement;a&&(s.width=a.clientWidth,s.height=a.clientHeight,this.ctx&&this.setCanvasStyle())}setCanvasStyle(){this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff",this.ctx.lineCap="round",this.ctx.lineJoin="round"}handleMouseDown(s){this.cancelSegmentation(),this.isDrawing=!0;const a=this.getMousePos(s);"lasso"===this.drawMode?(this.lassoStartPos={x:a.x,y:a.y},this.currentLasso=[{x:a.x,y:a.y}]):(this.currentStroke=[a],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(a.x,a.y,1.5*this.minBrushSize))}handleMouseMove(s){if(!this.isDrawing)return;const a=this.getMousePos(s);if("lasso"===this.drawMode)this.currentLasso.push({x:a.x,y:a.y}),this.fullRedraw();else{const o=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(a),this.drawBrushSegment(o,a)}}handleMouseUp(){this.isDrawing&&("lasso"===this.drawMode?(this.lassoStartPos&&this.currentLasso.length>0&&(this.currentLasso.length>=5?this.completeLasso():(this.handleLassoTap(this.lassoStartPos.x,this.lassoStartPos.y),this.currentLasso=[])),this.lassoStartPos=null):this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1)}handleTouchStart(s){s.preventDefault(),this.cancelSegmentation(),this.isDrawing=!0;const a=this.getTouchPos(s);"lasso"===this.drawMode?(this.lassoStartPos={x:a.x,y:a.y},this.currentLasso=[{x:a.x,y:a.y}]):(this.currentStroke=[a],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(a.x,a.y,1.5*this.minBrushSize))}handleTouchMove(s){if(!this.isDrawing)return;s.preventDefault();const a=this.getTouchPos(s);if("lasso"===this.drawMode)this.currentLasso.push({x:a.x,y:a.y}),this.fullRedraw();else{const o=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(a),this.drawBrushSegment(o,a)}}handleTouchEnd(){this.isDrawing&&("lasso"===this.drawMode?(this.lassoStartPos&&this.currentLasso.length>0&&(this.currentLasso.length>=5?this.completeLasso():(this.handleLassoTap(this.lassoStartPos.x,this.lassoStartPos.y),this.currentLasso=[])),this.lassoStartPos=null):this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1)}getMousePos(s){const a=this.canvasRef.nativeElement,o=a.getBoundingClientRect(),i=a.width/o.width,n=a.height/o.height,e=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=e),{x:(s.clientX-o.left)*i,y:(s.clientY-o.top)*n,t:e-this.drawStartTime}}getTouchPos(s){const a=this.canvasRef.nativeElement,o=a.getBoundingClientRect(),i=a.width/o.width,n=a.height/o.height,e=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=e),{x:(s.touches[0].clientX-o.left)*i,y:(s.touches[0].clientY-o.top)*n,t:e-this.drawStartTime}}calculateBrushSize(s,a){const o=a.x-s.x,i=a.y-s.y,n=Math.max(a.t-s.t,1),r=Math.sqrt(o*o+i*i)/n,d=Math.min(r/1.5,1),w=this.lastBrushSize+(this.maxBrushSize-d*(this.maxBrushSize-this.minBrushSize)-this.lastBrushSize)*this.brushSmoothing;return this.lastBrushSize=w,w}drawBrushPoint(s,a,o){this.ctx.beginPath(),this.ctx.arc(s,a,o/2,0,2*Math.PI),this.ctx.fill()}drawBrushSegment(s,a){const o=this.calculateBrushSize(s,a);this.ctx.lineWidth=o,this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(a.x,a.y),this.ctx.stroke(),this.drawBrushPoint(a.x,a.y,o)}drawHarai(s){if(s.length<3)return;const a=Math.min(5,s.length),o=s.slice(-a),i=o[o.length-1],n=o[0],e=i.x-n.x,r=i.y-n.y,d=Math.sqrt(e*e+r*r);if(d<5)return;const h=e/d,w=r/d,c=Math.max(i.t-n.t,1),v=Math.min(d/c*20,40);if(v<8)return;const M=this.lastBrushSize;for(let m=0;m<8;m++){const L=(m+1)/8,B=1-Math.pow(1-m/8,2),u=1-Math.pow(1-L,2),f=i.x+h*v*B,z=i.y+w*v*B,k=i.x+h*v*u,S=i.y+w*v*u,A=M*(1-L);A>.5&&(this.ctx.lineWidth=A,this.ctx.beginPath(),this.ctx.moveTo(f,z),this.ctx.lineTo(k,S),this.ctx.stroke())}}onCheck(){var s=this;return(0,_.A)(function*(){if(0!==s.strokes.length&&s.currentCard){s.isChecking=!0;try{const a=s.canvasRef.nativeElement,o=Math.max(...s.currentCard.answers.map(h=>[...h.replace(/\s+/g,"")].length));if(s.lastSortedCells=[],o>1){s.segmentationResult||(s.segmentationResult=s.segmentationService.segment(s.strokes,a.width,a.height,s.getProtectedGroups()));const w=s.segmentationResult.grid.cells.filter(c=>c.strokeIndices.length>0);s.lastSortedCells=[...w].sort((c,g)=>c.column!==g.column?c.column-g.column:c.row-g.row)}let i;if(s.lastSortedCells.length<=1)s.lastBatchResults=[],i=yield s.strokeRecognition.recognize(s.strokes,a.width,a.height);else{const h=s.lastSortedCells.map(g=>({strokes:g.strokeIndices.map(m=>s.strokes[m]),bounds:{width:g.bounds.maxX-g.bounds.minX,height:g.bounds.maxY-g.bounds.minY}})),w=yield s.strokeRecognition.recognizeBatch(h);s.lastBatchResults=w,i=[{character:w.map(g=>g[0]?.character||"?").join(""),score:100}],console.log("Cell interpretations (Japanese reading order):",w.map((g,v)=>({cell:v,position:`col ${s.lastSortedCells[v].column}, row ${s.lastSortedCells[v].row}`,top5:g.slice(0,5).map(x=>x.character)})))}s.topMatches=i.slice(0,5);const n=s.currentCard.answers.map(h=>h.replace(/\s+/g,""));let e=!1,r="";if(s.lastBatchResults.length>0){for(const h of n){const w=[...h];if(w.length===s.lastBatchResults.length&&w.every((g,v)=>{const x=s.lastBatchResults[v].slice(0,5).map(m=>m.character),M=x.some(m=>s.kanaMatch(g,m));return console.log(`  Cell ${v}: target='${g}' (code=${g.charCodeAt(0)}), candidates=[${x.map(m=>`'${m}'(${m.charCodeAt(0)})`).join(", ")}], matched=${M}`),M})){e=!0,r=h;break}}console.log("Grading multi-char:",{targets:n,cellResults:s.lastBatchResults.map(h=>h.slice(0,5).map(w=>w.character)),isCorrect:e,matchedAnswer:r})}else{const h=s.topMatches.map(w=>w.character);for(const w of n)if(h.some(c=>s.kanaMatch(w,c))){e=!0,r=w;break}}if(e)s.resultStatus="correct",s.resultFeedback=s.randomFrom(s.correctFeedback),s.displayMatches=[{character:r,score:1}],s.correctAnswer="",s.cardsService.advanceCard(s.currentCard.id);else{let h;if(s.lastBatchResults.length>0)console.log("Checking befuddlers:",s.currentCard.befuddlers.map(w=>({answers:w.answers,toast:w.toast.slice(0,30)}))),h=s.currentCard.befuddlers.find(w=>(console.log("  Befuddler answers:",w.answers),w.answers.some(c=>{const g=[...c.replace(/\s+/g,"")];if(console.log(`    Checking "${c}": ${g.length} chars vs ${s.lastBatchResults.length} cells`),g.length!==s.lastBatchResults.length)return!1;const v=g.every((x,M)=>{const m=s.lastBatchResults[M].slice(0,5).map(L=>L.character),p=m.some(L=>s.kanaMatch(x,L));return console.log(`      Cell ${M}: '${x}' vs [${m.join(",")}] = ${p}`),p});return console.log(`    Result: ${v}`),v})));else{const w=s.topMatches.map(c=>c.character);h=s.currentCard.befuddlers.find(c=>c.answers.some(g=>w.some(v=>s.kanaMatch(g.replace(/\s+/g,""),v))))}h?(s.resultStatus="befuddled",s.resultFeedback=h.toast,s.displayMatches=s.topMatches,s.correctAnswer=""):(s.resultStatus="wrong",s.resultFeedback=s.randomFrom(s.wrongFeedback),s.displayMatches=s.topMatches,s.correctAnswer=s.currentCard.answers[0])}const d=s.strokeRecognition.getExpectedStrokeCount(s.currentCharacter);s.strokeCountInfo=`Strokes: ${s.strokes.length}/${d}`,s.exportCollectionSample(e)}catch(a){console.error("Recognition error:",a),s.resultStatus="wrong",s.resultFeedback=a.message||"Recognition failed. Please try on a device.",s.topMatches=[],s.displayMatches=[],s.strokeCountInfo=""}s.isChecking=!1,s.checkButtonText=s.randomFrom(s.checkButtonLabels),s.dismissButtonText=s.randomFrom(s.dismissButtonLabels),s.showResults=!0}})()}dismissResults(){this.showResults=!1,this.clearCanvas(),("correct"===this.resultStatus||"wrong"===this.resultStatus)&&this.loadRandomCard()}onUndo(){this.strokes.length>0&&(this.strokes.pop(),this.fullRedraw(),this.scheduleSegmentation())}clearCanvas(){const s=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,s.width,s.height),this.strokes=[],this.lassos=[],this.currentLasso=[],this.drawStartTime=0,this.drawMode="brush",this.cancelSegmentation(),this.segmentationResult=null}randomFrom(s){return s[Math.floor(Math.random()*s.length)]}setDrawMode(s){this.drawMode=s}onClearAll(){this.clearCanvas(),this.lassos=[]}isPointInPolygon(s,a){if(a.length<3)return!1;let o=!1;for(let i=0,n=a.length-1;i<a.length;n=i++){const e=a[i].x,r=a[i].y,h=a[n].y;r>s.y!=h>s.y&&s.x<(a[n].x-e)*(s.y-r)/(h-r)+e&&(o=!o)}return o}calculateLassoContainment(s,a){const o=this.strokes[s];if(!o||0===o.length)return 0;let i=0;for(const n of o)this.isPointInPolygon(n,a)&&i++;return i/o.length}getProtectedGroups(){const s=[];for(const a of this.lassos){const o=[];for(let i=0;i<this.strokes.length;i++)this.calculateLassoContainment(i,a.points)>=.5&&o.push(i);o.length>0&&s.push({strokeIndices:o})}return s}findStrokesInLasso(s){const a=[];for(let o=0;o<this.strokes.length;o++)this.calculateLassoContainment(o,s)>=.5&&a.push(o);return a}getStrokeColor(s){let a=-1,o=0;for(let i=0;i<this.lassos.length;i++){const n=this.calculateLassoContainment(s,this.lassos[i].points);n>o&&(o=n,a=i)}return a>=0&&o>=.5?this.getLassoColor(a,1):"#fff"}handleLassoTap(s,a){for(let o=this.lassos.length-1;o>=0;o--)if(this.isPointInPolygon({x:s,y:a},this.lassos[o].points))return this.lassos.splice(o,1),this.fullRedraw(),this.scheduleSegmentation(),!0;return!1}completeLasso(){this.currentLasso.length<3?this.currentLasso=[]:(this.findStrokesInLasso(this.currentLasso).length>0&&this.lassos.push({points:[...this.currentLasso]}),this.currentLasso=[],this.fullRedraw(),this.scheduleSegmentation())}drawLasso(s,a){if(!(s.length<3)){this.ctx.save(),this.ctx.fillStyle=this.getLassoColor(a,.15),this.ctx.beginPath(),this.ctx.moveTo(s[0].x,s[0].y);for(let o=1;o<s.length;o++)this.ctx.lineTo(s[o].x,s[o].y);this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle=this.getLassoColor(a,.7),this.ctx.lineWidth=2,this.ctx.setLineDash([6,4]),this.ctx.stroke(),this.ctx.restore()}}drawCurrentLasso(){if(!(this.currentLasso.length<2)){this.ctx.save(),this.ctx.strokeStyle=this.getLassoColor(this.lassos.length,.5),this.ctx.lineWidth=2,this.ctx.setLineDash([6,4]),this.ctx.beginPath(),this.ctx.moveTo(this.currentLasso[0].x,this.currentLasso[0].y);for(let s=1;s<this.currentLasso.length;s++)this.ctx.lineTo(this.currentLasso[s].x,this.currentLasso[s].y);this.ctx.stroke(),this.ctx.restore()}}drawStrokeWithColor(s,a){if(0!==s.length){this.ctx.save(),this.ctx.fillStyle=a,this.ctx.strokeStyle=a,this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.ctx.beginPath(),this.ctx.arc(s[0].x,s[0].y,1.5*this.minBrushSize/2,0,2*Math.PI),this.ctx.fill();for(let o=1;o<s.length;o++){const i=this.calculateBrushSize(s[o-1],s[o]);this.ctx.lineWidth=i,this.ctx.beginPath(),this.ctx.moveTo(s[o-1].x,s[o-1].y),this.ctx.lineTo(s[o].x,s[o].y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(s[o].x,s[o].y,i/2,0,2*Math.PI),this.ctx.fill()}if(s.length>=3){const o=Math.min(5,s.length),i=s.slice(-o),n=i[i.length-1],e=i[0],r=n.x-e.x,d=n.y-e.y,h=Math.sqrt(r*r+d*d);if(h>=5){const w=r/h,c=d/h,g=Math.max(n.t-e.t,1),x=Math.min(h/g*20,40);if(x>=8){const m=this.lastBrushSize;for(let p=0;p<8;p++){const B=(p+1)/8,u=1-Math.pow(1-p/8,2),f=1-Math.pow(1-B,2),z=n.x+w*x*u,k=n.y+c*x*u,S=n.x+w*x*f,A=n.y+c*x*f,b=m*(1-B);b>.5&&(this.ctx.lineWidth=b,this.ctx.beginPath(),this.ctx.moveTo(z,k),this.ctx.lineTo(S,A),this.ctx.stroke())}}}}this.ctx.restore()}}fullRedraw(){const s=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,s.width,s.height);for(let a=0;a<this.lassos.length;a++)this.drawLasso(this.lassos[a].points,a);this.currentLasso.length>1&&this.drawCurrentLasso();for(let a=0;a<this.strokes.length;a++){const o=this.getStrokeColor(a);this.drawStrokeWithColor(this.strokes[a],o)}if(this.segmentationResult){const a=this.segmentationResult.grid;(a.columnDividers.length>0||a.rowDividers.some(i=>i.length>0))&&this.drawDividers(a)}}scheduleSegmentation(){this.cancelSegmentation(),0!==this.strokes.length?this.segmentationTimer=setTimeout(()=>{this.analyzeAndVisualize()},this.SEGMENTATION_DELAY_MS):this.segmentationResult=null}cancelSegmentation(){null!==this.segmentationTimer&&(clearTimeout(this.segmentationTimer),this.segmentationTimer=null)}analyzeAndVisualize(){if(0===this.strokes.length)return void(this.segmentationResult=null);if(this.currentCard&&Math.max(...this.currentCard.answers.map(o=>[...o.replace(/\s+/g,"")].length))<=1)return this.segmentationResult=null,void this.fullRedraw();const s=this.canvasRef.nativeElement;this.segmentationResult=this.segmentationService.segment(this.strokes,s.width,s.height,this.getProtectedGroups()),this.redrawWithBoundaries()}redrawWithBoundaries(){this.fullRedraw()}drawDividers(s){this.ctx.save(),this.ctx.strokeStyle="rgba(128, 128, 128, 0.8)",this.ctx.lineWidth=2,this.ctx.setLineDash([4,4]);for(const a of s.columnDividers){const o=a.start,i=a.end,n=a.slope*o+a.intercept,e=a.slope*i+a.intercept;this.ctx.beginPath(),this.ctx.moveTo(n,o),this.ctx.lineTo(e,i),this.ctx.stroke()}for(const a of s.rowDividers)for(const o of a){const i=o.start,n=o.end,e=o.slope*i+o.intercept,r=o.slope*n+o.intercept;this.ctx.beginPath(),this.ctx.moveTo(i,e),this.ctx.lineTo(n,r),this.ctx.stroke()}this.ctx.restore()}exportCollectionSample(s){if(!this.currentCard)return;const a=this.canvasRef.nativeElement;let o=null;this.lastBatchResults.length>0?o=this.lastBatchResults:this.topMatches.length>0&&(o=[this.topMatches]),this.collectionService.exportSample({strokes:this.strokes,canvasWidth:a.width,canvasHeight:a.height,segmentationResult:this.segmentationResult,sortedCells:this.lastSortedCells,answers:this.currentCard.answers,recognitionResults:o,success:s,cardId:this.currentCard.id,lassos:this.lassos.length>0?this.lassos:void 0})}static#s=W=()=>(this.SMALL_TO_BIG_KANA={\u3063:"\u3064",\u3083:"\u3084",\u3085:"\u3086",\u3087:"\u3088",\u3041:"\u3042",\u3043:"\u3044",\u3045:"\u3046",\u3047:"\u3048",\u3049:"\u304a",\u308e:"\u308f",\u30c3:"\u30c4",\u30e3:"\u30e4",\u30e5:"\u30e6",\u30e7:"\u30e8",\u30a1:"\u30a2",\u30a3:"\u30a4",\u30a5:"\u30a6",\u30a7:"\u30a8",\u30a9:"\u30aa",\u30ee:"\u30ef"},this.CHOON_EQUIVALENTS=new Set(["\u30fc","|","\uff5c"]),this.WAVE_DASH_EQUIVALENTS=new Set(["\u301c","~","\uff5e"]),this.\u0275fac=function(a){return new(a||j)(t.rXU(t1),t.rXU(N.D),t.rXU(n1),t.rXU(l1))},this.\u0275cmp=t.VBU({type:j,selectors:[["app-workbook"]],viewQuery:function(a,o){if(1&a&&t.GBs(c1,5),2&a){let i;t.mGM(i=t.lsd())&&(o.canvasRef=i.first)}},decls:12,vars:11,consts:[["canvas",""],[1,"workbook-content",3,"fullscreen","scrollY"],[1,"prompt-bar"],["color","light"],[1,"prompt-text"],[1,"canvas-wrapper"],["class","drawing-canvas",4,"ngIf"],["class","undo-btn","fill","clear",3,"click",4,"ngIf"],["class","tool-bar",4,"ngIf"],["class","caught-up-box",4,"ngIf"],["class","check-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","results-overlay",3,"click",4,"ngIf"],[1,"drawing-canvas"],["fill","clear",1,"undo-btn",3,"click"],["name","backspace"],[1,"tool-bar"],["fill","clear",1,"tool-btn",3,"click"],["name","trash-outline"],["name","brush-outline"],["name","ellipse-outline"],[1,"caught-up-box"],[1,"caught-up-title"],[1,"caught-up-message"],["color","primary",1,"check-btn",3,"click","disabled"],["name","crescent",4,"ngIf"],[4,"ngIf"],["name","crescent"],[1,"results-overlay",3,"click"],[1,"results-card",3,"click"],[1,"status-display"],[1,"feedback"],[1,"stroke-info"],["class","matches-section",4,"ngIf"],["class","correct-answer-section",4,"ngIf"],["expand","block",3,"click"],[1,"matches-section"],[1,"matches-title"],[1,"matches-list"],["class","match-item",4,"ngFor","ngForOf"],[1,"match-item"],[1,"match-char"],[1,"correct-answer-section"],[1,"correct-answer-title"],[1,"correct-answer"]],template:function(a,o){1&a&&(t.j41(0,"ion-content",1)(1,"div",2),t.nrm(2,"ion-menu-button",3),t.j41(3,"span",4),t.EFF(4),t.k0s()(),t.j41(5,"div",5),t.DNE(6,e1,2,0,"canvas",6)(7,r1,2,0,"ion-button",7)(8,v1,7,4,"div",8)(9,g1,5,0,"div",9),t.k0s(),t.DNE(10,d1,3,3,"ion-button",10)(11,z1,14,10,"div",11),t.k0s()),2&a&&(t.Y8G("fullscreen",!0)("scrollY",!1),t.R7$(3),t.xc7("color",o.promptColor),t.R7$(),t.JRh(o.promptText),t.R7$(2),t.Y8G("ngIf",!o.noCardsAvailable),t.R7$(),t.Y8G("ngIf",!o.noCardsAvailable),t.R7$(),t.Y8G("ngIf",!o.noCardsAvailable),t.R7$(),t.Y8G("ngIf",o.noCardsAvailable),t.R7$(),t.Y8G("ngIf",!o.noCardsAvailable),t.R7$(),t.Y8G("ngIf",o.showResults))},dependencies:[R.W9,R.MC,R.Jm,R.iq,R.w2,q.MD,q.Sq,q.bT],styles:[".workbook-content[_ngcontent-%COMP%]{--background: #000}.prompt-bar[_ngcontent-%COMP%]{display:flex;align-items:center;height:144px;background:#111;padding:0 8px}.prompt-text[_ngcontent-%COMP%]{flex:1;text-align:center;font-size:24px;color:#fff;margin-right:40px;white-space:pre-line}.canvas-wrapper[_ngcontent-%COMP%]{position:absolute;inset:144px 0 0;background:#000}.drawing-canvas[_ngcontent-%COMP%]{width:100%;height:100%;touch-action:none;display:block}.undo-btn[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:24px}.tool-bar[_ngcontent-%COMP%]{position:absolute;top:56px;right:8px;display:flex;flex-direction:column;gap:4px}.tool-btn[_ngcontent-%COMP%]{--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:20px}.tool-btn.active[_ngcontent-%COMP%]{--color: #fff;background:#ffffff1a;border-radius:8px}.results-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000e6;display:flex;align-items:center;justify-content:center;z-index:100}.results-card[_ngcontent-%COMP%]{background:#1a1a1a;border-radius:16px;padding:24px;min-width:280px;max-width:90%;text-align:center}.results-card.correct[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.correct[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#e63946}.results-card.befuddled[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.befuddled[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#f7b731}.results-card.wrong[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.wrong[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#4a90d9}.status-display[_ngcontent-%COMP%]{font-size:64px;font-weight:700;margin-bottom:8px}.feedback[_ngcontent-%COMP%]{font-family:Shippori Mincho B1,serif;font-size:18px;margin-bottom:16px;white-space:pre-line}.stroke-info[_ngcontent-%COMP%]{font-size:14px;color:#888;margin-bottom:20px}.matches-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.matches-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.matches-list[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:16px}.match-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.match-char[_ngcontent-%COMP%]{font-size:32px;color:#fff}.correct-answer-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.correct-answer-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.correct-answer[_ngcontent-%COMP%]{font-size:36px;color:#4a90d9}.check-btn[_ngcontent-%COMP%]{position:absolute;bottom:32px;left:50%;transform:translate(-50%);--background: #222;--background-hover: #333;--color: #fff;--border-radius: 32px;--padding-start: 12vw;--padding-end: 12vw;--padding-top: 16px;--padding-bottom: 16px;min-height:60px;font-family:Shippori Mincho B1,serif;font-size:clamp(20px,5vw,28px);font-weight:600;letter-spacing:2px}.results-card[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{font-family:Shippori Mincho B1,serif;font-weight:700}.caught-up-box[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border-radius:16px;padding:32px;text-align:center;max-width:90%;width:320px}.caught-up-title[_ngcontent-%COMP%]{font-size:36px;margin-bottom:16px}.caught-up-message[_ngcontent-%COMP%]{font-size:16px;color:#ccc;line-height:1.5}"]}))}W();const k1=[{path:"",component:j}];let B1=(()=>{var l;class s{static#s=l=()=>(this.\u0275fac=function(i){return new(i||s)},this.\u0275mod=t.$C({type:s}),this.\u0275inj=H.G2t({imports:[E.iI.forChild(k1),E.iI]}))}return l(),s})(),L1=(()=>{var l;class s{static#s=l=()=>(this.\u0275fac=function(i){return new(i||s)},this.\u0275mod=t.$C({type:s}),this.\u0275inj=H.G2t({imports:[q.MD,$.YN,J.bv,B1,j]}))}return l(),s})()}}]);