"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3572],{3572(k1,$,S){S.d($,{WorkbookPageModule:()=>z1});var F,q=S(2200),J=S(4341),Q=S(7343),I=S(8132),_=S(467),O=S(6299),X=function(n,e){var m=function(){if(typeof window>"u")return new Map;if(!F){var n=window;n.Ionicons=n.Ionicons||{},F=n.Ionicons.map=n.Ionicons.map||new Map}return F}(),o=m.get(n);void 0===o?m.set(n,e):o!==e&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(n,'". Ensure that multiple icons are not mapped to the same icon name.'))},a=S(3664),V=S(2615),U=S(4185);let a1=(()=>{var n;class e{constructor(o){this.cardsService=o,this.API_URL="https://inputtools.google.com/request?itc=ja-t-i0-handwrit&app=translate"}recognize(o,s,i){var t=this;return(0,_.A)(function*(){if(0===o.length)return[];const r=o.map(c=>{const v=[],l=[],h=[];for(const w of c)v.push(Math.round(w.x)),l.push(Math.round(w.y)),h.push(w.t);return[v,l,h]}),g={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:[{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:i,writing_area_width:s},ink:r}]};try{const v=yield(yield fetch(t.API_URL,{method:"POST",body:JSON.stringify(g),headers:{"Content-Type":"application/json"}})).json();return t.parseResponse(v)}catch(c){throw console.error("Recognition failed:",c),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}recognizeBatch(o){var s=this;return(0,_.A)(function*(){if(0===o.length)return[];const i=o.map(r=>{const g=r.strokes.map(c=>{const v=[],l=[],h=[];for(const w of c)v.push(Math.round(w.x)),l.push(Math.round(w.y)),h.push(w.t);return[v,l,h]});return{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:Math.round(r.bounds.height),writing_area_width:Math.round(r.bounds.width)},ink:g}}),t={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:i};try{const g=yield(yield fetch(s.API_URL,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json();return s.parseBatchResponse(g,o.length)}catch(r){throw console.error("Batch recognition failed:",r),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}parseBatchResponse(o,s){if(!o||"SUCCESS"!==o[0])return Array(s).fill([]);const i=[],t=o[1]||[];for(let r=0;r<s;r++){const g=t[r]?.[1];if(!g||0===g.length){i.push([]);continue}const c=g.map(v=>v.replace(/\s+/g,"")).filter(v=>1===[...v].length).map((v,l)=>({character:v,score:Math.max(100-10*l,10)}));i.push(c)}return i}parseResponse(o){if(!o||"SUCCESS"!==o[0])return[];const s=o[1]?.[0]?.[1];return s&&0!==s.length?s.map((i,t)=>({character:i.replace(/\s+/g,""),score:Math.max(100-10*t,10)})):[]}getExpectedStrokeCount(o){return this.cardsService.getStrokeCount(o)}static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)(V.KVO(U.D))},this.\u0275prov=V.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return n(),e})(),i1=(()=>{var n;class e{constructor(){this.config={minColumnGapRatio:.25,maxColumnAngle:10,minRowGapRatio:.25,maxRowAngle:10,charSizeMultiplier:2,minCharSizeRatio:.08,maxCharSizeRatio:.4},this.MAX_SIZE_RATIO=2}segment(o,s,i){if(0===o.length)return this.emptyResult();const t=o.map((k,z)=>this.calculateStrokeBounds(k,z)),r={minX:Math.min(...t.map(k=>k.minX)),maxX:Math.max(...t.map(k=>k.maxX)),minY:Math.min(...t.map(k=>k.minY)),maxY:Math.max(...t.map(k=>k.maxY))},g=this.estimateCharSize(t,s,"width"),c=this.estimateCharSize(t,i,"height");let v=this.findColumnDividers(t,g,i);v=this.enforceColumnUniformity(v,t,r);const l=this.assignStrokesToColumns(t,v);let h=this.findAllRowDividers(l,t,v,c);h=this.enforceRowUniformity(h,l,t,v);const w=this.enforceColumnsNotExceedRows(v,h,t,c,r);v=w.columnDividers,h=w.rowDividers;const d=this.assignStrokesToColumns(t,v),p=this.createCellGrid(d,t,v,h),u=v.length+1,x=Math.max(...h.map(k=>k.length+1),1);return{grid:{columnDividers:v,rowDividers:h,cells:p,columns:u,maxRows:x},estimatedCharHeight:c,estimatedCharWidth:g}}emptyResult(){return{grid:{columnDividers:[],rowDividers:[],cells:[],columns:0,maxRows:0},estimatedCharHeight:0,estimatedCharWidth:0}}calculateStrokeBounds(o,s){if(0===o.length)return{strokeIndex:s,minX:0,maxX:0,minY:0,maxY:0,centerX:0,centerY:0};let i=1/0,t=-1/0,r=1/0,g=-1/0;for(const c of o)i=Math.min(i,c.x),t=Math.max(t,c.x),r=Math.min(r,c.y),g=Math.max(g,c.y);return{strokeIndex:s,minX:i,maxX:t,minY:r,maxY:g,centerX:(i+t)/2,centerY:(r+g)/2}}estimateCharSize(o,s,i){if(0===o.length)return.15*s;const t=o.map(l=>"width"===i?l.maxX-l.minX:l.maxY-l.minY).filter(l=>l>5);if(0===t.length)return.15*s;t.sort((l,h)=>l-h);let g=t[Math.floor(t.length/2)]*this.config.charSizeMultiplier;return Math.max(s*this.config.minCharSizeRatio,Math.min(s*this.config.maxCharSizeRatio,g))}findColumnDividers(o,s,i){if(o.length<2)return[];const t=Math.min(...o.map(l=>l.minY)),r=Math.max(...o.map(l=>l.maxY)),g=[...o].sort((l,h)=>l.centerX-h.centerX),c=[],v=s*this.config.minColumnGapRatio;for(let l=0;l<g.length-1;l++){const d=g[l].maxX,p=g[l+1].minX,u=p-d;u>=v&&c.push({gapStart:d,gapEnd:p,gapSize:u})}return c.map(l=>({slope:0,intercept:(l.gapStart+l.gapEnd)/2,start:t-10,end:r+10}))}assignStrokesToColumns(o,s){const i=s.length+1,t=Array.from({length:i},()=>[]),r=s.map(g=>g.intercept).sort((g,c)=>g-c);for(const g of o){let c=0;for(let l=0;l<r.length;l++)g.centerX>r[l]&&(c=l+1);t[i-1-c].push(g.strokeIndex)}return t}findAllRowDividers(o,s,i,t){return o.map((r,g)=>{if(r.length<2)return[];const c=r.map(l=>s[l]),v=this.getColumnXBounds(g,i,o.length,c);return this.findRowDividers(c,t,v)})}getColumnXBounds(o,s,i,t){if(0===s.length||0===t.length)return{minX:Math.min(...t.map(w=>w.minX)),maxX:Math.max(...t.map(w=>w.maxX))};const r=s.map(w=>w.intercept).sort((w,d)=>w-d),g=i-1-o,c=Math.min(...t.map(w=>w.minX)),v=Math.max(...t.map(w=>w.maxX));return{minX:g>0?r[g-1]:c,maxX:g<r.length?r[g]:v}}findRowDividers(o,s,i){if(o.length<2)return[];const t=[...o].sort((c,v)=>c.centerY-v.centerY),r=[],g=s*this.config.minRowGapRatio;for(let c=0;c<t.length-1;c++){const h=t[c].maxY,w=t[c+1].minY,d=w-h;d>=g&&r.push({gapStart:h,gapEnd:w,gapSize:d})}return r.map(c=>({slope:0,intercept:(c.gapStart+c.gapEnd)/2,start:i.minX-10,end:i.maxX+10}))}createCellGrid(o,s,i,t){const r=[],g=o.length;for(let c=0;c<g;c++){const v=o[c],l=t[c]||[];if(0===v.length)continue;const h=v.map(x=>s[x]),w=Math.min(...h.map(x=>x.minY)),d=Math.max(...h.map(x=>x.maxY)),p=l.map(x=>x.intercept).sort((x,k)=>x-k),u=p.length+1;for(let x=0;x<u;x++){const k=0===x?w-5:p[x-1],z=x===u-1?d+5:p[x],L=v.filter(f=>{const C=s[f];return C.centerY>=k&&C.centerY<=z});if(0===L.length)continue;const H=L.map(f=>s[f]),M={minX:Math.min(...H.map(f=>f.minX)),maxX:Math.max(...H.map(f=>f.maxX)),minY:Math.min(...H.map(f=>f.minY)),maxY:Math.max(...H.map(f=>f.maxY))};r.push({column:c,row:x,strokeIndices:L,bounds:M})}}return r}calculateRatio(o){if(o.length<=1)return 1;const s=Math.min(...o),i=Math.max(...o);return s>0?i/s:1/0}enforceColumnUniformity(o,s,i){if(0===s.length)return o;let r=[...o];for(let g=0;g<10;g++){const c=r.map(M=>M.intercept).sort((M,f)=>M-f),v=[i.minX,...c,i.maxX],l=[];for(let M=0;M<v.length-1;M++)l.push(v[M+1]-v[M]);if(l.length<=1)break;const h=this.calculateRatio(l);if(h<=this.MAX_SIZE_RATIO)break;let w=null,d=h,p=0,u=-1;const x=l.indexOf(Math.max(...l)),k=(v[x]+v[x+1])/2,z=[...l],L=l[x]/2;z.splice(x,1,L,L);const H=this.calculateRatio(z);if(H<d&&(d=H,w="split",p=k),r.length>0){const M=l.indexOf(Math.min(...l));if(M>0){const f=[...l];f[M-1]+=f[M],f.splice(M,1);const C=this.calculateRatio(f);C<d&&(d=C,w="merge",u=M-1)}if(M<l.length-1){const f=[...l];f[M]+=f[M+1],f.splice(M+1,1);const C=this.calculateRatio(f);C<d&&(d=C,w="merge",u=M)}}if("split"===w)r.push({slope:0,intercept:p,start:i.minY-10,end:i.maxY+10}),r.sort((f,C)=>f.intercept-C.intercept);else{if(!("merge"===w&&u>=0&&u<r.length))break;{const M=[...r].sort((f,C)=>f.intercept-C.intercept);M.splice(u,1),r=M}}}return r}enforceRowUniformity(o,s,i,t){return o.map((g,c)=>{const v=s[c];if(0===v.length)return g;const l=v.map(u=>i[u]),h=Math.min(...l.map(u=>u.minY)),w=Math.max(...l.map(u=>u.maxY)),d=this.getColumnXBounds(c,t,s.length,l);let p=[...g];for(let u=0;u<10;u++){const k=[h,...p.map(B=>B.intercept).sort((B,A)=>B-A),w],z=[];for(let B=0;B<k.length-1;B++)z.push(k[B+1]-k[B]);if(z.length<=1)break;const L=this.calculateRatio(z);if(L<=this.MAX_SIZE_RATIO)break;let H=null,M=L,f=0,C=-1;const j=z.indexOf(Math.max(...z)),P=(k[j]+k[j+1])/2,b=[...z],G=z[j]/2;b.splice(j,1,G,G);const N=this.calculateRatio(b);if(N<M&&(M=N,H="split",f=P),p.length>0){const B=z.indexOf(Math.min(...z));if(B>0){const A=[...z];A[B-1]+=A[B],A.splice(B,1);const y=this.calculateRatio(A);y<M&&(M=y,H="merge",C=B-1)}if(B<z.length-1){const A=[...z];A[B]+=A[B+1],A.splice(B+1,1);const y=this.calculateRatio(A);y<M&&(M=y,H="merge",C=B)}}if("split"===H)p.push({slope:0,intercept:f,start:d.minX-10,end:d.maxX+10}),p.sort((A,y)=>A.intercept-y.intercept);else{if(!("merge"===H&&C>=0&&C<p.length))break;{const B=[...p].sort((A,y)=>A.intercept-y.intercept);B.splice(C,1),p=B}}}return p})}enforceColumnsNotExceedRows(o,s,i,t,r){let c=[...o],v=[...s];for(let l=0;l<10&&!(c.length+1<=Math.max(...v.map(z=>z.length+1),1)||0===c.length);l++){const d=[...c].sort((z,L)=>z.intercept-L.intercept),p=[r.minX,...d.map(z=>z.intercept),r.maxX];let u=0,x=1/0;for(let z=0;z<d.length;z++){const M=p[z+1]-p[z]+(p[z+2]-p[z+1]);M<x&&(x=M,u=z)}d.splice(u,1),c=d;const k=this.assignStrokesToColumns(i,c);v=this.findAllRowDividers(k,i,c,t),v=this.enforceRowUniformity(v,k,i,c)}return{columnDividers:c,rowDividers:v}}static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275prov=V.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return n(),e})();const n1=["canvas"];function t1(n,e){1&n&&a.nrm(0,"canvas",11,0)}function l1(n,e){if(1&n){const m=a.RV6();a.j41(0,"ion-button",12),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.onUndo())}),a.nrm(1,"ion-icon",13),a.k0s()}}function c1(n,e){1&n&&(a.j41(0,"div",14)(1,"div",15),a.EFF(2,"\u304a\u3081\u3067\u3068\u3046\u{1f973}"),a.k0s(),a.j41(3,"div",16),a.EFF(4,"You're all caught up. Come back again soon for more lessons!"),a.k0s()())}function e1(n,e){1&n&&a.nrm(0,"ion-spinner",20)}function r1(n,e){if(1&n&&(a.j41(0,"span"),a.EFF(1),a.k0s()),2&n){const m=a.XpG(2);a.R7$(),a.JRh(m.checkButtonText)}}function v1(n,e){if(1&n){const m=a.RV6();a.j41(0,"ion-button",17),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.onCheck())}),a.DNE(1,e1,1,0,"ion-spinner",18)(2,r1,2,1,"span",19),a.k0s()}if(2&n){const m=a.XpG();a.Y8G("disabled",m.isChecking),a.R7$(),a.Y8G("ngIf",m.isChecking),a.R7$(),a.Y8G("ngIf",!m.isChecking)}}function g1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\u25ef"),a.k0s())}function h1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\uff1f"),a.k0s())}function w1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\u2715"),a.k0s())}function d1(n,e){if(1&n&&(a.j41(0,"div",33)(1,"span",34),a.EFF(2),a.k0s()()),2&n){const m=e.$implicit;a.R7$(2),a.JRh(m.character)}}function m1(n,e){if(1&n&&(a.j41(0,"div",29)(1,"div",30),a.EFF(2,"Recognized:"),a.k0s(),a.j41(3,"div",31),a.DNE(4,d1,3,1,"div",32),a.k0s()()),2&n){const m=a.XpG(2);a.R7$(4),a.Y8G("ngForOf",m.displayMatches)}}function p1(n,e){if(1&n&&(a.j41(0,"div",35)(1,"div",36),a.EFF(2,"Answer:"),a.k0s(),a.j41(3,"div",37),a.EFF(4),a.k0s()()),2&n){const m=a.XpG(2);a.R7$(4),a.JRh(m.correctAnswer)}}function x1(n,e){if(1&n){const m=a.RV6();a.j41(0,"div",21),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.dismissResults())}),a.j41(1,"div",22),a.bIt("click",function(s){return V.eBV(m),V.Njj(s.stopPropagation())}),a.j41(2,"div",23),a.DNE(3,g1,2,0,"span",19)(4,h1,2,0,"span",19)(5,w1,2,0,"span",19),a.k0s(),a.j41(6,"div",24),a.EFF(7),a.k0s(),a.j41(8,"div",25),a.EFF(9),a.k0s(),a.DNE(10,m1,5,1,"div",26)(11,p1,5,1,"div",27),a.j41(12,"ion-button",28),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.dismissResults())}),a.EFF(13),a.k0s()()()}if(2&n){const m=a.XpG();a.R7$(),a.HbH(m.resultStatus),a.R7$(2),a.Y8G("ngIf","correct"===m.resultStatus),a.R7$(),a.Y8G("ngIf","befuddled"===m.resultStatus),a.R7$(),a.Y8G("ngIf","wrong"===m.resultStatus),a.R7$(2),a.JRh(m.resultFeedback),a.R7$(2),a.JRh(m.strokeCountInfo),a.R7$(),a.Y8G("ngIf",m.displayMatches.length>0),a.R7$(),a.Y8G("ngIf","wrong"===m.resultStatus&&m.correctAnswer),a.R7$(2),a.JRh(m.dismissButtonText)}}let W=(()=>{var n;class e{kanaMatch(o,s){if(o===s)return!0;const i=e.SMALL_TO_BIG_KANA[o];if(i&&i===s)return!0;const t=e.SMALL_TO_BIG_KANA[s];return!!(t&&t===o||i&&t&&i===t)}constructor(o,s,i){this.strokeRecognition=o,this.cardsService=s,this.segmentationService=i,this.isDrawing=!1,this.strokes=[],this.currentStroke=[],this.drawStartTime=0,this.currentCharacter="",this.promptText="",this.promptColor="#FFFFFF",this.noCardsAvailable=!1,this.isChecking=!1,this.showResults=!1,this.resultStatus="",this.resultFeedback="",this.strokeCountInfo="",this.topMatches=[],this.displayMatches=[],this.correctAnswer="",this.cardAvailabilitySubscription=null,this.segmentationTimer=null,this.segmentationResult=null,this.SEGMENTATION_DELAY_MS=500,this.lastBatchResults=[],this.correctFeedback=["\u6b63\u89e3!","\u307e\u308b!","\u306f\u306a\u307e\u308b!","\u3088\u304f\u3084\u3063\u305f!","\u3059\u3054\u3044!","\u304b\u3093\u307a\u304d!","\u3070\u3063\u3061\u308a!","\u305d\u306e\u8abf\u5b50!"],this.wrongFeedback=["\u3061\u304c\u3046!","\u3056\u3093\u306d\u3093!","\u306f\u305a\u308c!","\u3075\u305b\u3044\u304b\u3044!","\u30d0\u30c4!"],this.checkButtonLabels=["\u3088\u3057!","\u5224\u5b9a!","\u3067\u304d\u305f!","\u3044\u3056!","\u78ba\u8a8d"],this.dismissButtonLabels=["\u6b21!","\u3064\u304e!","\u3088\u3057!","\u30aa\u30c3\u30b1\u30fc!","\u306f\u3044!","\u4e86\u89e3!","\u3044\u304f\u305e!"],this.checkButtonText="",this.dismissButtonText="",this.minBrushSize=3,this.maxBrushSize=24,this.brushSmoothing=.05,this.lastBrushSize=0,function(n){Object.keys(n).forEach(function(e){X(e,n[e]);var m=e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();e!==m&&X(m,n[e])})}({backspace:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M403.13 96H156.87a44.9 44.9 0 00-33.68 15.27 15.88 15.88 0 00-1.91 2.7L32 247.75a16 16 0 000 16.5l89.15 133.57a16.24 16.24 0 002 2.88 44.89 44.89 0 0033.7 15.3h246.28A44.92 44.92 0 00448 371.13V140.87A44.92 44.92 0 00403.13 96zM348 311a16 16 0 11-22.63 22.62L271.67 280 218 333.65A16 16 0 01195.35 311L249 257.33l-53.69-53.69A16 16 0 01218 181l53.69 53.7 53.67-53.7A16 16 0 01348 203.64l-53.7 53.69z'/></svg>"})}ngOnInit(){var o=this;return(0,_.A)(function*(){o.checkButtonText=o.randomFrom(o.checkButtonLabels),yield o.cardsService.initialize(),o.loadRandomCard(),o.cardAvailabilitySubscription=o.cardsService.cardAvailability$.subscribe(s=>{o.noCardsAvailable&&s>0&&o.loadRandomCard()})})()}loadRandomCard(){this.currentCard=this.cardsService.getRandomUnlockedCard(),this.currentCard?(this.currentCharacter=this.currentCard.answers[0],this.promptText=this.currentCard.prompt,this.promptColor=this.cardsService.getStageColor(this.currentCard.stage),this.noCardsAvailable=!1):(this.noCardsAvailable=!0,this.promptText="",this.promptColor="#FFFFFF")}ngAfterViewInit(){setTimeout(()=>this.setupCanvas(),100)}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.cardAvailabilitySubscription&&this.cardAvailabilitySubscription.unsubscribe(),this.cancelSegmentation()}setupCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(s),this.ctx=o.getContext("2d"),this.setCanvasStyle(),o.addEventListener("mousedown",this.handleMouseDown.bind(this)),o.addEventListener("mousemove",this.handleMouseMove.bind(this)),o.addEventListener("mouseup",this.handleMouseUp.bind(this)),o.addEventListener("mouseleave",this.handleMouseUp.bind(this)),o.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),o.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),o.addEventListener("touchend",this.handleTouchEnd.bind(this)))}resizeCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(o.width=s.clientWidth,o.height=s.clientHeight,this.ctx&&this.setCanvasStyle())}setCanvasStyle(){this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff",this.ctx.lineCap="round",this.ctx.lineJoin="round"}handleMouseDown(o){this.cancelSegmentation(),this.isDrawing=!0;const s=this.getMousePos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleMouseMove(o){if(!this.isDrawing)return;const s=this.getMousePos(o),i=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(i,s)}handleMouseUp(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}handleTouchStart(o){o.preventDefault(),this.cancelSegmentation(),this.isDrawing=!0;const s=this.getTouchPos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleTouchMove(o){if(!this.isDrawing)return;o.preventDefault();const s=this.getTouchPos(o),i=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(i,s)}handleTouchEnd(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}getMousePos(o){const s=this.canvasRef.nativeElement,i=s.getBoundingClientRect(),t=s.width/i.width,r=s.height/i.height,g=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=g),{x:(o.clientX-i.left)*t,y:(o.clientY-i.top)*r,t:g-this.drawStartTime}}getTouchPos(o){const s=this.canvasRef.nativeElement,i=s.getBoundingClientRect(),t=s.width/i.width,r=s.height/i.height,g=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=g),{x:(o.touches[0].clientX-i.left)*t,y:(o.touches[0].clientY-i.top)*r,t:g-this.drawStartTime}}calculateBrushSize(o,s){const i=s.x-o.x,t=s.y-o.y,r=Math.max(s.t-o.t,1),c=Math.sqrt(i*i+t*t)/r,v=Math.min(c/1.5,1),h=this.lastBrushSize+(this.maxBrushSize-v*(this.maxBrushSize-this.minBrushSize)-this.lastBrushSize)*this.brushSmoothing;return this.lastBrushSize=h,h}drawBrushPoint(o,s,i){this.ctx.beginPath(),this.ctx.arc(o,s,i/2,0,2*Math.PI),this.ctx.fill()}drawBrushSegment(o,s){const i=this.calculateBrushSize(o,s);this.ctx.lineWidth=i,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.drawBrushPoint(s.x,s.y,i)}drawHarai(o){if(o.length<3)return;const s=Math.min(5,o.length),i=o.slice(-s),t=i[i.length-1],r=i[0],g=t.x-r.x,c=t.y-r.y,v=Math.sqrt(g*g+c*c);if(v<5)return;const l=g/v,h=c/v,w=Math.max(t.t-r.t,1),p=Math.min(v/w*20,40);if(p<8)return;const x=this.lastBrushSize;for(let k=0;k<8;k++){const L=(k+1)/8,H=1-Math.pow(1-k/8,2),M=1-Math.pow(1-L,2),f=t.x+l*p*H,C=t.y+h*p*H,j=t.x+l*p*M,P=t.y+h*p*M,b=x*(1-L);b>.5&&(this.ctx.lineWidth=b,this.ctx.beginPath(),this.ctx.moveTo(f,C),this.ctx.lineTo(j,P),this.ctx.stroke())}}onCheck(){var o=this;return(0,_.A)(function*(){if(0!==o.strokes.length&&o.currentCard){o.isChecking=!0;try{const s=o.canvasRef.nativeElement,i=Math.max(...o.currentCard.answers.map(l=>[...l.replace(/\s+/g,"")].length));let r,t=[];if(i>1&&(o.segmentationResult||(o.segmentationResult=o.segmentationService.segment(o.strokes,s.width,s.height)),t=[...o.segmentationResult.grid.cells.filter(w=>w.strokeIndices.length>0)].sort((w,d)=>w.column!==d.column?w.column-d.column:w.row-d.row)),t.length<=1)o.lastBatchResults=[],r=yield o.strokeRecognition.recognize(o.strokes,s.width,s.height);else{const l=t.map(d=>({strokes:d.strokeIndices.map(k=>o.strokes[k]),bounds:{width:d.bounds.maxX-d.bounds.minX,height:d.bounds.maxY-d.bounds.minY}})),h=yield o.strokeRecognition.recognizeBatch(l);o.lastBatchResults=h,r=[{character:h.map(d=>d[0]?.character||"?").join(""),score:100}],console.log("Cell interpretations (Japanese reading order):",h.map((d,p)=>({cell:p,position:`col ${t[p].column}, row ${t[p].row}`,top5:d.slice(0,5).map(u=>u.character)})))}o.topMatches=r.slice(0,5);const g=o.currentCard.answers.map(l=>l.replace(/\s+/g,""));let c=!1;if(o.lastBatchResults.length>0)c=g.some(l=>{const h=[...l];return h.length===o.lastBatchResults.length&&h.every((w,d)=>{const p=o.lastBatchResults[d].slice(0,5).map(x=>x.character),u=p.some(x=>o.kanaMatch(w,x));return console.log(`  Cell ${d}: target='${w}' (code=${w.charCodeAt(0)}), candidates=[${p.map(x=>`'${x}'(${x.charCodeAt(0)})`).join(", ")}], matched=${u}`),u})}),console.log("Grading multi-char:",{targets:g,cellResults:o.lastBatchResults.map(l=>l.slice(0,5).map(h=>h.character)),isCorrect:c});else{const l=o.topMatches.map(h=>h.character);c=g.some(h=>l.some(w=>o.kanaMatch(h,w)))}if(c)o.resultStatus="correct",o.resultFeedback=o.randomFrom(o.correctFeedback),o.displayMatches=o.topMatches.slice(0,1),o.correctAnswer="",o.cardsService.advanceCard(o.currentCard.id);else{let l;if(o.lastBatchResults.length>0)console.log("Checking befuddlers:",o.currentCard.befuddlers.map(h=>({answers:h.answers,toast:h.toast.slice(0,30)}))),l=o.currentCard.befuddlers.find(h=>(console.log("  Befuddler answers:",h.answers),h.answers.some(w=>{const d=[...w.replace(/\s+/g,"")];if(console.log(`    Checking "${w}": ${d.length} chars vs ${o.lastBatchResults.length} cells`),d.length!==o.lastBatchResults.length)return!1;const p=d.every((u,x)=>{const k=o.lastBatchResults[x].slice(0,5).map(L=>L.character),z=k.some(L=>o.kanaMatch(u,L));return console.log(`      Cell ${x}: '${u}' vs [${k.join(",")}] = ${z}`),z});return console.log(`    Result: ${p}`),p})));else{const h=o.topMatches.map(w=>w.character);l=o.currentCard.befuddlers.find(w=>w.answers.some(d=>h.some(p=>o.kanaMatch(d.replace(/\s+/g,""),p))))}l?(o.resultStatus="befuddled",o.resultFeedback=l.toast,o.displayMatches=o.topMatches,o.correctAnswer=""):(o.resultStatus="wrong",o.resultFeedback=o.randomFrom(o.wrongFeedback),o.displayMatches=o.topMatches,o.correctAnswer=o.currentCard.answers[0])}const v=o.strokeRecognition.getExpectedStrokeCount(o.currentCharacter);o.strokeCountInfo=`Strokes: ${o.strokes.length}/${v}`}catch(s){console.error("Recognition error:",s),o.resultStatus="wrong",o.resultFeedback=s.message||"Recognition failed. Please try on a device.",o.topMatches=[],o.displayMatches=[],o.strokeCountInfo=""}o.isChecking=!1,o.checkButtonText=o.randomFrom(o.checkButtonLabels),o.dismissButtonText=o.randomFrom(o.dismissButtonLabels),o.showResults=!0}})()}dismissResults(){this.showResults=!1,this.clearCanvas(),("correct"===this.resultStatus||"wrong"===this.resultStatus)&&this.loadRandomCard()}onUndo(){this.strokes.length>0&&(this.strokes.pop(),this.redrawStrokes(),this.scheduleSegmentation())}redrawStrokes(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.setCanvasStyle();for(const s of this.strokes)if(0!==s.length){this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s[0].x,s[0].y,1.5*this.minBrushSize);for(let i=1;i<s.length;i++)this.drawBrushSegment(s[i-1],s[i]);this.drawHarai(s)}}clearCanvas(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.strokes=[],this.drawStartTime=0,this.cancelSegmentation(),this.segmentationResult=null}randomFrom(o){return o[Math.floor(Math.random()*o.length)]}scheduleSegmentation(){this.cancelSegmentation(),0!==this.strokes.length?this.segmentationTimer=setTimeout(()=>{this.analyzeAndVisualize()},this.SEGMENTATION_DELAY_MS):this.segmentationResult=null}cancelSegmentation(){null!==this.segmentationTimer&&(clearTimeout(this.segmentationTimer),this.segmentationTimer=null)}analyzeAndVisualize(){if(0===this.strokes.length)return void(this.segmentationResult=null);if(this.currentCard&&Math.max(...this.currentCard.answers.map(i=>[...i.replace(/\s+/g,"")].length))<=1)return this.segmentationResult=null,void this.redrawStrokes();const o=this.canvasRef.nativeElement;this.segmentationResult=this.segmentationService.segment(this.strokes,o.width,o.height),this.redrawWithBoundaries()}redrawWithBoundaries(){if(this.redrawStrokes(),this.segmentationResult){const o=this.segmentationResult.grid;(o.columnDividers.length>0||o.rowDividers.some(i=>i.length>0))&&this.drawDividers(o)}}drawDividers(o){this.ctx.save(),this.ctx.strokeStyle="rgba(128, 128, 128, 0.4)",this.ctx.lineWidth=1,this.ctx.setLineDash([4,4]);for(const s of o.columnDividers){const i=s.start,t=s.end,r=s.slope*i+s.intercept,g=s.slope*t+s.intercept;this.ctx.beginPath(),this.ctx.moveTo(r,i),this.ctx.lineTo(g,t),this.ctx.stroke()}for(const s of o.rowDividers)for(const i of s){const t=i.start,r=i.end,g=i.slope*t+i.intercept,c=i.slope*r+i.intercept;this.ctx.beginPath(),this.ctx.moveTo(t,g),this.ctx.lineTo(r,c),this.ctx.stroke()}this.ctx.restore()}static#o=n=()=>(this.SMALL_TO_BIG_KANA={\u3063:"\u3064",\u3083:"\u3084",\u3085:"\u3086",\u3087:"\u3088",\u3041:"\u3042",\u3043:"\u3044",\u3045:"\u3046",\u3047:"\u3048",\u3049:"\u304a",\u308e:"\u308f",\u30c3:"\u30c4",\u30e3:"\u30e4",\u30e5:"\u30e6",\u30e7:"\u30e8",\u30a1:"\u30a2",\u30a3:"\u30a4",\u30a5:"\u30a6",\u30a7:"\u30a8",\u30a9:"\u30aa",\u30ee:"\u30ef"},this.\u0275fac=function(s){return new(s||e)(a.rXU(a1),a.rXU(U.D),a.rXU(i1))},this.\u0275cmp=a.VBU({type:e,selectors:[["app-workbook"]],viewQuery:function(s,i){if(1&s&&a.GBs(n1,5),2&s){let t;a.mGM(t=a.lsd())&&(i.canvasRef=t.first)}},decls:11,vars:10,consts:[["canvas",""],[1,"workbook-content",3,"fullscreen","scrollY"],[1,"prompt-bar"],["color","light"],[1,"prompt-text"],[1,"canvas-wrapper"],["class","drawing-canvas",4,"ngIf"],["class","undo-btn","fill","clear",3,"click",4,"ngIf"],["class","caught-up-box",4,"ngIf"],["class","check-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","results-overlay",3,"click",4,"ngIf"],[1,"drawing-canvas"],["fill","clear",1,"undo-btn",3,"click"],["name","backspace"],[1,"caught-up-box"],[1,"caught-up-title"],[1,"caught-up-message"],["color","primary",1,"check-btn",3,"click","disabled"],["name","crescent",4,"ngIf"],[4,"ngIf"],["name","crescent"],[1,"results-overlay",3,"click"],[1,"results-card",3,"click"],[1,"status-display"],[1,"feedback"],[1,"stroke-info"],["class","matches-section",4,"ngIf"],["class","correct-answer-section",4,"ngIf"],["expand","block",3,"click"],[1,"matches-section"],[1,"matches-title"],[1,"matches-list"],["class","match-item",4,"ngFor","ngForOf"],[1,"match-item"],[1,"match-char"],[1,"correct-answer-section"],[1,"correct-answer-title"],[1,"correct-answer"]],template:function(s,i){1&s&&(a.j41(0,"ion-content",1)(1,"div",2),a.nrm(2,"ion-menu-button",3),a.j41(3,"span",4),a.EFF(4),a.k0s()(),a.j41(5,"div",5),a.DNE(6,t1,2,0,"canvas",6)(7,l1,2,0,"ion-button",7)(8,c1,5,0,"div",8),a.k0s(),a.DNE(9,v1,3,3,"ion-button",9)(10,x1,14,10,"div",10),a.k0s()),2&s&&(a.Y8G("fullscreen",!0)("scrollY",!1),a.R7$(3),a.xc7("color",i.promptColor),a.R7$(),a.JRh(i.promptText),a.R7$(2),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",i.showResults))},dependencies:[O.W9,O.MC,O.Jm,O.iq,O.w2,q.MD,q.Sq,q.bT],styles:[".workbook-content[_ngcontent-%COMP%]{--background: #000}.prompt-bar[_ngcontent-%COMP%]{display:flex;align-items:center;height:144px;background:#111;padding:0 8px}.prompt-text[_ngcontent-%COMP%]{flex:1;text-align:center;font-size:24px;color:#fff;margin-right:40px;white-space:pre-line}.canvas-wrapper[_ngcontent-%COMP%]{position:absolute;inset:144px 0 0;background:#000}.drawing-canvas[_ngcontent-%COMP%]{width:100%;height:100%;touch-action:none;display:block}.undo-btn[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:24px}.results-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000e6;display:flex;align-items:center;justify-content:center;z-index:100}.results-card[_ngcontent-%COMP%]{background:#1a1a1a;border-radius:16px;padding:24px;min-width:280px;max-width:90%;text-align:center}.results-card.correct[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.correct[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#e63946}.results-card.befuddled[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.befuddled[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#f7b731}.results-card.wrong[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.wrong[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#4a90d9}.status-display[_ngcontent-%COMP%]{font-size:64px;font-weight:700;margin-bottom:8px}.feedback[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-size:18px;margin-bottom:16px;white-space:pre-line}.stroke-info[_ngcontent-%COMP%]{font-size:14px;color:#888;margin-bottom:20px}.matches-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.matches-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.matches-list[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:16px}.match-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.match-char[_ngcontent-%COMP%]{font-size:32px;color:#fff}.correct-answer-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.correct-answer-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.correct-answer[_ngcontent-%COMP%]{font-size:36px;color:#4a90d9}.check-btn[_ngcontent-%COMP%]{position:absolute;bottom:32px;left:50%;transform:translate(-50%);--background: #222;--background-hover: #333;--color: #fff;--border-radius: 32px;--padding-start: 12vw;--padding-end: 12vw;--padding-top: 16px;--padding-bottom: 16px;min-height:60px;font-family:Shippori Mincho,serif;font-size:clamp(20px,5vw,28px);font-weight:600;letter-spacing:2px}.results-card[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-weight:700}.caught-up-box[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border-radius:16px;padding:32px;text-align:center;max-width:90%;width:320px}.caught-up-title[_ngcontent-%COMP%]{font-size:36px;margin-bottom:16px}.caught-up-message[_ngcontent-%COMP%]{font-size:16px;color:#ccc;line-height:1.5}"]}))}return n(),e})();const u1=[{path:"",component:W}];let M1=(()=>{var n;class e{static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275mod=a.$C({type:e}),this.\u0275inj=V.G2t({imports:[I.iI.forChild(u1),I.iI]}))}return n(),e})(),z1=(()=>{var n;class e{static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275mod=a.$C({type:e}),this.\u0275inj=V.G2t({imports:[q.MD,J.YN,Q.bv,M1,W]}))}return n(),e})()}}]);