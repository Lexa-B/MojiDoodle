"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[634],{634(a2,r1,j){j.d(r1,{WorkbookPageModule:()=>s2});var E,P=j(2200),v1=j(4341),g1=j(7343),W=j(8132),q=j(467),I=j(396),J=function(n,s){var o=function(){if(typeof window>"u")return new Map;if(!E){var n=window;n.Ionicons=n.Ionicons||{},E=n.Ionicons.map=n.Ionicons.map||new Map}return E}(),a=o.get(n);void 0===a?o.set(n,s):a!==s&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(n,'". Ensure that multiple icons are not mapped to the same icon name.'))};function K(n,s,o,a){if(0===n.length)return.15*s;const t=n.map(c=>"width"===o?c.maxX-c.minX:c.maxY-c.minY).filter(c=>c>5);if(0===t.length)return.15*s;t.sort((c,v)=>c-v);const l=t[Math.floor(t.length/2)]*a.charSizeMultiplier;return Math.max(s*a.minCharSizeRatio,Math.min(s*a.maxCharSizeRatio,l))}function z1(n,s){if(s.length<3)return!1;let o=!1;for(let a=0,t=s.length-1;a<s.length;t=a++){const e=s[a].x,l=s[a].y,g=s[t].y;l>n.y!=g>n.y&&n.x<(s[t].x-e)*(n.y-l)/(g-l)+e&&(o=!o)}return o}function Z(n,s,o){const a=[];for(let t=0;t<n.length;t++){const e=n[t];if(0===e.length)continue;let l=0;for(const g of e)z1(g,s)&&l++;l/e.length>=o&&a.push(t)}return a}function s1(n){if(n.length<=1)return[...n];const s=[...n].sort((l,r)=>l.x-r.x||l.y-r.y),o=[s[0]];for(let l=1;l<s.length;l++)(s[l].x!==s[l-1].x||s[l].y!==s[l-1].y)&&o.push(s[l]);if(o.length<=2)return o;const a=(l,r,g)=>(r.x-l.x)*(g.y-l.y)-(r.y-l.y)*(g.x-l.x),t=[];for(const l of o){for(;t.length>=2&&a(t[t.length-2],t[t.length-1],l)<=0;)t.pop();t.push(l)}const e=[];for(let l=o.length-1;l>=0;l--){const r=o[l];for(;e.length>=2&&a(e[e.length-2],e[e.length-1],r)<=0;)e.pop();e.push(r)}return t.pop(),e.pop(),t.concat(e)}function T(n,s,o){for(const a of o){if(a.hull.length<3)continue;const t=a.hull.map(r=>"x"===s?r.x:r.y),e=Math.min(...t),l=Math.max(...t);if(n>e&&n<l)return!0}return!1}function o1(n,s,o,a,t,e){return t.length<2?n:n.map((l,r)=>{const g=s[r];if(g.length<2)return l;const c=g.map(h=>o[h]),v=e(r,a,s.length,c),w=[];for(let h=0;h<t.length;h++){const u=t[h].strokeIndices.filter(f=>g.includes(f));if(0===u.length)continue;const z=u.map(f=>o[f]),x=Math.min(...z.map(f=>f.minY)),M=Math.max(...z.map(f=>f.maxY));w.push({idx:h,minY:x,maxY:M})}if(w.length<2)return l;w.sort((h,d)=>h.minY-d.minY);const p=[...l],m=new Set(l.map(h=>h.intercept));for(let h=0;h<w.length-1;h++){const z=(w[h].maxY+w[h+1].minY)/2,x=p.find(M=>Math.abs(M.intercept-z)<10);x?x.mandatory=!0:(p.push({slope:0,intercept:z,start:v.minX-10,end:v.maxX+10,mandatory:!0}),m.add(z))}return p.sort((h,d)=>h.intercept-d.intercept)})}function X(n,s){const o=s.length+1,a=Array.from({length:o},()=>[]),t=s.map(e=>e.intercept).sort((e,l)=>e-l);for(const e of n){let l=0;for(let g=0;g<t.length;g++)e.centerX>t[g]&&(l=g+1);a[o-1-l].push(e.strokeIndex)}return a}function D(n,s,o,a){if(0===s.length||0===a.length)return{minX:Math.min(...a.map(v=>v.minX)),maxX:Math.max(...a.map(v=>v.maxX))};const t=s.map(v=>v.intercept).sort((v,w)=>v-w),e=o-1-n,l=Math.min(...a.map(v=>v.minX)),r=Math.max(...a.map(v=>v.maxX));return{minX:e>0?t[e-1]:l,maxX:e<t.length?t[e]:r}}function a1(n,s,o,a,t,e){return n.map((l,r)=>{if(l.length<2)return[];const g=l.map(v=>s[v]),c=D(r,o,n.length,g);return function L1(n,s,o,a,t){if(n.length<2)return[];const e=[...n].sort((g,c)=>g.centerY-c.centerY),l=[],r=s*a.minRowGapRatio;for(let g=0;g<e.length-1;g++){const w=e[g].maxY,p=e[g+1].minY,m=p-w;m>=r&&l.push({gapStart:w,gapEnd:p,gapSize:m})}return l.map(g=>({slope:0,intercept:(g.gapStart+g.gapEnd)/2,start:o.minX-10,end:o.maxX+10})).filter(g=>!T(g.intercept,"y",t))}(g,a,c,t,e)})}function R(n){if(n.length<=1)return 1;const s=Math.min(...n),o=Math.max(...n);return s>0?o/s:1/0}function $(n,s,o,a,t,e){return n.map((r,g)=>{const c=s[g];if(0===c.length)return r;const v=c.map(d=>o[d]),w=Math.min(...v.map(d=>d.minY)),p=Math.max(...v.map(d=>d.maxY)),m=D(g,a,s.length,v);let h=[...r];for(let d=0;d<10;d++){const z=[w,...h.map(B=>B.intercept).sort((B,y)=>B-y),p],x=[];for(let B=0;B<z.length-1;B++)x.push(z[B+1]-z[B]);if(x.length<=1)break;const M=R(x);if(M<=e.maxSizeRatio)break;let f=null,k=M,S=0,L=-1;const H=x.indexOf(Math.max(...x)),V=(z[H]+z[H+1])/2;if(!T(V,"y",t)){const B=[...x],y=x[H]/2;B.splice(H,1,y,y);const A=R(B);A<k&&(k=A,f="split",S=V)}if(h.length>0){const B=x.indexOf(Math.min(...x)),y=[...h].sort((A,_)=>A.intercept-_.intercept);if(B>0&&!y[B-1]?.mandatory){const A=[...x];A[B-1]+=A[B],A.splice(B,1);const _=R(A);_<k&&(k=_,f="merge",L=B-1)}if(B<x.length-1&&!y[B]?.mandatory){const A=[...x];A[B]+=A[B+1],A.splice(B+1,1);const _=R(A);_<k&&(k=_,f="merge",L=B)}}if("split"===f)h.push({slope:0,intercept:S,start:m.minX-10,end:m.maxX+10}),h.sort((y,A)=>y.intercept-A.intercept);else{if(!("merge"===f&&L>=0&&L<h.length))break;{const B=[...h].sort((y,A)=>y.intercept-A.intercept);B.splice(L,1),h=B}}}return h})}function N(n,s){const o=[];let a=0;for(let t=0;t<n.length;t++){const e=s.get(t);e&&e.length>0&&o.push({index:a++,points:n[t],strokeIndices:e})}return o}const t1=[0,165,330,135,300,105,270,75,240,45,210,15,180,345,150,315,120,285,90,255,60,225,30,195];function n1(n,s,o,a){const t=[];for(const e of n){const l=e.start,r=e.end;t.push(`  <line x1="${e.slope*l+e.intercept}" y1="${l}" x2="${e.slope*r+e.intercept}" y2="${r}" stroke="rgba(128,128,128,0.8)" stroke-width="2" stroke-dasharray="4,4" />`)}for(const e of s)for(const l of e){const r=l.start,g=l.end;t.push(`  <line x1="${r}" y1="${l.slope*r+l.intercept}" x2="${g}" y2="${l.slope*g+l.intercept}" stroke="rgba(128,128,128,0.8)" stroke-width="2" stroke-dasharray="4,4" />`)}return`<svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${a}" viewBox="0 0 ${o} ${a}">\n${t.join("\n")}\n</svg>`}const b1={minColumnGapRatio:.25,minRowGapRatio:.25,charSizeMultiplier:2,minCharSizeRatio:.08,maxCharSizeRatio:.4,maxSizeRatio:2,lassoContainmentThreshold:.5};class i1{constructor(s){this.config=function _1(n){return{...b1,...n}}(s)}segment(s){const o=function y1(n,s){const{strokes:o,lassos:a,canvasWidth:t,canvasHeight:e}=n,l=new Map,r=[],g=new Map;for(const L of a){const H=Z(o,L.points,s.lassoContainmentThreshold),V=r.length;if(r.push(L.points),0!==H.length){for(const b of H){const B=l.get(b);if(void 0!==B){const A=g.get(B).filter(_=>_!==b);0===A.length?g.delete(B):g.set(B,A)}l.set(b,V)}g.set(V,H)}}if(globalThis.console?.log("[MANUAL_GROUPS]",Object.fromEntries(g)),0===o.length)return{characters:[],strokes:[],lassos:N(r,g),columnDividers:[],rowDividers:[],protectedBounds:new Map};if(1===n.maxCharacters)return function j1(n,s,o){let a=1/0,t=-1/0,e=1/0,l=-1/0;for(const w of n)for(const p of w)a=Math.min(a,p.x),t=Math.max(t,p.x),e=Math.min(e,p.y),l=Math.max(l,p.y);a===1/0&&(a=t=e=l=0);const r={index:0,strokes:[...n],bounds:{minX:a,maxX:t,minY:e,maxY:l,width:t-a,height:l-e}},g=n.map((w,p)=>({index:p,points:w,characterIndex:0})),c=N(s,o),v=new Map;for(const[w,p]of o){const m=[];for(const d of p)for(const u of n[d])m.push({x:u.x,y:u.y});const h=s1(m);v.set(w,h)}return{characters:[r],strokes:g,lassos:c,columnDividers:[],rowDividers:[],protectedBounds:v}}(o,r,g);const c=o.map((L,H)=>function f1(n,s){if(0===n.length)return{strokeIndex:s,minX:0,maxX:0,minY:0,maxY:0,centerX:0,centerY:0};let o=1/0,a=-1/0,t=1/0,e=-1/0;for(const l of n)o=Math.min(o,l.x),a=Math.max(a,l.x),t=Math.min(t,l.y),e=Math.max(e,l.y);return{strokeIndex:s,minX:o,maxX:a,minY:t,maxY:e,centerX:(o+a)/2,centerY:(t+e)/2}}(L,H)),v={minX:Math.min(...c.map(L=>L.minX)),maxX:Math.max(...c.map(L=>L.maxX)),minY:Math.min(...c.map(L=>L.minY)),maxY:Math.max(...c.map(L=>L.maxY))},w=new Map;for(const[L,H]of g){const V=[];for(const B of H)for(const y of o[B])V.push({x:y.x,y:y.y});const b=s1(V);w.set(L,b)}globalThis.console?.log("[PROTECTED_BOUNDS]",Object.fromEntries([...w].map(([L,H])=>[L,H.map(V=>`(${V.x},${V.y})`)])));const p=K(c,t,"width",s),m=K(c,e,"height",s),h=[];for(const[L,H]of g){const V=w.get(L);V&&h.push({strokeIndices:H,hull:V})}let d=function B1(n,s,o,a){if(n.length<2)return[];const t=Math.min(...n.map(c=>c.minY)),e=Math.max(...n.map(c=>c.maxY)),l=[...n].sort((c,v)=>c.centerX-v.centerX),r=[],g=s*o.minColumnGapRatio;for(let c=0;c<l.length-1;c++){const p=l[c].maxX,m=l[c+1].minX,h=m-p;h>=g&&r.push({gapStart:p,gapEnd:m,gapSize:h})}return r.map(c=>({slope:0,intercept:(c.gapStart+c.gapEnd)/2,start:t-10,end:e+10})).filter(c=>!T(c.intercept,"x",a))}(c,p,s,h);d=function k1(n,s,o,a){if(o.length<2)return n;const t=[];for(let c=0;c<o.length;c++){const v=o[c].hull;if(v.length<3)continue;const w=Math.min(...v.map(d=>"x"===a?d.x:d.y)),p=Math.max(...v.map(d=>"x"===a?d.x:d.y)),m=Math.min(...v.map(d=>"x"===a?d.y:d.x)),h=Math.max(...v.map(d=>"x"===a?d.y:d.x));t.push({idx:c,min:w,max:p,perpMin:m,perpMax:h})}if(t.length<2)return n;t.sort((c,v)=>c.min-v.min);const e=[...n],l=new Set(n.map(c=>c.intercept)),r=Math.min(...s.map("x"===a?c=>c.minY:c=>c.minX)),g=Math.max(...s.map("x"===a?c=>c.maxY:c=>c.maxX));for(let c=0;c<t.length-1;c++){const p=(t[c].max+t[c+1].min)/2;if(T(p,a,o))continue;const m=e.find(h=>Math.abs(h.intercept-p)<10);m?m.mandatory=!0:(e.push({slope:0,intercept:p,start:r-10,end:g+10,mandatory:!0}),l.add(p))}return e.sort((c,v)=>c.intercept-v.intercept)}(d,c,h,"x"),d=function C1(n,s,o,a,t){if(0===s.length)return n;let l=[...n];for(let r=0;r<10;r++){const g=l.map(M=>M.intercept).sort((M,f)=>M-f),c=[o.minX,...g,o.maxX],v=[];for(let M=0;M<c.length-1;M++)v.push(c[M+1]-c[M]);if(v.length<=1)break;const w=R(v);if(w<=t.maxSizeRatio)break;let p=null,m=w,h=0,d=-1;const u=v.indexOf(Math.max(...v)),z=(c[u]+c[u+1])/2;if(!T(z,"x",a)){const M=[...v],f=v[u]/2;M.splice(u,1,f,f);const k=R(M);k<m&&(m=k,p="split",h=z)}if(l.length>0){const M=v.indexOf(Math.min(...v)),f=[...l].sort((k,S)=>k.intercept-S.intercept);if(M>0&&!f[M-1]?.mandatory){const k=[...v];k[M-1]+=k[M],k.splice(M,1);const S=R(k);S<m&&(m=S,p="merge",d=M-1)}if(M<v.length-1&&!f[M]?.mandatory){const k=[...v];k[M]+=k[M+1],k.splice(M+1,1);const S=R(k);S<m&&(m=S,p="merge",d=M)}}if("split"===p)l.push({slope:0,intercept:h,start:o.minY-10,end:o.maxY+10}),l.sort((f,k)=>f.intercept-k.intercept);else{if(!("merge"===p&&d>=0&&d<l.length))break;{const M=[...l].sort((f,k)=>f.intercept-k.intercept);M.splice(d,1),l=M}}}return l}(d,c,v,h,s);let u=X(c,d),z=a1(u,c,d,m,s,h);z=o1(z,u,c,d,h,D),z=$(z,u,c,d,h,s);const x=function H1(n,s,o,a,t,e,l){let g=[...n],c=[...s];for(let v=0;v<10&&!(g.length+1<=Math.max(...c.map(x=>x.length+1),1)||0===g.length);v++){const m=[...g].sort((x,M)=>x.intercept-M.intercept),h=[t.minX,...m.map(x=>x.intercept),t.maxX];let d=-1,u=1/0;for(let x=0;x<m.length;x++){if(m[x].mandatory)continue;const k=h[x+1]-h[x]+(h[x+2]-h[x+1]);k<u&&(u=k,d=x)}if(d<0)break;m.splice(d,1),g=m;const z=X(o,g);c=a1(z,o,g,a,l,e),c=$(c,z,o,g,e,l)}return{columnDividers:g,rowDividers:c}}(d,z,c,m,v,h,s);d=x.columnDividers,z=x.rowDividers,u=X(c,d),z=o1(z,u,c,d,h,D),z=$(z,u,c,d,h,s);const M=function V1(n,s,o,a){const t=[],e=n.length;for(let l=0;l<e;l++){const r=n[l],g=a[l]||[];if(0===r.length)continue;const c=r.map(h=>s[h]),v=Math.min(...c.map(h=>h.minY)),w=Math.max(...c.map(h=>h.maxY)),p=g.map(h=>h.intercept).sort((h,d)=>h-d),m=p.length+1;for(let h=0;h<m;h++){const d=0===h?v-5:p[h-1],u=h===m-1?w+5:p[h],z=r.filter(f=>{const k=s[f];return k.centerY>=d&&k.centerY<=u});if(0===z.length)continue;const x=z.map(f=>s[f]),M={minX:Math.min(...x.map(f=>f.minX)),maxX:Math.max(...x.map(f=>f.maxX)),minY:Math.min(...x.map(f=>f.minY)),maxY:Math.max(...x.map(f=>f.maxY))};t.push({column:l,row:h,strokeIndices:z,bounds:M})}}return t}(u,c,0,z),f=function A1(n,s){return[...n].sort((a,t)=>a.column!==t.column?a.column-t.column:a.row-t.row).map((a,t)=>{const e=a.strokeIndices.map(v=>s[v]);let l=1/0,r=-1/0,g=1/0,c=-1/0;for(const v of e)for(const w of v)l=Math.min(l,w.x),r=Math.max(r,w.x),g=Math.min(g,w.y),c=Math.max(c,w.y);return l===1/0&&(l=r=g=c=0),{index:t,strokes:e,bounds:{minX:l,maxX:r,minY:g,maxY:c,width:r-l,height:c-g}}})}(M,o),k=function S1(n,s){const o=new Map;return[...s].sort((t,e)=>t.column!==e.column?t.column-e.column:t.row-e.row).forEach((t,e)=>{for(const l of t.strokeIndices)o.set(l,e)}),n.map((t,e)=>({index:e,points:t,characterIndex:o.get(e)??-1}))}(o,M);return{characters:f,strokes:k,lassos:N(r,g),columnDividers:d,rowDividers:z,protectedBounds:w}}(s,this.config),a=1===s.maxCharacters?n1([],[],s.canvasWidth,s.canvasHeight):n1(o.columnDividers,o.rowDividers,s.canvasWidth,s.canvasHeight),t=[];for(let l=0;l<s.lassos.length;l++){if(!o.protectedBounds.has(l))continue;const r=o.protectedBounds.get(l);t.push(r.length>=3?r:s.lassos[l].points)}const e=function O1(n,s,o){const a=[];for(let t=0;t<n.length;t++){const e=n[t];if(e.length<3)continue;const l=t1[t%t1.length],r=e.map(g=>`${g.x},${g.y}`).join(" ");a.push(`  <polygon points="${r}" fill="hsla(${l},55%,78%,0.15)" stroke="hsla(${l},55%,78%,0.7)" stroke-width="2" stroke-dasharray="6,4" />`)}return`<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${o}" viewBox="0 0 ${s} ${o}">\n${a.join("\n")}\n</svg>`}(t,s.canvasWidth,s.canvasHeight);return{characters:o.characters,strokes:o.strokes,lassos:o.lassos,segmentationSvg:a,lassoSvg:e}}}var i=j(3664),C=j(2615),l1=j(6321);let R1=(()=>{var n;class s{constructor(a){this.cardsService=a,this.API_URL="https://inputtools.google.com/request?itc=ja-t-i0-handwrit&app=translate"}recognize(a,t,e){var l=this;return(0,q.A)(function*(){if(0===a.length)return[];const r=a.map(c=>{const v=[],w=[],p=[];for(const m of c)v.push(Math.round(m.x)),w.push(Math.round(m.y)),p.push(m.t);return[v,w,p]}),g={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:[{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:e,writing_area_width:t},ink:r}]};try{const v=yield(yield fetch(l.API_URL,{method:"POST",body:JSON.stringify(g),headers:{"Content-Type":"application/json"}})).json();return l.parseResponse(v)}catch(c){throw console.error("Recognition failed:",c),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}recognizeBatch(a){var t=this;return(0,q.A)(function*(){if(0===a.length)return[];const e=a.map(r=>{const g=r.strokes.map(c=>{const v=[],w=[],p=[];for(const m of c)v.push(Math.round(m.x)),w.push(Math.round(m.y)),p.push(m.t);return[v,w,p]});return{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:Math.round(r.bounds.height),writing_area_width:Math.round(r.bounds.width)},ink:g}}),l={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:e};try{const g=yield(yield fetch(t.API_URL,{method:"POST",body:JSON.stringify(l),headers:{"Content-Type":"application/json"}})).json();return t.parseBatchResponse(g,a.length)}catch(r){throw console.error("Batch recognition failed:",r),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}parseBatchResponse(a,t){if(!a||"SUCCESS"!==a[0])return Array(t).fill([]);const e=[],l=a[1]||[];for(let r=0;r<t;r++){const g=l[r]?.[1];if(!g||0===g.length){e.push([]);continue}const c=g.map(v=>v.replace(/\s+/g,"")).filter(v=>1===[...v].length).map((v,w)=>({character:v,score:Math.max(100-10*w,10)}));e.push(c)}return e}parseResponse(a){if(!a||"SUCCESS"!==a[0])return[];const t=a[1]?.[0]?.[1];return t&&0!==t.length?t.map((e,l)=>({character:e.replace(/\s+/g,""),score:Math.max(100-10*l,10)})):[]}getExpectedStrokeCount(a){return this.cardsService.getStrokeCount(a)}static#s=n=()=>(this.\u0275fac=function(t){return new(t||s)(C.KVO(l1.D))},this.\u0275prov=C.jDH({token:s,factory:s.\u0275fac,providedIn:"root"}))}return n(),s})(),q1=(()=>{var n;class s{constructor(){this.USER_ID_KEY="mojidoodle_collection_user_id",this.WORKER_URL="https://data-collection.mojidoodle.ai/collect"}getUserId(){let a=localStorage.getItem(this.USER_ID_KEY);return a||(a=this.generateUUID(),localStorage.setItem(this.USER_ID_KEY,a)),a}exportSample(a){var t=this;return(0,q.A)(function*(){const e=t.buildSample(a);try{yield t.sendToWorker(e)}catch(l){console.error("Failed to send to worker:",l)}})()}sendToWorker(a){var t=this;return(0,q.A)(function*(){const e=yield fetch(t.WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok)throw new Error(`Worker returned ${e.status}: ${e.statusText}`);const l=yield e.json();console.log("Sample sent to worker:",l)})()}buildSample(a){const{strokes:t,canvasWidth:e,canvasHeight:l,segmentResult:r,answers:g,recognitionResults:c,success:v,cardId:w}=a;let p=[];if(r){const d=new Map;for(const u of r.strokes)u.characterIndex>=0&&(d.has(u.characterIndex)||d.set(u.characterIndex,[]),d.get(u.characterIndex).push(u.index));p=r.characters.map(u=>({characterIndex:u.index,strokeIndices:d.get(u.index)||[],bounds:u.bounds}))}let m=null;r&&r.lassos.length>0&&(m=r.lassos.map(d=>({points:[...d.points],strokeIndices:[...d.strokeIndices]})));let h=null;return v&&(h=this.inferGroundTruth(t,p,g)),{version:2,strokes:t,canvasWidth:e,canvasHeight:l,characterAssignments:p,selectionLassos:m,answers:g,recognitionResults:c,groundTruth:h,success:v,id:this.generateUUID(),userId:this.getUserId(),cardId:w,timestamp:Date.now()}}inferGroundTruth(a,t,e){const r=[...e[0].replace(/\s+/g,"")];return t.length<=1?[{strokeIndices:a.map((g,c)=>c),character:r[0]||""}]:t.map((g,c)=>({strokeIndices:g.strokeIndices,character:r[c]||""}))}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const t=16*Math.random()|0;return("x"===a?t:3&t|8).toString(16)})}static#s=n=()=>(this.\u0275fac=function(t){return new(t||s)},this.\u0275prov=C.jDH({token:s,factory:s.\u0275fac,providedIn:"root"}))}return n(),s})();var c1,I1=j(345);const T1=["canvas"];function P1(n,s){1&n&&i.nrm(0,"canvas",13,0)}function F1(n,s){if(1&n){const o=i.RV6();i.j41(0,"div",14)(1,"ion-button",15),i.bIt("click",function(){C.eBV(o);const t=i.XpG();return C.Njj(t.onSkip())}),i.nrm(2,"ion-icon",16),i.k0s(),i.j41(3,"ion-button",15),i.bIt("click",function(){C.eBV(o);const t=i.XpG();return C.Njj(t.onUndo())}),i.nrm(4,"ion-icon",17),i.k0s(),i.j41(5,"ion-button",15),i.bIt("click",function(){C.eBV(o);const t=i.XpG();return C.Njj(t.onClearAll())}),i.nrm(6,"ion-icon",18),i.k0s(),i.j41(7,"ion-button",15),i.bIt("click",function(){C.eBV(o);const t=i.XpG();return C.Njj(t.setDrawMode("brush"))}),i.nrm(8,"ion-icon",19),i.k0s(),i.j41(9,"ion-button",15),i.bIt("click",function(){C.eBV(o);const t=i.XpG();return C.Njj(t.setDrawMode("lasso"))}),i.nrm(10,"ion-icon",20),i.k0s()()}if(2&n){const o=i.XpG();i.R7$(7),i.AVh("active","brush"===o.drawMode),i.R7$(2),i.AVh("active","lasso"===o.drawMode)}}function D1(n,s){1&n&&(i.j41(0,"div",21)(1,"div",22),i.EFF(2,"\u304a\u3081\u3067\u3068\u3046\u{1f973}"),i.k0s(),i.j41(3,"div",23),i.EFF(4,"You're all caught up. Come back again soon for more lessons!"),i.k0s()())}function E1(n,s){1&n&&i.nrm(0,"ion-spinner",27)}function U1(n,s){if(1&n&&(i.j41(0,"span"),i.EFF(1),i.k0s()),2&n){const o=i.XpG(2);i.R7$(),i.JRh(o.checkButtonText)}}function Y1(n,s){if(1&n){const o=i.RV6();i.j41(0,"ion-button",24),i.bIt("click",function(){C.eBV(o);const t=i.XpG();return C.Njj(t.onCheck())}),i.DNE(1,E1,1,0,"ion-spinner",25)(2,U1,2,1,"span",26),i.k0s()}if(2&n){const o=i.XpG();i.Y8G("disabled",o.isChecking),i.R7$(),i.Y8G("ngIf",o.isChecking),i.R7$(),i.Y8G("ngIf",!o.isChecking)}}function X1(n,s){1&n&&(i.j41(0,"span"),i.EFF(1,"\u25ef"),i.k0s())}function $1(n,s){1&n&&(i.j41(0,"span"),i.EFF(1,"\uff1f"),i.k0s())}function N1(n,s){1&n&&(i.j41(0,"span"),i.EFF(1,"\u2715"),i.k0s())}function W1(n,s){if(1&n&&(i.j41(0,"div",40)(1,"span",41),i.EFF(2),i.k0s()()),2&n){const o=s.$implicit;i.R7$(2),i.JRh(o.character)}}function G1(n,s){if(1&n&&(i.j41(0,"div",36)(1,"div",37),i.EFF(2,"Recognized:"),i.k0s(),i.j41(3,"div",38),i.DNE(4,W1,3,1,"div",39),i.k0s()()),2&n){const o=i.XpG(2);i.R7$(4),i.Y8G("ngForOf",o.displayMatches)}}function J1(n,s){if(1&n&&(i.j41(0,"div",42)(1,"div",43),i.EFF(2,"Answer:"),i.k0s(),i.j41(3,"div",44),i.EFF(4),i.k0s()()),2&n){const o=i.XpG(2);i.R7$(4),i.JRh(o.correctAnswer)}}function Q1(n,s){if(1&n){const o=i.RV6();i.j41(0,"div",28),i.bIt("click",function(){C.eBV(o);const t=i.XpG();return C.Njj(t.dismissResults())}),i.j41(1,"div",29),i.bIt("click",function(t){return C.eBV(o),C.Njj(t.stopPropagation())}),i.j41(2,"div",30),i.DNE(3,X1,2,0,"span",26)(4,$1,2,0,"span",26)(5,N1,2,0,"span",26),i.k0s(),i.j41(6,"div",31),i.EFF(7),i.k0s(),i.j41(8,"div",32),i.EFF(9),i.k0s(),i.DNE(10,G1,5,1,"div",33)(11,J1,5,1,"div",34),i.j41(12,"ion-button",35),i.bIt("click",function(){C.eBV(o);const t=i.XpG();return C.Njj(t.dismissResults())}),i.EFF(13),i.k0s()()()}if(2&n){const o=i.XpG();i.R7$(),i.HbH(o.resultStatus),i.R7$(2),i.Y8G("ngIf","correct"===o.resultStatus),i.R7$(),i.Y8G("ngIf","befuddled"===o.resultStatus),i.R7$(),i.Y8G("ngIf","wrong"===o.resultStatus),i.R7$(2),i.JRh(o.resultFeedback),i.R7$(2),i.JRh(o.strokeCountInfo),i.R7$(),i.Y8G("ngIf",o.displayMatches.length>0),i.R7$(),i.Y8G("ngIf","wrong"===o.resultStatus&&o.correctAnswer),i.R7$(2),i.JRh(o.dismissButtonText)}}class O{getColorFromHue(s,o,a,t=1){return`hsla(${this.LASSO_HUES[s%this.LASSO_HUES.length]}, ${o}%, ${a}%, ${t})`}getLassoColorFromIndex(s,o=1){return this.getColorFromHue(s,this.themeConfig?.lassoSaturation??55,this.themeConfig?.lassoLightness??78,o)}kanaMatch(s,o){if(s===o||O.CHOON_EQUIVALENTS.has(s)&&O.CHOON_EQUIVALENTS.has(o)||O.WAVE_DASH_EQUIVALENTS.has(s)&&O.WAVE_DASH_EQUIVALENTS.has(o))return!0;const a=O.SMALL_TO_BIG_KANA[s];if(a&&a===o)return!0;const t=O.SMALL_TO_BIG_KANA[o];return!!(t&&t===s||a&&t&&a===t)}constructor(s,o,a,t){var n;this.strokeRecognition=s,this.cardsService=o,this.collectionService=a,this.sanitizer=t,this.isDrawing=!1,this.strokes=[],this.currentStroke=[],this.drawStartTime=0,this.currentCharacter="",this.promptText="",this.promptColor="#FFFFFF",this.noCardsAvailable=!1,this.isChecking=!1,this.showResults=!1,this.resultStatus="",this.resultFeedback="",this.strokeCountInfo="",this.topMatches=[],this.displayMatches=[],this.correctAnswer="",this.cardAvailabilitySubscription=null,this.segmentationTimer=null,this.segmentResult=null,this.SEGMENTATION_DELAY_MS=500,this.segmenter=new i1,this.lassoSvgContent="",this.segmentationSvgContent="",this.lastBatchResults=[],this.themeConfig=null,this.drawMode="brush",this.lassos=[],this.currentLasso=[],this.lassoStartPos=null,this.LASSO_HUES=[0,165,330,135,300,105,270,75,240,45,210,15,180,345,150,315,120,285,90,255,60,225,30,195],this.correctFeedback=["\u6b63\u89e3!","\u307e\u308b!","\u306f\u306a\u307e\u308b!","\u3088\u304f\u3084\u3063\u305f!","\u3059\u3054\u3044!","\u304b\u3093\u307a\u304d!","\u3070\u3063\u3061\u308a!","\u305d\u306e\u8abf\u5b50!"],this.wrongFeedback=["\u3061\u304c\u3046!","\u3056\u3093\u306d\u3093!","\u306f\u305a\u308c!","\u3075\u305b\u3044\u304b\u3044!","\u30d0\u30c4!"],this.checkButtonLabels=["\u3088\u3057!","\u5224\u5b9a!","\u3067\u304d\u305f!","\u3044\u3056!","\u78ba\u8a8d"],this.dismissButtonLabels=["\u6b21!","\u3064\u304e!","\u3088\u3057!","\u30aa\u30c3\u30b1\u30fc!","\u306f\u3044!","\u4e86\u89e3!","\u3044\u304f\u305e!"],this.checkButtonText="",this.dismissButtonText="",this.lastBrushSize=0,n={backspace:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M403.13 96H156.87a44.9 44.9 0 00-33.68 15.27 15.88 15.88 0 00-1.91 2.7L32 247.75a16 16 0 000 16.5l89.15 133.57a16.24 16.24 0 002 2.88 44.89 44.89 0 0033.7 15.3h246.28A44.92 44.92 0 00448 371.13V140.87A44.92 44.92 0 00403.13 96zM348 311a16 16 0 11-22.63 22.62L271.67 280 218 333.65A16 16 0 01195.35 311L249 257.33l-53.69-53.69A16 16 0 01218 181l53.69 53.7 53.67-53.7A16 16 0 01348 203.64l-53.7 53.69z'/></svg>",trashOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/><path stroke-linecap='round' stroke-miterlimit='10' d='M80 112h352' class='ionicon-stroke-width'/><path d='M192 112V72h0a23.93 23.93 0 0124-24h80a23.93 23.93 0 0124 24h0v40M256 176v224M184 176l8 224M328 176l-8 224' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",brushOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M452.37 59.63h0a40.49 40.49 0 00-57.26 0L184 294.74c23.08 4.7 46.12 27.29 49.26 49.26l219.11-227.11a40.49 40.49 0 000-57.26zM138 336c-29.88 0-54 24.5-54 54.86 0 23.95-20.88 36.57-36 36.57C64.56 449.74 92.82 464 120 464c39.78 0 72-32.73 72-73.14 0-30.36-24.12-54.86-54-54.86z' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",ellipseOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><circle cx='256' cy='256' r='192' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",playSkipForwardOutline:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M112 111v290c0 17.44 17 28.52 31 20.16l247.9-148.37c12.12-7.25 12.12-26.33 0-33.58L143 90.84c-14-8.36-31 2.72-31 20.16z' stroke-miterlimit='10' class='ionicon-fill-none ionicon-stroke-width'/><path stroke-linecap='round' stroke-miterlimit='10' d='M400 80v352' class='ionicon-fill-none ionicon-stroke-width'/></svg>"},Object.keys(n).forEach(function(s){J(s,n[s]);var o=s.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();s!==o&&J(o,n[s])})}ngOnInit(){var s=this;return(0,q.A)(function*(){s.checkButtonText=s.randomFrom(s.checkButtonLabels),yield s.cardsService.initialize();const o=s.cardsService.getWorkbookTheme(),a=s.cardsService.getWorkbookThemes();s.themeConfig=a.find(t=>t.id===o)??a[0]??null,s.loadRandomCard(),s.cardAvailabilitySubscription=s.cardsService.cardAvailability$.subscribe(t=>{s.noCardsAvailable&&t>0&&s.loadRandomCard()})})()}loadRandomCard(){this.currentCard=this.cardsService.getRandomUnlockedCard(),this.currentCard?(this.currentCharacter=this.currentCard.answers[0],this.promptText=this.currentCard.prompt,this.promptColor=this.cardsService.getStageColor(this.currentCard.stage),this.noCardsAvailable=!1):(this.noCardsAvailable=!0,this.promptText="",this.promptColor="#FFFFFF")}ngAfterViewInit(){setTimeout(()=>this.setupCanvas(),100)}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.cardAvailabilitySubscription&&this.cardAvailabilitySubscription.unsubscribe(),this.cancelSegmentation()}setupCanvas(){const s=this.canvasRef.nativeElement,o=s.parentElement;o&&(this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(o),this.ctx=s.getContext("2d"),this.setCanvasStyle(),s.addEventListener("mousedown",this.handleMouseDown.bind(this)),s.addEventListener("mousemove",this.handleMouseMove.bind(this)),s.addEventListener("mouseup",this.handleMouseUp.bind(this)),s.addEventListener("mouseleave",this.handleMouseUp.bind(this)),s.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),s.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),s.addEventListener("touchend",this.handleTouchEnd.bind(this)))}resizeCanvas(){const s=this.canvasRef.nativeElement,o=s.parentElement;o&&(s.width=o.clientWidth,s.height=o.clientHeight,this.ctx&&this.setCanvasStyle())}get minBrushSize(){return this.themeConfig?.brush?.minSize??3}get maxBrushSize(){return this.themeConfig?.brush?.maxSize??24}get brushSmoothing(){return this.themeConfig?.brush?.smoothing??.05}get speedResponse(){return this.themeConfig?.brush?.speedResponse??!0}get haraiEnabled(){return this.themeConfig?.brush?.harai??!0}setCanvasStyle(){this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff",this.ctx.lineCap="round",this.ctx.lineJoin="round"}handleMouseDown(s){this.cancelSegmentation(),this.isDrawing=!0;const o=this.getMousePos(s);"lasso"===this.drawMode?(this.lassoStartPos={x:o.x,y:o.y},this.currentLasso=[{x:o.x,y:o.y}]):(this.currentStroke=[o],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(o.x,o.y,1.5*this.minBrushSize))}handleMouseMove(s){if(!this.isDrawing)return;const o=this.getMousePos(s);if("lasso"===this.drawMode)this.currentLasso.push({x:o.x,y:o.y}),this.fullRedraw();else{const a=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(o),this.drawBrushSegment(a,o)}}handleMouseUp(){this.isDrawing&&("lasso"===this.drawMode?(this.lassoStartPos&&this.currentLasso.length>0&&(this.currentLasso.length>=5?this.completeLasso():(this.handleLassoTap(this.lassoStartPos.x,this.lassoStartPos.y),this.currentLasso=[])),this.lassoStartPos=null):this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1)}handleTouchStart(s){s.preventDefault(),this.cancelSegmentation(),this.isDrawing=!0;const o=this.getTouchPos(s);"lasso"===this.drawMode?(this.lassoStartPos={x:o.x,y:o.y},this.currentLasso=[{x:o.x,y:o.y}]):(this.currentStroke=[o],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(o.x,o.y,1.5*this.minBrushSize))}handleTouchMove(s){if(!this.isDrawing)return;s.preventDefault();const o=this.getTouchPos(s);if("lasso"===this.drawMode)this.currentLasso.push({x:o.x,y:o.y}),this.fullRedraw();else{const a=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(o),this.drawBrushSegment(a,o)}}handleTouchEnd(){this.isDrawing&&("lasso"===this.drawMode?(this.lassoStartPos&&this.currentLasso.length>0&&(this.currentLasso.length>=5?this.completeLasso():(this.handleLassoTap(this.lassoStartPos.x,this.lassoStartPos.y),this.currentLasso=[])),this.lassoStartPos=null):this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1)}getMousePos(s){const o=this.canvasRef.nativeElement,a=o.getBoundingClientRect(),t=o.width/a.width,e=o.height/a.height,l=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=l),{x:(s.clientX-a.left)*t,y:(s.clientY-a.top)*e,t:l-this.drawStartTime}}getTouchPos(s){const o=this.canvasRef.nativeElement,a=o.getBoundingClientRect(),t=o.width/a.width,e=o.height/a.height,l=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=l),{x:(s.touches[0].clientX-a.left)*t,y:(s.touches[0].clientY-a.top)*e,t:l-this.drawStartTime}}calculateBrushSize(s,o){if(!this.speedResponse){const w=(this.minBrushSize+this.maxBrushSize)/2;return this.lastBrushSize=w,w}const a=o.x-s.x,t=o.y-s.y,e=Math.max(o.t-s.t,1),r=Math.sqrt(a*a+t*t)/e,g=Math.min(r/1.5,1),v=this.lastBrushSize+(this.maxBrushSize-g*(this.maxBrushSize-this.minBrushSize)-this.lastBrushSize)*this.brushSmoothing;return this.lastBrushSize=v,v}drawBrushPoint(s,o,a){this.ctx.beginPath(),this.ctx.arc(s,o,a/2,0,2*Math.PI),this.ctx.fill()}drawBrushSegment(s,o){const a=this.calculateBrushSize(s,o);this.ctx.lineWidth=a,this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(o.x,o.y),this.ctx.stroke(),this.drawBrushPoint(o.x,o.y,a)}drawHarai(s){if(!this.haraiEnabled||s.length<3)return;const o=Math.min(5,s.length),a=s.slice(-o),t=a[a.length-1],e=a[0],l=t.x-e.x,r=t.y-e.y,g=Math.sqrt(l*l+r*r);if(g<5)return;const c=l/g,v=r/g,w=Math.max(t.t-e.t,1),m=Math.min(g/w*20,40);if(m<8)return;const d=this.lastBrushSize;for(let u=0;u<8;u++){const x=(u+1)/8,M=1-Math.pow(1-u/8,2),f=1-Math.pow(1-x,2),k=t.x+c*m*M,S=t.y+v*m*M,L=t.x+c*m*f,H=t.y+v*m*f,V=d*(1-x);V>.5&&(this.ctx.lineWidth=V,this.ctx.beginPath(),this.ctx.moveTo(k,S),this.ctx.lineTo(L,H),this.ctx.stroke())}}onCheck(){var s=this;return(0,q.A)(function*(){if(0!==s.strokes.length&&s.currentCard){s.isChecking=!0;try{const o=s.canvasRef.nativeElement,a=Math.max(...s.currentCard.answers.map(c=>[...c.replace(/\s+/g,"")].length));let t;if(a>1){const c=s.segmenter.segment({strokes:s.strokes,lassos:s.lassos,canvasWidth:o.width,canvasHeight:o.height,maxCharacters:a});if(s.segmentResult=c,c.characters.length<=1)s.lastBatchResults=[],t=yield s.strokeRecognition.recognize(s.strokes,o.width,o.height);else{const v=c.characters.map(m=>({strokes:m.strokes,bounds:{width:m.bounds.width,height:m.bounds.height}})),w=yield s.strokeRecognition.recognizeBatch(v);s.lastBatchResults=w,t=[{character:w.map(m=>m[0]?.character||"?").join(""),score:100}],console.log("Cell interpretations (Japanese reading order):",w.map((m,h)=>({cell:h,top5:m.slice(0,5).map(d=>d.character)})))}}else s.segmentResult=null,s.lastBatchResults=[],t=yield s.strokeRecognition.recognize(s.strokes,o.width,o.height);s.topMatches=t.slice(0,5);const e=s.currentCard.answers.map(c=>c.replace(/\s+/g,""));let l=!1,r="";if(s.lastBatchResults.length>0){for(const c of e){const v=[...c];if(v.length===s.lastBatchResults.length&&v.every((p,m)=>{const h=s.lastBatchResults[m].slice(0,5).map(u=>u.character),d=h.some(u=>s.kanaMatch(p,u));return console.log(`  Cell ${m}: target='${p}' (code=${p.charCodeAt(0)}), candidates=[${h.map(u=>`'${u}'(${u.charCodeAt(0)})`).join(", ")}], matched=${d}`),d})){l=!0,r=c;break}}console.log("Grading multi-char:",{targets:e,cellResults:s.lastBatchResults.map(c=>c.slice(0,5).map(v=>v.character)),isCorrect:l,matchedAnswer:r})}else{const c=s.topMatches.map(v=>v.character);for(const v of e)if(c.some(w=>s.kanaMatch(v,w))){l=!0,r=v;break}}if(l)s.resultStatus="correct",s.resultFeedback=s.randomFrom(s.correctFeedback),s.displayMatches=[{character:r,score:1}],s.correctAnswer="",s.cardsService.advanceCard(s.currentCard.id);else{let c;if(s.lastBatchResults.length>0)console.log("Checking befuddlers:",s.currentCard.befuddlers.map(v=>({answers:v.answers,toast:v.toast.slice(0,30)}))),c=s.currentCard.befuddlers.find(v=>(console.log("  Befuddler answers:",v.answers),v.answers.some(w=>{const p=[...w.replace(/\s+/g,"")];if(console.log(`    Checking "${w}": ${p.length} chars vs ${s.lastBatchResults.length} cells`),p.length!==s.lastBatchResults.length)return!1;const m=p.every((h,d)=>{const u=s.lastBatchResults[d].slice(0,5).map(x=>x.character),z=u.some(x=>s.kanaMatch(h,x));return console.log(`      Cell ${d}: '${h}' vs [${u.join(",")}] = ${z}`),z});return console.log(`    Result: ${m}`),m})));else{const v=s.topMatches.map(w=>w.character);c=s.currentCard.befuddlers.find(w=>w.answers.some(p=>v.some(m=>s.kanaMatch(p.replace(/\s+/g,""),m))))}c?(s.resultStatus="befuddled",s.resultFeedback=c.toast,s.displayMatches=s.topMatches,s.correctAnswer=""):(s.resultStatus="wrong",s.resultFeedback=s.randomFrom(s.wrongFeedback),s.displayMatches=s.topMatches,s.correctAnswer=s.currentCard.answers[0],s.cardsService.demoteCard(s.currentCard.id))}const g=s.strokeRecognition.getExpectedStrokeCount(s.currentCharacter);s.strokeCountInfo=`Strokes: ${s.strokes.length}/${g}`,s.exportCollectionSample(l)}catch(o){console.error("Recognition error:",o),s.resultStatus="wrong",s.resultFeedback=o.message||"Recognition failed. Please try on a device.",s.topMatches=[],s.displayMatches=[],s.strokeCountInfo=""}s.isChecking=!1,s.checkButtonText=s.randomFrom(s.checkButtonLabels),s.dismissButtonText=s.randomFrom(s.dismissButtonLabels),s.showResults=!0}})()}dismissResults(){this.showResults=!1,this.clearCanvas(),("correct"===this.resultStatus||"wrong"===this.resultStatus)&&this.loadRandomCard()}onSkip(){this.clearCanvas(),this.loadRandomCard()}onUndo(){this.strokes.length>0&&(this.strokes.pop(),this.fullRedraw(),this.scheduleSegmentation())}clearCanvas(){const s=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,s.width,s.height),this.strokes=[],this.lassos=[],this.currentLasso=[],this.drawStartTime=0,this.drawMode="brush",this.cancelSegmentation(),this.segmentResult=null,this.lassoSvgContent="",this.segmentationSvgContent=""}randomFrom(s){return s[Math.floor(Math.random()*s.length)]}setDrawMode(s){this.drawMode=s}onClearAll(){this.clearCanvas(),this.lassos=[]}isPointInPolygon(s,o){if(o.length<3)return!1;let a=!1;for(let t=0,e=o.length-1;t<o.length;e=t++){const l=o[t].x,r=o[t].y,c=o[e].y;r>s.y!=c>s.y&&s.x<(o[e].x-l)*(s.y-r)/(c-r)+l&&(a=!a)}return a}getStrokeColorFromResult(s){if(!this.segmentResult)return this.themeConfig?.defaultColor??"#fff";for(let o=0;o<this.segmentResult.lassos.length;o++)if(this.segmentResult.lassos[o].strokeIndices.includes(s))return this.getLassoColorFromIndex(o);return this.themeConfig?.defaultColor??"#fff"}getLassoIndexForStroke(s){if(!this.segmentResult)return-1;for(let o=0;o<this.segmentResult.lassos.length;o++)if(this.segmentResult.lassos[o].strokeIndices.includes(s))return o;return-1}handleLassoTap(s,o){for(let a=this.lassos.length-1;a>=0;a--)if(this.isPointInPolygon({x:s,y:o},this.lassos[a].points))return this.lassos.splice(a,1),this.analyzeAndVisualize(),!0;return!1}completeLasso(){this.currentLasso.length<3?this.currentLasso=[]:(this.lassos.push({points:[...this.currentLasso]}),this.currentLasso=[],this.analyzeAndVisualize())}drawCurrentLasso(){if(!(this.currentLasso.length<2)){this.ctx.save(),this.ctx.strokeStyle=this.getLassoColorFromIndex(this.lassos.length,.5),this.ctx.lineWidth=2,this.ctx.setLineDash([6,4]),this.ctx.beginPath(),this.ctx.moveTo(this.currentLasso[0].x,this.currentLasso[0].y);for(let s=1;s<this.currentLasso.length;s++)this.ctx.lineTo(this.currentLasso[s].x,this.currentLasso[s].y);this.ctx.stroke(),this.ctx.restore()}}drawStrokeWithColor(s,o){if(0!==s.length){this.ctx.save(),this.ctx.fillStyle=o,this.ctx.strokeStyle=o,this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.ctx.beginPath(),this.ctx.arc(s[0].x,s[0].y,1.5*this.minBrushSize/2,0,2*Math.PI),this.ctx.fill();for(let a=1;a<s.length;a++){const t=this.calculateBrushSize(s[a-1],s[a]);this.ctx.lineWidth=t,this.ctx.beginPath(),this.ctx.moveTo(s[a-1].x,s[a-1].y),this.ctx.lineTo(s[a].x,s[a].y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(s[a].x,s[a].y,t/2,0,2*Math.PI),this.ctx.fill()}if(this.haraiEnabled&&s.length>=3){const a=Math.min(5,s.length),t=s.slice(-a),e=t[t.length-1],l=t[0],r=e.x-l.x,g=e.y-l.y,c=Math.sqrt(r*r+g*g);if(c>=5){const v=r/c,w=g/c,p=Math.max(e.t-l.t,1),h=Math.min(c/p*20,40);if(h>=8){const u=this.lastBrushSize;for(let z=0;z<8;z++){const M=(z+1)/8,f=1-Math.pow(1-z/8,2),k=1-Math.pow(1-M,2),S=e.x+v*h*f,L=e.y+w*h*f,H=e.x+v*h*k,V=e.y+w*h*k,b=u*(1-M);b>.5&&(this.ctx.lineWidth=b,this.ctx.beginPath(),this.ctx.moveTo(S,L),this.ctx.lineTo(H,V),this.ctx.stroke())}}}}this.ctx.restore()}}drawStrokeCandyCane(s,o,a,t){if(0===s.length)return;this.ctx.save(),this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2;let e=0,l=!0;this.ctx.fillStyle=o,this.ctx.strokeStyle=o,this.ctx.beginPath(),this.ctx.arc(s[0].x,s[0].y,1.5*this.minBrushSize/2,0,2*Math.PI),this.ctx.fill();for(let r=1;r<s.length;r++){const g=s[r].x-s[r-1].x,c=s[r].y-s[r-1].y;e+=Math.sqrt(g*g+c*c),e>=t&&(l=!l,e-=t);const w=l?o:a;this.ctx.fillStyle=w,this.ctx.strokeStyle=w;const p=this.calculateBrushSize(s[r-1],s[r]);this.ctx.lineWidth=p,this.ctx.beginPath(),this.ctx.moveTo(s[r-1].x,s[r-1].y),this.ctx.lineTo(s[r].x,s[r].y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(s[r].x,s[r].y,p/2,0,2*Math.PI),this.ctx.fill()}if(this.haraiEnabled&&s.length>=3){const r=Math.min(5,s.length),g=s.slice(-r),c=g[g.length-1],v=g[0],w=c.x-v.x,p=c.y-v.y,m=Math.sqrt(w*w+p*p);if(m>=5){const h=w/m,d=p/m,u=Math.max(c.t-v.t,1),x=Math.min(m/u*20,40);if(x>=8){const f=this.lastBrushSize;for(let k=0;k<8;k++){const L=(k+1)/8,H=1-Math.pow(1-k/8,2),V=1-Math.pow(1-L,2),b=c.x+h*x*H,B=c.y+d*x*H,y=c.x+h*x*V,A=c.y+d*x*V;e+=x*V/8,e>=t&&(l=!l,e-=t),this.ctx.strokeStyle=l?o:a;const e1=f*(1-L);e1>.5&&(this.ctx.lineWidth=e1,this.ctx.beginPath(),this.ctx.moveTo(b,B),this.ctx.lineTo(y,A),this.ctx.stroke())}}}}this.ctx.restore()}fullRedraw(){const s=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,s.width,s.height),this.lassoSvgContent=this.sanitizer.bypassSecurityTrustHtml(this.segmentResult?.lassoSvg??""),this.segmentationSvgContent=this.sanitizer.bypassSecurityTrustHtml(this.segmentResult?.segmentationSvg??""),this.currentLasso.length>1&&this.drawCurrentLasso();const o=this.themeConfig?.defaultColor??"#fff",a="candy-cane"===this.themeConfig?.strokeMode&&this.segmentResult;if(this.segmentResult)for(const t of this.segmentResult.strokes)if(a&&this.themeConfig){const e=this.getLassoIndexForStroke(t.index),l=t.characterIndex,r=this.themeConfig.color1?.saturation??55,g=this.themeConfig.color1?.lightness??78,c=this.themeConfig.color2?.saturation??95,v=this.themeConfig.color2?.lightness??55,p=this.getColorFromHue(e>=0?e:l,r,g),m=this.getColorFromHue(l,c,v);this.drawStrokeCandyCane(this.strokes[t.index],p,m,this.themeConfig.stripeLength??10)}else{const e=this.getStrokeColorFromResult(t.index);this.drawStrokeWithColor(this.strokes[t.index],e)}else if("candy-cane"===this.themeConfig?.strokeMode&&this.themeConfig){const t=this.themeConfig.color1?.saturation??55,e=this.themeConfig.color1?.lightness??78,l=this.themeConfig.color2?.saturation??95,r=this.themeConfig.color2?.lightness??55,g=this.getColorFromHue(0,t,e),c=this.getColorFromHue(0,l,r);for(const v of this.strokes)this.drawStrokeCandyCane(v,g,c,this.themeConfig.stripeLength??10)}else for(const t of this.strokes)this.drawStrokeWithColor(t,o)}scheduleSegmentation(){if(this.cancelSegmentation(),0===this.strokes.length)return this.segmentResult=null,this.lassoSvgContent="",void(this.segmentationSvgContent="");this.segmentationTimer=setTimeout(()=>{this.analyzeAndVisualize()},this.SEGMENTATION_DELAY_MS)}cancelSegmentation(){null!==this.segmentationTimer&&(clearTimeout(this.segmentationTimer),this.segmentationTimer=null)}analyzeAndVisualize(){if(0===this.strokes.length||!this.currentCard)return this.segmentResult=null,void this.fullRedraw();const s=Math.max(...this.currentCard.answers.map(a=>[...a.replace(/\s+/g,"")].length));if(s<=1)return this.segmentResult=null,void this.fullRedraw();const o=this.canvasRef.nativeElement;this.segmentResult=this.segmenter.segment({strokes:this.strokes,lassos:this.lassos,canvasWidth:o.width,canvasHeight:o.height,maxCharacters:s}),this.fullRedraw()}exportCollectionSample(s){if(!this.currentCard||"opted-in"!==this.cardsService.getDataCollectionStatus())return;const o=this.canvasRef.nativeElement;let a=null;this.lastBatchResults.length>0?a=this.lastBatchResults:this.topMatches.length>0&&(a=[this.topMatches]),this.collectionService.exportSample({strokes:this.strokes,canvasWidth:o.width,canvasHeight:o.height,segmentResult:this.segmentResult,answers:this.currentCard.answers,recognitionResults:a,success:s,cardId:this.currentCard.id})}static#s=c1=()=>(this.SMALL_TO_BIG_KANA={\u3063:"\u3064",\u3083:"\u3084",\u3085:"\u3086",\u3087:"\u3088",\u3041:"\u3042",\u3043:"\u3044",\u3045:"\u3046",\u3047:"\u3048",\u3049:"\u304a",\u308e:"\u308f",\u30c3:"\u30c4",\u30e3:"\u30e4",\u30e5:"\u30e6",\u30e7:"\u30e8",\u30a1:"\u30a2",\u30a3:"\u30a4",\u30a5:"\u30a6",\u30a7:"\u30a8",\u30a9:"\u30aa",\u30ee:"\u30ef"},this.CHOON_EQUIVALENTS=new Set(["\u30fc","|","\uff5c"]),this.WAVE_DASH_EQUIVALENTS=new Set(["\u301c","~","\uff5e"]),this.\u0275fac=function(o){return new(o||O)(i.rXU(R1),i.rXU(l1.D),i.rXU(q1),i.rXU(I1.up))},this.\u0275cmp=i.VBU({type:O,selectors:[["app-workbook"]],viewQuery:function(o,a){if(1&o&&i.GBs(T1,5),2&o){let t;i.mGM(t=i.lsd())&&(a.canvasRef=t.first)}},decls:13,vars:12,consts:[["canvas",""],[1,"workbook-content",3,"fullscreen","scrollY"],[1,"prompt-bar"],["color","light"],[1,"prompt-text"],[1,"canvas-wrapper"],["class","drawing-canvas",4,"ngIf"],[1,"lasso-overlay",3,"innerHTML"],[1,"segmentation-overlay",3,"innerHTML"],["class","tool-column",4,"ngIf"],["class","caught-up-box",4,"ngIf"],["class","check-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","results-overlay",3,"click",4,"ngIf"],[1,"drawing-canvas"],[1,"tool-column"],["fill","clear",1,"tool-btn",3,"click"],["name","play-skip-forward-outline"],["name","backspace"],["name","trash-outline"],["name","brush-outline"],["name","ellipse-outline"],[1,"caught-up-box"],[1,"caught-up-title"],[1,"caught-up-message"],["color","primary",1,"check-btn",3,"click","disabled"],["name","crescent",4,"ngIf"],[4,"ngIf"],["name","crescent"],[1,"results-overlay",3,"click"],[1,"results-card",3,"click"],[1,"status-display"],[1,"feedback"],[1,"stroke-info"],["class","matches-section",4,"ngIf"],["class","correct-answer-section",4,"ngIf"],["expand","block",3,"click"],[1,"matches-section"],[1,"matches-title"],[1,"matches-list"],["class","match-item",4,"ngFor","ngForOf"],[1,"match-item"],[1,"match-char"],[1,"correct-answer-section"],[1,"correct-answer-title"],[1,"correct-answer"]],template:function(o,a){1&o&&(i.j41(0,"ion-content",1)(1,"div",2),i.nrm(2,"ion-menu-button",3),i.j41(3,"span",4),i.EFF(4),i.k0s()(),i.j41(5,"div",5),i.DNE(6,P1,2,0,"canvas",6),i.nrm(7,"div",7)(8,"div",8),i.DNE(9,F1,11,4,"div",9)(10,D1,5,0,"div",10),i.k0s(),i.DNE(11,Y1,3,3,"ion-button",11)(12,Q1,14,10,"div",12),i.k0s()),2&o&&(i.Y8G("fullscreen",!0)("scrollY",!1),i.R7$(3),i.xc7("color",a.promptColor),i.R7$(),i.JRh(a.promptText),i.R7$(2),i.Y8G("ngIf",!a.noCardsAvailable),i.R7$(),i.Y8G("innerHTML",a.lassoSvgContent,i.npT),i.R7$(),i.Y8G("innerHTML",a.segmentationSvgContent,i.npT),i.R7$(),i.Y8G("ngIf",!a.noCardsAvailable),i.R7$(),i.Y8G("ngIf",a.noCardsAvailable),i.R7$(),i.Y8G("ngIf",!a.noCardsAvailable),i.R7$(),i.Y8G("ngIf",a.showResults))},dependencies:[I.W9,I.MC,I.Jm,I.iq,I.w2,P.MD,P.Sq,P.bT],styles:[".workbook-content[_ngcontent-%COMP%]{--background: #000}.prompt-bar[_ngcontent-%COMP%]{display:flex;align-items:center;height:144px;background:#111;padding:0 8px}.prompt-text[_ngcontent-%COMP%]{flex:1;text-align:center;font-size:24px;color:#fff;margin-right:40px;white-space:pre-line}.canvas-wrapper[_ngcontent-%COMP%]{position:absolute;inset:144px 0 0;background:#000}.drawing-canvas[_ngcontent-%COMP%]{width:100%;height:100%;touch-action:none;display:block}.lasso-overlay[_ngcontent-%COMP%], .segmentation-overlay[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.tool-column[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:8px}.tool-btn[_ngcontent-%COMP%]{--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:20px}.tool-btn.active[_ngcontent-%COMP%]{--color: #fff;background:#ffffff1a;border-radius:8px}.results-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000e6;display:flex;align-items:center;justify-content:center;z-index:100}.results-card[_ngcontent-%COMP%]{background:#1a1a1a;border-radius:16px;padding:24px;min-width:280px;max-width:90%;text-align:center}.results-card.correct[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.correct[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#e63946}.results-card.befuddled[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.befuddled[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#f7b731}.results-card.wrong[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.wrong[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#4a90d9}.status-display[_ngcontent-%COMP%]{font-size:64px;font-weight:700;margin-bottom:8px}.feedback[_ngcontent-%COMP%]{font-family:Shippori Mincho B1,serif;font-size:18px;margin-bottom:16px;white-space:pre-line}.stroke-info[_ngcontent-%COMP%]{font-size:14px;color:#888;margin-bottom:20px}.matches-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.matches-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.matches-list[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:16px}.match-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.match-char[_ngcontent-%COMP%]{font-size:32px;color:#fff}.correct-answer-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.correct-answer-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.correct-answer[_ngcontent-%COMP%]{font-size:36px;color:#4a90d9}.check-btn[_ngcontent-%COMP%]{position:absolute;bottom:32px;left:50%;transform:translate(-50%);--background: #222;--background-hover: #333;--color: #fff;--border-radius: 32px;--padding-start: 12vw;--padding-end: 12vw;--padding-top: 16px;--padding-bottom: 16px;min-height:60px;font-family:Shippori Mincho B1,serif;font-size:clamp(20px,5vw,28px);font-weight:600;letter-spacing:2px}.results-card[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{font-family:Shippori Mincho B1,serif;font-weight:700}.caught-up-box[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border-radius:16px;padding:32px;text-align:center;max-width:90%;width:320px}.caught-up-title[_ngcontent-%COMP%]{font-size:36px;margin-bottom:16px}.caught-up-message[_ngcontent-%COMP%]{font-size:16px;color:#ccc;line-height:1.5}"]}))}c1();const K1=[{path:"",component:O}];let Z1=(()=>{var n;class s{static#s=n=()=>(this.\u0275fac=function(t){return new(t||s)},this.\u0275mod=i.$C({type:s}),this.\u0275inj=C.G2t({imports:[W.iI.forChild(K1),W.iI]}))}return n(),s})(),s2=(()=>{var n;class s{static#s=n=()=>(this.\u0275fac=function(t){return new(t||s)},this.\u0275mod=i.$C({type:s}),this.\u0275inj=C.G2t({imports:[P.MD,v1.YN,g1.bv,Z1,O]}))}return n(),s})()}}]);