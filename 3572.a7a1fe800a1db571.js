"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3572],{3572(k1,$,S){S.d($,{WorkbookPageModule:()=>z1});var F,q=S(2200),J=S(4341),Q=S(7343),I=S(8132),_=S(467),O=S(6299),X=function(i,e){var m=function(){if(typeof window>"u")return new Map;if(!F){var i=window;i.Ionicons=i.Ionicons||{},F=i.Ionicons.map=i.Ionicons.map||new Map}return F}(),o=m.get(i);void 0===o?m.set(i,e):o!==e&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(i,'". Ensure that multiple icons are not mapped to the same icon name.'))},a=S(3664),V=S(2615),U=S(4185);let a1=(()=>{var i;class e{constructor(o){this.cardsService=o,this.API_URL="https://inputtools.google.com/request?itc=ja-t-i0-handwrit&app=translate"}recognize(o,s,n){var t=this;return(0,_.A)(function*(){if(0===o.length)return[];const r=o.map(l=>{const v=[],c=[],w=[];for(const h of l)v.push(Math.round(h.x)),c.push(Math.round(h.y)),w.push(h.t);return[v,c,w]}),g={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:[{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:n,writing_area_width:s},ink:r}]};try{const v=yield(yield fetch(t.API_URL,{method:"POST",body:JSON.stringify(g),headers:{"Content-Type":"application/json"}})).json();return t.parseResponse(v)}catch(l){throw console.error("Recognition failed:",l),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}recognizeBatch(o){var s=this;return(0,_.A)(function*(){if(0===o.length)return[];const n=o.map(r=>{const g=r.strokes.map(l=>{const v=[],c=[],w=[];for(const h of l)v.push(Math.round(h.x)),c.push(Math.round(h.y)),w.push(h.t);return[v,c,w]});return{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:Math.round(r.bounds.height),writing_area_width:Math.round(r.bounds.width)},ink:g}}),t={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:n};try{const g=yield(yield fetch(s.API_URL,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json();return s.parseBatchResponse(g,o.length)}catch(r){throw console.error("Batch recognition failed:",r),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}parseBatchResponse(o,s){if(!o||"SUCCESS"!==o[0])return Array(s).fill([]);const n=[],t=o[1]||[];for(let r=0;r<s;r++){const g=t[r]?.[1];if(!g||0===g.length){n.push([]);continue}const l=g.map(v=>v.replace(/\s+/g,"")).filter(v=>1===[...v].length).map((v,c)=>({character:v,score:Math.max(100-10*c,10)}));n.push(l)}return n}parseResponse(o){if(!o||"SUCCESS"!==o[0])return[];const s=o[1]?.[0]?.[1];return s&&0!==s.length?s.map((n,t)=>({character:n.replace(/\s+/g,""),score:Math.max(100-10*t,10)})):[]}getExpectedStrokeCount(o){return this.cardsService.getStrokeCount(o)}static#o=i=()=>(this.\u0275fac=function(s){return new(s||e)(V.KVO(U.D))},this.\u0275prov=V.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return i(),e})(),i1=(()=>{var i;class e{constructor(){this.config={minColumnGapRatio:.25,maxColumnAngle:10,minRowGapRatio:.25,maxRowAngle:10,charSizeMultiplier:2,minCharSizeRatio:.08,maxCharSizeRatio:.4},this.MAX_SIZE_RATIO=2}segment(o,s,n){if(0===o.length)return this.emptyResult();const t=o.map((x,z)=>this.calculateStrokeBounds(x,z)),r={minX:Math.min(...t.map(x=>x.minX)),maxX:Math.max(...t.map(x=>x.maxX)),minY:Math.min(...t.map(x=>x.minY)),maxY:Math.max(...t.map(x=>x.maxY))},g=this.estimateCharSize(t,s,"width"),l=this.estimateCharSize(t,n,"height");let v=this.findColumnDividers(t,g,n);v=this.enforceColumnUniformity(v,t,r);const c=this.assignStrokesToColumns(t,v);let w=this.findAllRowDividers(c,t,v,l);w=this.enforceRowUniformity(w,c,t,v);const h=this.enforceColumnsNotExceedRows(v,w,t,l,r);v=h.columnDividers,w=h.rowDividers;const u=this.assignStrokesToColumns(t,v),d=this.createCellGrid(u,t,v,w),p=v.length+1,M=Math.max(...w.map(x=>x.length+1),1);return{grid:{columnDividers:v,rowDividers:w,cells:d,columns:p,maxRows:M},estimatedCharHeight:l,estimatedCharWidth:g}}emptyResult(){return{grid:{columnDividers:[],rowDividers:[],cells:[],columns:0,maxRows:0},estimatedCharHeight:0,estimatedCharWidth:0}}calculateStrokeBounds(o,s){if(0===o.length)return{strokeIndex:s,minX:0,maxX:0,minY:0,maxY:0,centerX:0,centerY:0};let n=1/0,t=-1/0,r=1/0,g=-1/0;for(const l of o)n=Math.min(n,l.x),t=Math.max(t,l.x),r=Math.min(r,l.y),g=Math.max(g,l.y);return{strokeIndex:s,minX:n,maxX:t,minY:r,maxY:g,centerX:(n+t)/2,centerY:(r+g)/2}}estimateCharSize(o,s,n){if(0===o.length)return.15*s;const t=o.map(c=>"width"===n?c.maxX-c.minX:c.maxY-c.minY).filter(c=>c>5);if(0===t.length)return.15*s;t.sort((c,w)=>c-w);let g=t[Math.floor(t.length/2)]*this.config.charSizeMultiplier;return Math.max(s*this.config.minCharSizeRatio,Math.min(s*this.config.maxCharSizeRatio,g))}findColumnDividers(o,s,n){if(o.length<2)return[];const t=Math.min(...o.map(c=>c.minY)),r=Math.max(...o.map(c=>c.maxY)),g=[...o].sort((c,w)=>c.centerX-w.centerX),l=[],v=s*this.config.minColumnGapRatio;for(let c=0;c<g.length-1;c++){const u=g[c].maxX,d=g[c+1].minX,p=d-u;p>=v&&l.push({gapStart:u,gapEnd:d,gapSize:p})}return l.map(c=>({slope:0,intercept:(c.gapStart+c.gapEnd)/2,start:t-10,end:r+10}))}assignStrokesToColumns(o,s){const n=s.length+1,t=Array.from({length:n},()=>[]),r=s.map(g=>g.intercept).sort((g,l)=>g-l);for(const g of o){let l=0;for(let c=0;c<r.length;c++)g.centerX>r[c]&&(l=c+1);t[n-1-l].push(g.strokeIndex)}return t}findAllRowDividers(o,s,n,t){return o.map((r,g)=>{if(r.length<2)return[];const l=r.map(c=>s[c]),v=this.getColumnXBounds(g,n,o.length,l);return this.findRowDividers(l,t,v)})}getColumnXBounds(o,s,n,t){if(0===s.length||0===t.length)return{minX:Math.min(...t.map(h=>h.minX)),maxX:Math.max(...t.map(h=>h.maxX))};const r=s.map(h=>h.intercept).sort((h,u)=>h-u),g=n-1-o,l=Math.min(...t.map(h=>h.minX)),v=Math.max(...t.map(h=>h.maxX));return{minX:g>0?r[g-1]:l,maxX:g<r.length?r[g]:v}}findRowDividers(o,s,n){if(o.length<2)return[];const t=[...o].sort((l,v)=>l.centerY-v.centerY),r=[],g=s*this.config.minRowGapRatio;for(let l=0;l<t.length-1;l++){const w=t[l].maxY,h=t[l+1].minY,u=h-w;u>=g&&r.push({gapStart:w,gapEnd:h,gapSize:u})}return r.map(l=>({slope:0,intercept:(l.gapStart+l.gapEnd)/2,start:n.minX-10,end:n.maxX+10}))}createCellGrid(o,s,n,t){const r=[],g=o.length;for(let l=0;l<g;l++){const v=o[l],c=t[l]||[];if(0===v.length)continue;const w=v.map(M=>s[M]),h=Math.min(...w.map(M=>M.minY)),u=Math.max(...w.map(M=>M.maxY)),d=c.map(M=>M.intercept).sort((M,x)=>M-x),p=d.length+1;for(let M=0;M<p;M++){const x=0===M?h-5:d[M-1],z=M===p-1?u+5:d[M],C=v.filter(f=>{const H=s[f];return H.centerY>=x&&H.centerY<=z});if(0===C.length)continue;const L=C.map(f=>s[f]),k={minX:Math.min(...L.map(f=>f.minX)),maxX:Math.max(...L.map(f=>f.maxX)),minY:Math.min(...L.map(f=>f.minY)),maxY:Math.max(...L.map(f=>f.maxY))};r.push({column:l,row:M,strokeIndices:C,bounds:k})}}return r}calculateRatio(o){if(o.length<=1)return 1;const s=Math.min(...o),n=Math.max(...o);return s>0?n/s:1/0}enforceColumnUniformity(o,s,n){if(0===s.length)return o;let r=[...o];for(let g=0;g<10;g++){const l=r.map(k=>k.intercept).sort((k,f)=>k-f),v=[n.minX,...l,n.maxX],c=[];for(let k=0;k<v.length-1;k++)c.push(v[k+1]-v[k]);if(c.length<=1)break;const w=this.calculateRatio(c);if(w<=this.MAX_SIZE_RATIO)break;let h=null,u=w,d=0,p=-1;const M=c.indexOf(Math.max(...c)),x=(v[M]+v[M+1])/2,z=[...c],C=c[M]/2;z.splice(M,1,C,C);const L=this.calculateRatio(z);if(L<u&&(u=L,h="split",d=x),r.length>0){const k=c.indexOf(Math.min(...c));if(k>0){const f=[...c];f[k-1]+=f[k],f.splice(k,1);const H=this.calculateRatio(f);H<u&&(u=H,h="merge",p=k-1)}if(k<c.length-1){const f=[...c];f[k]+=f[k+1],f.splice(k+1,1);const H=this.calculateRatio(f);H<u&&(u=H,h="merge",p=k)}}if("split"===h)r.push({slope:0,intercept:d,start:n.minY-10,end:n.maxY+10}),r.sort((f,H)=>f.intercept-H.intercept);else{if(!("merge"===h&&p>=0&&p<r.length))break;{const k=[...r].sort((f,H)=>f.intercept-H.intercept);k.splice(p,1),r=k}}}return r}enforceRowUniformity(o,s,n,t){return o.map((g,l)=>{const v=s[l];if(0===v.length)return g;const c=v.map(p=>n[p]),w=Math.min(...c.map(p=>p.minY)),h=Math.max(...c.map(p=>p.maxY)),u=this.getColumnXBounds(l,t,s.length,c);let d=[...g];for(let p=0;p<10;p++){const x=[w,...d.map(B=>B.intercept).sort((B,A)=>B-A),h],z=[];for(let B=0;B<x.length-1;B++)z.push(x[B+1]-x[B]);if(z.length<=1)break;const C=this.calculateRatio(z);if(C<=this.MAX_SIZE_RATIO)break;let L=null,k=C,f=0,H=-1;const j=z.indexOf(Math.max(...z)),P=(x[j]+x[j+1])/2,b=[...z],G=z[j]/2;b.splice(j,1,G,G);const N=this.calculateRatio(b);if(N<k&&(k=N,L="split",f=P),d.length>0){const B=z.indexOf(Math.min(...z));if(B>0){const A=[...z];A[B-1]+=A[B],A.splice(B,1);const y=this.calculateRatio(A);y<k&&(k=y,L="merge",H=B-1)}if(B<z.length-1){const A=[...z];A[B]+=A[B+1],A.splice(B+1,1);const y=this.calculateRatio(A);y<k&&(k=y,L="merge",H=B)}}if("split"===L)d.push({slope:0,intercept:f,start:u.minX-10,end:u.maxX+10}),d.sort((A,y)=>A.intercept-y.intercept);else{if(!("merge"===L&&H>=0&&H<d.length))break;{const B=[...d].sort((A,y)=>A.intercept-y.intercept);B.splice(H,1),d=B}}}return d})}enforceColumnsNotExceedRows(o,s,n,t,r){let l=[...o],v=[...s];for(let c=0;c<10&&!(l.length+1<=Math.max(...v.map(z=>z.length+1),1)||0===l.length);c++){const u=[...l].sort((z,C)=>z.intercept-C.intercept),d=[r.minX,...u.map(z=>z.intercept),r.maxX];let p=0,M=1/0;for(let z=0;z<u.length;z++){const k=d[z+1]-d[z]+(d[z+2]-d[z+1]);k<M&&(M=k,p=z)}u.splice(p,1),l=u;const x=this.assignStrokesToColumns(n,l);v=this.findAllRowDividers(x,n,l,t),v=this.enforceRowUniformity(v,x,n,l)}return{columnDividers:l,rowDividers:v}}static#o=i=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275prov=V.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return i(),e})();const n1=["canvas"];function t1(i,e){1&i&&a.nrm(0,"canvas",11,0)}function l1(i,e){if(1&i){const m=a.RV6();a.j41(0,"ion-button",12),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.onUndo())}),a.nrm(1,"ion-icon",13),a.k0s()}}function c1(i,e){1&i&&(a.j41(0,"div",14)(1,"div",15),a.EFF(2,"\u304a\u3081\u3067\u3068\u3046\u{1f973}"),a.k0s(),a.j41(3,"div",16),a.EFF(4,"You're all caught up. Come back again soon for more lessons!"),a.k0s()())}function e1(i,e){1&i&&a.nrm(0,"ion-spinner",20)}function r1(i,e){if(1&i&&(a.j41(0,"span"),a.EFF(1),a.k0s()),2&i){const m=a.XpG(2);a.R7$(),a.JRh(m.checkButtonText)}}function v1(i,e){if(1&i){const m=a.RV6();a.j41(0,"ion-button",17),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.onCheck())}),a.DNE(1,e1,1,0,"ion-spinner",18)(2,r1,2,1,"span",19),a.k0s()}if(2&i){const m=a.XpG();a.Y8G("disabled",m.isChecking),a.R7$(),a.Y8G("ngIf",m.isChecking),a.R7$(),a.Y8G("ngIf",!m.isChecking)}}function g1(i,e){1&i&&(a.j41(0,"span"),a.EFF(1,"\u25ef"),a.k0s())}function h1(i,e){1&i&&(a.j41(0,"span"),a.EFF(1,"\uff1f"),a.k0s())}function w1(i,e){1&i&&(a.j41(0,"span"),a.EFF(1,"\u2715"),a.k0s())}function d1(i,e){if(1&i&&(a.j41(0,"div",33)(1,"span",34),a.EFF(2),a.k0s()()),2&i){const m=e.$implicit;a.R7$(2),a.JRh(m.character)}}function m1(i,e){if(1&i&&(a.j41(0,"div",29)(1,"div",30),a.EFF(2,"Recognized:"),a.k0s(),a.j41(3,"div",31),a.DNE(4,d1,3,1,"div",32),a.k0s()()),2&i){const m=a.XpG(2);a.R7$(4),a.Y8G("ngForOf",m.displayMatches)}}function p1(i,e){if(1&i&&(a.j41(0,"div",35)(1,"div",36),a.EFF(2,"Answer:"),a.k0s(),a.j41(3,"div",37),a.EFF(4),a.k0s()()),2&i){const m=a.XpG(2);a.R7$(4),a.JRh(m.correctAnswer)}}function x1(i,e){if(1&i){const m=a.RV6();a.j41(0,"div",21),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.dismissResults())}),a.j41(1,"div",22),a.bIt("click",function(s){return V.eBV(m),V.Njj(s.stopPropagation())}),a.j41(2,"div",23),a.DNE(3,g1,2,0,"span",19)(4,h1,2,0,"span",19)(5,w1,2,0,"span",19),a.k0s(),a.j41(6,"div",24),a.EFF(7),a.k0s(),a.j41(8,"div",25),a.EFF(9),a.k0s(),a.DNE(10,m1,5,1,"div",26)(11,p1,5,1,"div",27),a.j41(12,"ion-button",28),a.bIt("click",function(){V.eBV(m);const s=a.XpG();return V.Njj(s.dismissResults())}),a.EFF(13),a.k0s()()()}if(2&i){const m=a.XpG();a.R7$(),a.HbH(m.resultStatus),a.R7$(2),a.Y8G("ngIf","correct"===m.resultStatus),a.R7$(),a.Y8G("ngIf","befuddled"===m.resultStatus),a.R7$(),a.Y8G("ngIf","wrong"===m.resultStatus),a.R7$(2),a.JRh(m.resultFeedback),a.R7$(2),a.JRh(m.strokeCountInfo),a.R7$(),a.Y8G("ngIf",m.displayMatches.length>0),a.R7$(),a.Y8G("ngIf","wrong"===m.resultStatus&&m.correctAnswer),a.R7$(2),a.JRh(m.dismissButtonText)}}let W=(()=>{var i;class e{kanaMatch(o,s){if(o===s)return!0;const n=e.SMALL_TO_BIG_KANA[o];if(n&&n===s)return!0;const t=e.SMALL_TO_BIG_KANA[s];return!!(t&&t===o||n&&t&&n===t)}constructor(o,s,n){this.strokeRecognition=o,this.cardsService=s,this.segmentationService=n,this.isDrawing=!1,this.strokes=[],this.currentStroke=[],this.drawStartTime=0,this.currentCharacter="",this.promptText="",this.promptColor="#FFFFFF",this.noCardsAvailable=!1,this.isChecking=!1,this.showResults=!1,this.resultStatus="",this.resultFeedback="",this.strokeCountInfo="",this.topMatches=[],this.displayMatches=[],this.correctAnswer="",this.cardAvailabilitySubscription=null,this.segmentationTimer=null,this.segmentationResult=null,this.SEGMENTATION_DELAY_MS=500,this.lastBatchResults=[],this.correctFeedback=["\u6b63\u89e3!","\u307e\u308b!","\u306f\u306a\u307e\u308b!","\u3088\u304f\u3084\u3063\u305f!","\u3059\u3054\u3044!","\u304b\u3093\u307a\u304d!","\u3070\u3063\u3061\u308a!","\u305d\u306e\u8abf\u5b50!"],this.wrongFeedback=["\u3061\u304c\u3046!","\u3056\u3093\u306d\u3093!","\u306f\u305a\u308c!","\u3075\u305b\u3044\u304b\u3044!","\u30d0\u30c4!"],this.checkButtonLabels=["\u3088\u3057!","\u5224\u5b9a!","\u3067\u304d\u305f!","\u3044\u3056!","\u78ba\u8a8d"],this.dismissButtonLabels=["\u6b21!","\u3064\u304e!","\u3088\u3057!","\u30aa\u30c3\u30b1\u30fc!","\u306f\u3044!","\u4e86\u89e3!","\u3044\u304f\u305e!"],this.checkButtonText="",this.dismissButtonText="",this.minBrushSize=3,this.maxBrushSize=24,this.brushSmoothing=.05,this.lastBrushSize=0,function(i){Object.keys(i).forEach(function(e){X(e,i[e]);var m=e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();e!==m&&X(m,i[e])})}({backspace:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M403.13 96H156.87a44.9 44.9 0 00-33.68 15.27 15.88 15.88 0 00-1.91 2.7L32 247.75a16 16 0 000 16.5l89.15 133.57a16.24 16.24 0 002 2.88 44.89 44.89 0 0033.7 15.3h246.28A44.92 44.92 0 00448 371.13V140.87A44.92 44.92 0 00403.13 96zM348 311a16 16 0 11-22.63 22.62L271.67 280 218 333.65A16 16 0 01195.35 311L249 257.33l-53.69-53.69A16 16 0 01218 181l53.69 53.7 53.67-53.7A16 16 0 01348 203.64l-53.7 53.69z'/></svg>"})}ngOnInit(){var o=this;return(0,_.A)(function*(){o.checkButtonText=o.randomFrom(o.checkButtonLabels),yield o.cardsService.initialize(),o.loadRandomCard(),o.cardAvailabilitySubscription=o.cardsService.cardAvailability$.subscribe(s=>{o.noCardsAvailable&&s>0&&o.loadRandomCard()})})()}loadRandomCard(){this.currentCard=this.cardsService.getRandomUnlockedCard(),this.currentCard?(this.currentCharacter=this.currentCard.answers[0],this.promptText=this.currentCard.prompt,this.promptColor=this.cardsService.getStageColor(this.currentCard.stage),this.noCardsAvailable=!1):(this.noCardsAvailable=!0,this.promptText="",this.promptColor="#FFFFFF")}ngAfterViewInit(){setTimeout(()=>this.setupCanvas(),100)}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.cardAvailabilitySubscription&&this.cardAvailabilitySubscription.unsubscribe(),this.cancelSegmentation()}setupCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(s),this.ctx=o.getContext("2d"),this.setCanvasStyle(),o.addEventListener("mousedown",this.handleMouseDown.bind(this)),o.addEventListener("mousemove",this.handleMouseMove.bind(this)),o.addEventListener("mouseup",this.handleMouseUp.bind(this)),o.addEventListener("mouseleave",this.handleMouseUp.bind(this)),o.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),o.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),o.addEventListener("touchend",this.handleTouchEnd.bind(this)))}resizeCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(o.width=s.clientWidth,o.height=s.clientHeight,this.ctx&&this.setCanvasStyle())}setCanvasStyle(){this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff",this.ctx.lineCap="round",this.ctx.lineJoin="round"}handleMouseDown(o){this.cancelSegmentation(),this.isDrawing=!0;const s=this.getMousePos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleMouseMove(o){if(!this.isDrawing)return;const s=this.getMousePos(o),n=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(n,s)}handleMouseUp(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}handleTouchStart(o){o.preventDefault(),this.cancelSegmentation(),this.isDrawing=!0;const s=this.getTouchPos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleTouchMove(o){if(!this.isDrawing)return;o.preventDefault();const s=this.getTouchPos(o),n=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(n,s)}handleTouchEnd(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}getMousePos(o){const s=this.canvasRef.nativeElement,n=s.getBoundingClientRect(),t=s.width/n.width,r=s.height/n.height,g=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=g),{x:(o.clientX-n.left)*t,y:(o.clientY-n.top)*r,t:g-this.drawStartTime}}getTouchPos(o){const s=this.canvasRef.nativeElement,n=s.getBoundingClientRect(),t=s.width/n.width,r=s.height/n.height,g=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=g),{x:(o.touches[0].clientX-n.left)*t,y:(o.touches[0].clientY-n.top)*r,t:g-this.drawStartTime}}calculateBrushSize(o,s){const n=s.x-o.x,t=s.y-o.y,r=Math.max(s.t-o.t,1),l=Math.sqrt(n*n+t*t)/r,v=Math.min(l/1.5,1),w=this.lastBrushSize+(this.maxBrushSize-v*(this.maxBrushSize-this.minBrushSize)-this.lastBrushSize)*this.brushSmoothing;return this.lastBrushSize=w,w}drawBrushPoint(o,s,n){this.ctx.beginPath(),this.ctx.arc(o,s,n/2,0,2*Math.PI),this.ctx.fill()}drawBrushSegment(o,s){const n=this.calculateBrushSize(o,s);this.ctx.lineWidth=n,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.drawBrushPoint(s.x,s.y,n)}drawHarai(o){if(o.length<3)return;const s=Math.min(5,o.length),n=o.slice(-s),t=n[n.length-1],r=n[0],g=t.x-r.x,l=t.y-r.y,v=Math.sqrt(g*g+l*l);if(v<5)return;const c=g/v,w=l/v,h=Math.max(t.t-r.t,1),d=Math.min(v/h*20,40);if(d<8)return;const M=this.lastBrushSize;for(let x=0;x<8;x++){const C=(x+1)/8,L=1-Math.pow(1-x/8,2),k=1-Math.pow(1-C,2),f=t.x+c*d*L,H=t.y+w*d*L,j=t.x+c*d*k,P=t.y+w*d*k,b=M*(1-C);b>.5&&(this.ctx.lineWidth=b,this.ctx.beginPath(),this.ctx.moveTo(f,H),this.ctx.lineTo(j,P),this.ctx.stroke())}}onCheck(){var o=this;return(0,_.A)(function*(){if(0!==o.strokes.length&&o.currentCard){o.isChecking=!0;try{const s=o.canvasRef.nativeElement;o.segmentationResult||(o.segmentationResult=o.segmentationService.segment(o.strokes,s.width,s.height));const r=[...o.segmentationResult.grid.cells.filter(w=>w.strokeIndices.length>0)].sort((w,h)=>w.column!==h.column?w.column-h.column:w.row-h.row);let g;if(r.length<=1)o.lastBatchResults=[],g=yield o.strokeRecognition.recognize(o.strokes,s.width,s.height);else{const w=r.map(d=>({strokes:d.strokeIndices.map(z=>o.strokes[z]),bounds:{width:d.bounds.maxX-d.bounds.minX,height:d.bounds.maxY-d.bounds.minY}})),h=yield o.strokeRecognition.recognizeBatch(w);o.lastBatchResults=h,g=[{character:h.map(d=>d[0]?.character||"?").join(""),score:100}],console.log("Cell interpretations (Japanese reading order):",h.map((d,p)=>({cell:p,position:`col ${r[p].column}, row ${r[p].row}`,top5:d.slice(0,5).map(M=>M.character)})))}o.topMatches=g.slice(0,5);const l=o.currentCard.answers.map(w=>w.replace(/\s+/g,""));let v=!1;if(o.lastBatchResults.length>0)v=l.some(w=>{const h=[...w];return h.length===o.lastBatchResults.length&&h.every((u,d)=>{const p=o.lastBatchResults[d].slice(0,5).map(x=>x.character),M=p.some(x=>o.kanaMatch(u,x));return console.log(`  Cell ${d}: target='${u}' (code=${u.charCodeAt(0)}), candidates=[${p.map(x=>`'${x}'(${x.charCodeAt(0)})`).join(", ")}], matched=${M}`),M})}),console.log("Grading multi-char:",{targets:l,cellResults:o.lastBatchResults.map(w=>w.slice(0,5).map(h=>h.character)),isCorrect:v});else{const w=o.topMatches.map(h=>h.character);v=l.some(h=>w.some(u=>o.kanaMatch(h,u)))}if(v)o.resultStatus="correct",o.resultFeedback=o.randomFrom(o.correctFeedback),o.displayMatches=o.topMatches.slice(0,1),o.correctAnswer="",o.cardsService.advanceCard(o.currentCard.id);else{let w;if(o.lastBatchResults.length>0)console.log("Checking befuddlers:",o.currentCard.befuddlers.map(h=>({answers:h.answers,toast:h.toast.slice(0,30)}))),w=o.currentCard.befuddlers.find(h=>(console.log("  Befuddler answers:",h.answers),h.answers.some(u=>{const d=[...u.replace(/\s+/g,"")];if(console.log(`    Checking "${u}": ${d.length} chars vs ${o.lastBatchResults.length} cells`),d.length!==o.lastBatchResults.length)return!1;const p=d.every((M,x)=>{const z=o.lastBatchResults[x].slice(0,5).map(L=>L.character),C=z.some(L=>o.kanaMatch(M,L));return console.log(`      Cell ${x}: '${M}' vs [${z.join(",")}] = ${C}`),C});return console.log(`    Result: ${p}`),p})));else{const h=o.topMatches.map(u=>u.character);w=o.currentCard.befuddlers.find(u=>u.answers.some(d=>h.some(p=>o.kanaMatch(d.replace(/\s+/g,""),p))))}w?(o.resultStatus="befuddled",o.resultFeedback=w.toast,o.displayMatches=o.topMatches,o.correctAnswer=""):(o.resultStatus="wrong",o.resultFeedback=o.randomFrom(o.wrongFeedback),o.displayMatches=o.topMatches,o.correctAnswer=o.currentCard.answers[0])}const c=o.strokeRecognition.getExpectedStrokeCount(o.currentCharacter);o.strokeCountInfo=`Strokes: ${o.strokes.length}/${c}`}catch(s){console.error("Recognition error:",s),o.resultStatus="wrong",o.resultFeedback=s.message||"Recognition failed. Please try on a device.",o.topMatches=[],o.displayMatches=[],o.strokeCountInfo=""}o.isChecking=!1,o.checkButtonText=o.randomFrom(o.checkButtonLabels),o.dismissButtonText=o.randomFrom(o.dismissButtonLabels),o.showResults=!0}})()}dismissResults(){this.showResults=!1,this.clearCanvas(),("correct"===this.resultStatus||"wrong"===this.resultStatus)&&this.loadRandomCard()}onUndo(){this.strokes.length>0&&(this.strokes.pop(),this.redrawStrokes(),this.scheduleSegmentation())}redrawStrokes(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.setCanvasStyle();for(const s of this.strokes)if(0!==s.length){this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s[0].x,s[0].y,1.5*this.minBrushSize);for(let n=1;n<s.length;n++)this.drawBrushSegment(s[n-1],s[n]);this.drawHarai(s)}}clearCanvas(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.strokes=[],this.drawStartTime=0,this.cancelSegmentation(),this.segmentationResult=null}randomFrom(o){return o[Math.floor(Math.random()*o.length)]}scheduleSegmentation(){this.cancelSegmentation(),0!==this.strokes.length?this.segmentationTimer=setTimeout(()=>{this.analyzeAndVisualize()},this.SEGMENTATION_DELAY_MS):this.segmentationResult=null}cancelSegmentation(){null!==this.segmentationTimer&&(clearTimeout(this.segmentationTimer),this.segmentationTimer=null)}analyzeAndVisualize(){if(0===this.strokes.length)return void(this.segmentationResult=null);const o=this.canvasRef.nativeElement;this.segmentationResult=this.segmentationService.segment(this.strokes,o.width,o.height),this.redrawWithBoundaries()}redrawWithBoundaries(){if(this.redrawStrokes(),this.segmentationResult){const o=this.segmentationResult.grid;(o.columnDividers.length>0||o.rowDividers.some(n=>n.length>0))&&this.drawDividers(o)}}drawDividers(o){this.ctx.save(),this.ctx.strokeStyle="rgba(128, 128, 128, 0.4)",this.ctx.lineWidth=1,this.ctx.setLineDash([4,4]);for(const s of o.columnDividers){const n=s.start,t=s.end,r=s.slope*n+s.intercept,g=s.slope*t+s.intercept;this.ctx.beginPath(),this.ctx.moveTo(r,n),this.ctx.lineTo(g,t),this.ctx.stroke()}for(const s of o.rowDividers)for(const n of s){const t=n.start,r=n.end,g=n.slope*t+n.intercept,l=n.slope*r+n.intercept;this.ctx.beginPath(),this.ctx.moveTo(t,g),this.ctx.lineTo(r,l),this.ctx.stroke()}this.ctx.restore()}static#o=i=()=>(this.SMALL_TO_BIG_KANA={\u3063:"\u3064",\u3083:"\u3084",\u3085:"\u3086",\u3087:"\u3088",\u3041:"\u3042",\u3043:"\u3044",\u3045:"\u3046",\u3047:"\u3048",\u3049:"\u304a",\u308e:"\u308f",\u30c3:"\u30c4",\u30e3:"\u30e4",\u30e5:"\u30e6",\u30e7:"\u30e8",\u30a1:"\u30a2",\u30a3:"\u30a4",\u30a5:"\u30a6",\u30a7:"\u30a8",\u30a9:"\u30aa",\u30ee:"\u30ef"},this.\u0275fac=function(s){return new(s||e)(a.rXU(a1),a.rXU(U.D),a.rXU(i1))},this.\u0275cmp=a.VBU({type:e,selectors:[["app-workbook"]],viewQuery:function(s,n){if(1&s&&a.GBs(n1,5),2&s){let t;a.mGM(t=a.lsd())&&(n.canvasRef=t.first)}},decls:11,vars:10,consts:[["canvas",""],[1,"workbook-content",3,"fullscreen","scrollY"],[1,"prompt-bar"],["color","light"],[1,"prompt-text"],[1,"canvas-wrapper"],["class","drawing-canvas",4,"ngIf"],["class","undo-btn","fill","clear",3,"click",4,"ngIf"],["class","caught-up-box",4,"ngIf"],["class","check-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","results-overlay",3,"click",4,"ngIf"],[1,"drawing-canvas"],["fill","clear",1,"undo-btn",3,"click"],["name","backspace"],[1,"caught-up-box"],[1,"caught-up-title"],[1,"caught-up-message"],["color","primary",1,"check-btn",3,"click","disabled"],["name","crescent",4,"ngIf"],[4,"ngIf"],["name","crescent"],[1,"results-overlay",3,"click"],[1,"results-card",3,"click"],[1,"status-display"],[1,"feedback"],[1,"stroke-info"],["class","matches-section",4,"ngIf"],["class","correct-answer-section",4,"ngIf"],["expand","block",3,"click"],[1,"matches-section"],[1,"matches-title"],[1,"matches-list"],["class","match-item",4,"ngFor","ngForOf"],[1,"match-item"],[1,"match-char"],[1,"correct-answer-section"],[1,"correct-answer-title"],[1,"correct-answer"]],template:function(s,n){1&s&&(a.j41(0,"ion-content",1)(1,"div",2),a.nrm(2,"ion-menu-button",3),a.j41(3,"span",4),a.EFF(4),a.k0s()(),a.j41(5,"div",5),a.DNE(6,t1,2,0,"canvas",6)(7,l1,2,0,"ion-button",7)(8,c1,5,0,"div",8),a.k0s(),a.DNE(9,v1,3,3,"ion-button",9)(10,x1,14,10,"div",10),a.k0s()),2&s&&(a.Y8G("fullscreen",!0)("scrollY",!1),a.R7$(3),a.xc7("color",n.promptColor),a.R7$(),a.JRh(n.promptText),a.R7$(2),a.Y8G("ngIf",!n.noCardsAvailable),a.R7$(),a.Y8G("ngIf",!n.noCardsAvailable),a.R7$(),a.Y8G("ngIf",n.noCardsAvailable),a.R7$(),a.Y8G("ngIf",!n.noCardsAvailable),a.R7$(),a.Y8G("ngIf",n.showResults))},dependencies:[O.W9,O.MC,O.Jm,O.iq,O.w2,q.MD,q.Sq,q.bT],styles:[".workbook-content[_ngcontent-%COMP%]{--background: #000}.prompt-bar[_ngcontent-%COMP%]{display:flex;align-items:center;height:144px;background:#111;padding:0 8px}.prompt-text[_ngcontent-%COMP%]{flex:1;text-align:center;font-size:24px;color:#fff;margin-right:40px;white-space:pre-line}.canvas-wrapper[_ngcontent-%COMP%]{position:absolute;inset:144px 0 0;background:#000}.drawing-canvas[_ngcontent-%COMP%]{width:100%;height:100%;touch-action:none;display:block}.undo-btn[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:24px}.results-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000e6;display:flex;align-items:center;justify-content:center;z-index:100}.results-card[_ngcontent-%COMP%]{background:#1a1a1a;border-radius:16px;padding:24px;min-width:280px;max-width:90%;text-align:center}.results-card.correct[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.correct[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#e63946}.results-card.befuddled[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.befuddled[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#f7b731}.results-card.wrong[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.wrong[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#4a90d9}.status-display[_ngcontent-%COMP%]{font-size:64px;font-weight:700;margin-bottom:8px}.feedback[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-size:18px;margin-bottom:16px;white-space:pre-line}.stroke-info[_ngcontent-%COMP%]{font-size:14px;color:#888;margin-bottom:20px}.matches-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.matches-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.matches-list[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:16px}.match-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.match-char[_ngcontent-%COMP%]{font-size:32px;color:#fff}.correct-answer-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.correct-answer-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.correct-answer[_ngcontent-%COMP%]{font-size:36px;color:#4a90d9}.check-btn[_ngcontent-%COMP%]{position:absolute;bottom:32px;left:50%;transform:translate(-50%);--background: #222;--background-hover: #333;--color: #fff;--border-radius: 32px;--padding-start: 12vw;--padding-end: 12vw;--padding-top: 16px;--padding-bottom: 16px;min-height:60px;font-family:Shippori Mincho,serif;font-size:clamp(20px,5vw,28px);font-weight:600;letter-spacing:2px}.results-card[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-weight:700}.caught-up-box[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border-radius:16px;padding:32px;text-align:center;max-width:90%;width:320px}.caught-up-title[_ngcontent-%COMP%]{font-size:36px;margin-bottom:16px}.caught-up-message[_ngcontent-%COMP%]{font-size:16px;color:#ccc;line-height:1.5}"]}))}return i(),e})();const u1=[{path:"",component:W}];let M1=(()=>{var i;class e{static#o=i=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275mod=a.$C({type:e}),this.\u0275inj=V.G2t({imports:[I.iI.forChild(u1),I.iI]}))}return i(),e})(),z1=(()=>{var i;class e{static#o=i=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275mod=a.$C({type:e}),this.\u0275inj=V.G2t({imports:[q.MD,J.YN,Q.bv,M1,W]}))}return i(),e})()}}]);