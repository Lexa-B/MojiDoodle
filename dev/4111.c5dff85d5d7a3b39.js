"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4111],{4111(f1,$,S){S.d($,{WorkbookPageModule:()=>k1});var D,q=S(2200),J=S(4341),K=S(7343),P=S(8132),j=S(467),b=S(6299),U=function(n,e){var d=function(){if(typeof window>"u")return new Map;if(!D){var n=window;n.Ionicons=n.Ionicons||{},D=n.Ionicons.map=n.Ionicons.map||new Map}return D}(),o=d.get(n);void 0===o?d.set(n,e):o!==e&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(n,'". Ensure that multiple icons are not mapped to the same icon name.'))},a=S(3664),H=S(2615),Y=S(4185);let a1=(()=>{var n;class e{constructor(o){this.cardsService=o,this.API_URL="https://inputtools.google.com/request?itc=ja-t-i0-handwrit&app=translate"}recognize(o,s,i){var t=this;return(0,j.A)(function*(){if(0===o.length)return[];const v=o.map(r=>{const c=[],l=[],w=[];for(const h of r)c.push(Math.round(h.x)),l.push(Math.round(h.y)),w.push(h.t);return[c,l,w]}),g={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:[{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:i,writing_area_width:s},ink:v}]};try{const c=yield(yield fetch(t.API_URL,{method:"POST",body:JSON.stringify(g),headers:{"Content-Type":"application/json"}})).json();return t.parseResponse(c)}catch(r){throw console.error("Recognition failed:",r),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}recognizeBatch(o){var s=this;return(0,j.A)(function*(){if(0===o.length)return[];const i=o.map(v=>{const g=v.strokes.map(r=>{const c=[],l=[],w=[];for(const h of r)c.push(Math.round(h.x)),l.push(Math.round(h.y)),w.push(h.t);return[c,l,w]});return{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:Math.round(v.bounds.height),writing_area_width:Math.round(v.bounds.width)},ink:g}}),t={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:i};try{const g=yield(yield fetch(s.API_URL,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json();return s.parseBatchResponse(g,o.length)}catch(v){throw console.error("Batch recognition failed:",v),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}parseBatchResponse(o,s){if(!o||"SUCCESS"!==o[0])return Array(s).fill([]);const i=[],t=o[1]||[];for(let v=0;v<s;v++){const g=t[v]?.[1];if(!g||0===g.length){i.push([]);continue}const r=g.map(c=>c.replace(/\s+/g,"")).filter(c=>1===[...c].length).map((c,l)=>({character:c,score:Math.max(100-10*l,10)}));i.push(r)}return i}parseResponse(o){if(!o||"SUCCESS"!==o[0])return[];const s=o[1]?.[0]?.[1];return s&&0!==s.length?s.map((i,t)=>({character:i.replace(/\s+/g,""),score:Math.max(100-10*t,10)})):[]}getExpectedStrokeCount(o){return this.cardsService.getStrokeCount(o)}static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)(H.KVO(Y.D))},this.\u0275prov=H.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return n(),e})(),i1=(()=>{var n;class e{constructor(){this.config={minColumnGapRatio:.25,maxColumnAngle:10,minRowGapRatio:.25,maxRowAngle:10,charSizeMultiplier:2,minCharSizeRatio:.08,maxCharSizeRatio:.4},this.MAX_SIZE_RATIO=2}segment(o,s,i){if(0===o.length)return this.emptyResult();const t=o.map((k,u)=>this.calculateStrokeBounds(k,u)),v={minX:Math.min(...t.map(k=>k.minX)),maxX:Math.max(...t.map(k=>k.maxX)),minY:Math.min(...t.map(k=>k.minY)),maxY:Math.max(...t.map(k=>k.maxY))},g=this.estimateCharSize(t,s,"width"),r=this.estimateCharSize(t,i,"height");let c=this.findColumnDividers(t,g,i);c=this.enforceColumnUniformity(c,t,v);const l=this.assignStrokesToColumns(t,c);let w=this.findAllRowDividers(l,t,c,r);w=this.enforceRowUniformity(w,l,t,c);const h=this.enforceColumnsNotExceedRows(c,w,t,r,v);c=h.columnDividers,w=h.rowDividers;const m=this.assignStrokesToColumns(t,c),p=this.createCellGrid(m,t,c,w),x=c.length+1,z=Math.max(...w.map(k=>k.length+1),1);return{grid:{columnDividers:c,rowDividers:w,cells:p,columns:x,maxRows:z},estimatedCharHeight:r,estimatedCharWidth:g}}emptyResult(){return{grid:{columnDividers:[],rowDividers:[],cells:[],columns:0,maxRows:0},estimatedCharHeight:0,estimatedCharWidth:0}}calculateStrokeBounds(o,s){if(0===o.length)return{strokeIndex:s,minX:0,maxX:0,minY:0,maxY:0,centerX:0,centerY:0};let i=1/0,t=-1/0,v=1/0,g=-1/0;for(const r of o)i=Math.min(i,r.x),t=Math.max(t,r.x),v=Math.min(v,r.y),g=Math.max(g,r.y);return{strokeIndex:s,minX:i,maxX:t,minY:v,maxY:g,centerX:(i+t)/2,centerY:(v+g)/2}}estimateCharSize(o,s,i){if(0===o.length)return.15*s;const t=o.map(l=>"width"===i?l.maxX-l.minX:l.maxY-l.minY).filter(l=>l>5);if(0===t.length)return.15*s;t.sort((l,w)=>l-w);let g=t[Math.floor(t.length/2)]*this.config.charSizeMultiplier;return Math.max(s*this.config.minCharSizeRatio,Math.min(s*this.config.maxCharSizeRatio,g))}findColumnDividers(o,s,i){if(o.length<2)return[];const t=Math.min(...o.map(l=>l.minY)),v=Math.max(...o.map(l=>l.maxY)),g=[...o].sort((l,w)=>l.centerX-w.centerX),r=[],c=s*this.config.minColumnGapRatio;for(let l=0;l<g.length-1;l++){const m=g[l].maxX,p=g[l+1].minX,x=p-m;x>=c&&r.push({gapStart:m,gapEnd:p,gapSize:x})}return r.map(l=>({slope:0,intercept:(l.gapStart+l.gapEnd)/2,start:t-10,end:v+10}))}assignStrokesToColumns(o,s){const i=s.length+1,t=Array.from({length:i},()=>[]),v=s.map(g=>g.intercept).sort((g,r)=>g-r);for(const g of o){let r=0;for(let l=0;l<v.length;l++)g.centerX>v[l]&&(r=l+1);t[i-1-r].push(g.strokeIndex)}return t}findAllRowDividers(o,s,i,t){return o.map((v,g)=>{if(v.length<2)return[];const r=v.map(l=>s[l]),c=this.getColumnXBounds(g,i,o.length,r);return this.findRowDividers(r,t,c)})}getColumnXBounds(o,s,i,t){if(0===s.length||0===t.length)return{minX:Math.min(...t.map(h=>h.minX)),maxX:Math.max(...t.map(h=>h.maxX))};const v=s.map(h=>h.intercept).sort((h,m)=>h-m),g=i-1-o,r=Math.min(...t.map(h=>h.minX)),c=Math.max(...t.map(h=>h.maxX));return{minX:g>0?v[g-1]:r,maxX:g<v.length?v[g]:c}}findRowDividers(o,s,i){if(o.length<2)return[];const t=[...o].sort((r,c)=>r.centerY-c.centerY),v=[],g=s*this.config.minRowGapRatio;for(let r=0;r<t.length-1;r++){const w=t[r].maxY,h=t[r+1].minY,m=h-w;m>=g&&v.push({gapStart:w,gapEnd:h,gapSize:m})}return v.map(r=>({slope:0,intercept:(r.gapStart+r.gapEnd)/2,start:i.minX-10,end:i.maxX+10}))}createCellGrid(o,s,i,t){const v=[],g=o.length;for(let r=0;r<g;r++){const c=o[r],l=t[r]||[];if(0===c.length)continue;const w=c.map(z=>s[z]),h=Math.min(...w.map(z=>z.minY)),m=Math.max(...w.map(z=>z.maxY)),p=l.map(z=>z.intercept).sort((z,k)=>z-k),x=p.length+1;for(let z=0;z<x;z++){const k=0===z?h-5:p[z-1],u=z===x-1?m+5:p[z],V=c.filter(f=>{const L=s[f];return L.centerY>=k&&L.centerY<=u});if(0===V.length)continue;const C=V.map(f=>s[f]),M={minX:Math.min(...C.map(f=>f.minX)),maxX:Math.max(...C.map(f=>f.maxX)),minY:Math.min(...C.map(f=>f.minY)),maxY:Math.max(...C.map(f=>f.maxY))};v.push({column:r,row:z,strokeIndices:V,bounds:M})}}return v}calculateRatio(o){if(o.length<=1)return 1;const s=Math.min(...o),i=Math.max(...o);return s>0?i/s:1/0}enforceColumnUniformity(o,s,i){if(0===s.length)return o;let v=[...o];for(let g=0;g<10;g++){const r=v.map(M=>M.intercept).sort((M,f)=>M-f),c=[i.minX,...r,i.maxX],l=[];for(let M=0;M<c.length-1;M++)l.push(c[M+1]-c[M]);if(l.length<=1)break;const w=this.calculateRatio(l);if(w<=this.MAX_SIZE_RATIO)break;let h=null,m=w,p=0,x=-1;const z=l.indexOf(Math.max(...l)),k=(c[z]+c[z+1])/2,u=[...l],V=l[z]/2;u.splice(z,1,V,V);const C=this.calculateRatio(u);if(C<m&&(m=C,h="split",p=k),v.length>0){const M=l.indexOf(Math.min(...l));if(M>0){const f=[...l];f[M-1]+=f[M],f.splice(M,1);const L=this.calculateRatio(f);L<m&&(m=L,h="merge",x=M-1)}if(M<l.length-1){const f=[...l];f[M]+=f[M+1],f.splice(M+1,1);const L=this.calculateRatio(f);L<m&&(m=L,h="merge",x=M)}}if("split"===h)v.push({slope:0,intercept:p,start:i.minY-10,end:i.maxY+10}),v.sort((f,L)=>f.intercept-L.intercept);else{if(!("merge"===h&&x>=0&&x<v.length))break;{const M=[...v].sort((f,L)=>f.intercept-L.intercept);M.splice(x,1),v=M}}}return v}enforceRowUniformity(o,s,i,t){return o.map((g,r)=>{const c=s[r];if(0===c.length)return g;const l=c.map(x=>i[x]),w=Math.min(...l.map(x=>x.minY)),h=Math.max(...l.map(x=>x.maxY)),m=this.getColumnXBounds(r,t,s.length,l);let p=[...g];for(let x=0;x<10;x++){const k=[w,...p.map(B=>B.intercept).sort((B,A)=>B-A),h],u=[];for(let B=0;B<k.length-1;B++)u.push(k[B+1]-k[B]);if(u.length<=1)break;const V=this.calculateRatio(u);if(V<=this.MAX_SIZE_RATIO)break;let C=null,M=V,f=0,L=-1;const O=u.indexOf(Math.max(...u)),I=(k[O]+k[O+1])/2,_=[...u],G=u[O]/2;_.splice(O,1,G,G);const N=this.calculateRatio(_);if(N<M&&(M=N,C="split",f=I),p.length>0){const B=u.indexOf(Math.min(...u));if(B>0){const A=[...u];A[B-1]+=A[B],A.splice(B,1);const y=this.calculateRatio(A);y<M&&(M=y,C="merge",L=B-1)}if(B<u.length-1){const A=[...u];A[B]+=A[B+1],A.splice(B+1,1);const y=this.calculateRatio(A);y<M&&(M=y,C="merge",L=B)}}if("split"===C)p.push({slope:0,intercept:f,start:m.minX-10,end:m.maxX+10}),p.sort((A,y)=>A.intercept-y.intercept);else{if(!("merge"===C&&L>=0&&L<p.length))break;{const B=[...p].sort((A,y)=>A.intercept-y.intercept);B.splice(L,1),p=B}}}return p})}enforceColumnsNotExceedRows(o,s,i,t,v){let r=[...o],c=[...s];for(let l=0;l<10&&!(r.length+1<=Math.max(...c.map(u=>u.length+1),1)||0===r.length);l++){const m=[...r].sort((u,V)=>u.intercept-V.intercept),p=[v.minX,...m.map(u=>u.intercept),v.maxX];let x=0,z=1/0;for(let u=0;u<m.length;u++){const M=p[u+1]-p[u]+(p[u+2]-p[u+1]);M<z&&(z=M,x=u)}m.splice(x,1),r=m;const k=this.assignStrokesToColumns(i,r);c=this.findAllRowDividers(k,i,r,t),c=this.enforceRowUniformity(c,k,i,r)}return{columnDividers:r,rowDividers:c}}static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275prov=H.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return n(),e})(),n1=(()=>{var n;class e{constructor(){this.USER_ID_KEY="mojidoodle_collection_user_id",this.WORKER_URL="https://mojidoodle.lexa.digital/collect"}getUserId(){let o=localStorage.getItem(this.USER_ID_KEY);return o||(o=this.generateUUID(),localStorage.setItem(this.USER_ID_KEY,o)),o}exportSample(o){var s=this;return(0,j.A)(function*(){const i=s.buildSample(o);try{yield s.sendToWorker(i)}catch(t){console.error("Failed to send to worker:",t)}})()}sendToWorker(o){var s=this;return(0,j.A)(function*(){const i=yield fetch(s.WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw new Error(`Worker returned ${i.status}: ${i.statusText}`);const t=yield i.json();console.log("Sample sent to worker:",t)})()}buildSample(o){const{strokes:s,canvasWidth:i,canvasHeight:t,segmentationResult:v,sortedCells:g,answers:r,recognitionResults:c,success:l,cardId:w}=o;let h=null;v&&(h={columnDividers:v.grid.columnDividers,rowDividers:v.grid.rowDividers});let m=null;return l&&(m=this.inferGroundTruth(s,g,r)),{strokes:s,canvasWidth:i,canvasHeight:t,segmentation:h,selectionLassos:null,answers:r,recognitionResults:c,groundTruth:m,success:l,id:this.generateUUID(),userId:this.getUserId(),cardId:w,timestamp:Date.now()}}inferGroundTruth(o,s,i){const v=[...i[0].replace(/\s+/g,"")];return s.length<=1?[{strokeIndices:o.map((g,r)=>r),character:v[0]||""}]:s.map((g,r)=>({strokeIndices:g.strokeIndices,character:v[r]||""}))}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const s=16*Math.random()|0;return("x"===o?s:3&s|8).toString(16)})}static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275prov=H.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return n(),e})();const t1=["canvas"];function l1(n,e){1&n&&a.nrm(0,"canvas",11,0)}function c1(n,e){if(1&n){const d=a.RV6();a.j41(0,"ion-button",12),a.bIt("click",function(){H.eBV(d);const s=a.XpG();return H.Njj(s.onUndo())}),a.nrm(1,"ion-icon",13),a.k0s()}}function e1(n,e){1&n&&(a.j41(0,"div",14)(1,"div",15),a.EFF(2,"\u304a\u3081\u3067\u3068\u3046\u{1f973}"),a.k0s(),a.j41(3,"div",16),a.EFF(4,"You're all caught up. Come back again soon for more lessons!"),a.k0s()())}function r1(n,e){1&n&&a.nrm(0,"ion-spinner",20)}function v1(n,e){if(1&n&&(a.j41(0,"span"),a.EFF(1),a.k0s()),2&n){const d=a.XpG(2);a.R7$(),a.JRh(d.checkButtonText)}}function g1(n,e){if(1&n){const d=a.RV6();a.j41(0,"ion-button",17),a.bIt("click",function(){H.eBV(d);const s=a.XpG();return H.Njj(s.onCheck())}),a.DNE(1,r1,1,0,"ion-spinner",18)(2,v1,2,1,"span",19),a.k0s()}if(2&n){const d=a.XpG();a.Y8G("disabled",d.isChecking),a.R7$(),a.Y8G("ngIf",d.isChecking),a.R7$(),a.Y8G("ngIf",!d.isChecking)}}function h1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\u25ef"),a.k0s())}function w1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\uff1f"),a.k0s())}function d1(n,e){1&n&&(a.j41(0,"span"),a.EFF(1,"\u2715"),a.k0s())}function m1(n,e){if(1&n&&(a.j41(0,"div",33)(1,"span",34),a.EFF(2),a.k0s()()),2&n){const d=e.$implicit;a.R7$(2),a.JRh(d.character)}}function p1(n,e){if(1&n&&(a.j41(0,"div",29)(1,"div",30),a.EFF(2,"Recognized:"),a.k0s(),a.j41(3,"div",31),a.DNE(4,m1,3,1,"div",32),a.k0s()()),2&n){const d=a.XpG(2);a.R7$(4),a.Y8G("ngForOf",d.displayMatches)}}function x1(n,e){if(1&n&&(a.j41(0,"div",35)(1,"div",36),a.EFF(2,"Answer:"),a.k0s(),a.j41(3,"div",37),a.EFF(4),a.k0s()()),2&n){const d=a.XpG(2);a.R7$(4),a.JRh(d.correctAnswer)}}function u1(n,e){if(1&n){const d=a.RV6();a.j41(0,"div",21),a.bIt("click",function(){H.eBV(d);const s=a.XpG();return H.Njj(s.dismissResults())}),a.j41(1,"div",22),a.bIt("click",function(s){return H.eBV(d),H.Njj(s.stopPropagation())}),a.j41(2,"div",23),a.DNE(3,h1,2,0,"span",19)(4,w1,2,0,"span",19)(5,d1,2,0,"span",19),a.k0s(),a.j41(6,"div",24),a.EFF(7),a.k0s(),a.j41(8,"div",25),a.EFF(9),a.k0s(),a.DNE(10,p1,5,1,"div",26)(11,x1,5,1,"div",27),a.j41(12,"ion-button",28),a.bIt("click",function(){H.eBV(d);const s=a.XpG();return H.Njj(s.dismissResults())}),a.EFF(13),a.k0s()()()}if(2&n){const d=a.XpG();a.R7$(),a.HbH(d.resultStatus),a.R7$(2),a.Y8G("ngIf","correct"===d.resultStatus),a.R7$(),a.Y8G("ngIf","befuddled"===d.resultStatus),a.R7$(),a.Y8G("ngIf","wrong"===d.resultStatus),a.R7$(2),a.JRh(d.resultFeedback),a.R7$(2),a.JRh(d.strokeCountInfo),a.R7$(),a.Y8G("ngIf",d.displayMatches.length>0),a.R7$(),a.Y8G("ngIf","wrong"===d.resultStatus&&d.correctAnswer),a.R7$(2),a.JRh(d.dismissButtonText)}}let W=(()=>{var n;class e{kanaMatch(o,s){if(o===s)return!0;const i=e.SMALL_TO_BIG_KANA[o];if(i&&i===s)return!0;const t=e.SMALL_TO_BIG_KANA[s];return!!(t&&t===o||i&&t&&i===t)}constructor(o,s,i,t){this.strokeRecognition=o,this.cardsService=s,this.segmentationService=i,this.collectionService=t,this.isDrawing=!1,this.strokes=[],this.currentStroke=[],this.drawStartTime=0,this.currentCharacter="",this.promptText="",this.promptColor="#FFFFFF",this.noCardsAvailable=!1,this.isChecking=!1,this.showResults=!1,this.resultStatus="",this.resultFeedback="",this.strokeCountInfo="",this.topMatches=[],this.displayMatches=[],this.correctAnswer="",this.cardAvailabilitySubscription=null,this.segmentationTimer=null,this.segmentationResult=null,this.SEGMENTATION_DELAY_MS=500,this.lastBatchResults=[],this.lastSortedCells=[],this.correctFeedback=["\u6b63\u89e3!","\u307e\u308b!","\u306f\u306a\u307e\u308b!","\u3088\u304f\u3084\u3063\u305f!","\u3059\u3054\u3044!","\u304b\u3093\u307a\u304d!","\u3070\u3063\u3061\u308a!","\u305d\u306e\u8abf\u5b50!"],this.wrongFeedback=["\u3061\u304c\u3046!","\u3056\u3093\u306d\u3093!","\u306f\u305a\u308c!","\u3075\u305b\u3044\u304b\u3044!","\u30d0\u30c4!"],this.checkButtonLabels=["\u3088\u3057!","\u5224\u5b9a!","\u3067\u304d\u305f!","\u3044\u3056!","\u78ba\u8a8d"],this.dismissButtonLabels=["\u6b21!","\u3064\u304e!","\u3088\u3057!","\u30aa\u30c3\u30b1\u30fc!","\u306f\u3044!","\u4e86\u89e3!","\u3044\u304f\u305e!"],this.checkButtonText="",this.dismissButtonText="",this.minBrushSize=3,this.maxBrushSize=24,this.brushSmoothing=.05,this.lastBrushSize=0,function(n){Object.keys(n).forEach(function(e){U(e,n[e]);var d=e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();e!==d&&U(d,n[e])})}({backspace:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M403.13 96H156.87a44.9 44.9 0 00-33.68 15.27 15.88 15.88 0 00-1.91 2.7L32 247.75a16 16 0 000 16.5l89.15 133.57a16.24 16.24 0 002 2.88 44.89 44.89 0 0033.7 15.3h246.28A44.92 44.92 0 00448 371.13V140.87A44.92 44.92 0 00403.13 96zM348 311a16 16 0 11-22.63 22.62L271.67 280 218 333.65A16 16 0 01195.35 311L249 257.33l-53.69-53.69A16 16 0 01218 181l53.69 53.7 53.67-53.7A16 16 0 01348 203.64l-53.7 53.69z'/></svg>"})}ngOnInit(){var o=this;return(0,j.A)(function*(){o.checkButtonText=o.randomFrom(o.checkButtonLabels),yield o.cardsService.initialize(),o.loadRandomCard(),o.cardAvailabilitySubscription=o.cardsService.cardAvailability$.subscribe(s=>{o.noCardsAvailable&&s>0&&o.loadRandomCard()})})()}loadRandomCard(){this.currentCard=this.cardsService.getRandomUnlockedCard(),this.currentCard?(this.currentCharacter=this.currentCard.answers[0],this.promptText=this.currentCard.prompt,this.promptColor=this.cardsService.getStageColor(this.currentCard.stage),this.noCardsAvailable=!1):(this.noCardsAvailable=!0,this.promptText="",this.promptColor="#FFFFFF")}ngAfterViewInit(){setTimeout(()=>this.setupCanvas(),100)}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.cardAvailabilitySubscription&&this.cardAvailabilitySubscription.unsubscribe(),this.cancelSegmentation()}setupCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(s),this.ctx=o.getContext("2d"),this.setCanvasStyle(),o.addEventListener("mousedown",this.handleMouseDown.bind(this)),o.addEventListener("mousemove",this.handleMouseMove.bind(this)),o.addEventListener("mouseup",this.handleMouseUp.bind(this)),o.addEventListener("mouseleave",this.handleMouseUp.bind(this)),o.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),o.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),o.addEventListener("touchend",this.handleTouchEnd.bind(this)))}resizeCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(o.width=s.clientWidth,o.height=s.clientHeight,this.ctx&&this.setCanvasStyle())}setCanvasStyle(){this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff",this.ctx.lineCap="round",this.ctx.lineJoin="round"}handleMouseDown(o){this.cancelSegmentation(),this.isDrawing=!0;const s=this.getMousePos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleMouseMove(o){if(!this.isDrawing)return;const s=this.getMousePos(o),i=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(i,s)}handleMouseUp(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}handleTouchStart(o){o.preventDefault(),this.cancelSegmentation(),this.isDrawing=!0;const s=this.getTouchPos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleTouchMove(o){if(!this.isDrawing)return;o.preventDefault();const s=this.getTouchPos(o),i=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(i,s)}handleTouchEnd(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}getMousePos(o){const s=this.canvasRef.nativeElement,i=s.getBoundingClientRect(),t=s.width/i.width,v=s.height/i.height,g=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=g),{x:(o.clientX-i.left)*t,y:(o.clientY-i.top)*v,t:g-this.drawStartTime}}getTouchPos(o){const s=this.canvasRef.nativeElement,i=s.getBoundingClientRect(),t=s.width/i.width,v=s.height/i.height,g=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=g),{x:(o.touches[0].clientX-i.left)*t,y:(o.touches[0].clientY-i.top)*v,t:g-this.drawStartTime}}calculateBrushSize(o,s){const i=s.x-o.x,t=s.y-o.y,v=Math.max(s.t-o.t,1),r=Math.sqrt(i*i+t*t)/v,c=Math.min(r/1.5,1),w=this.lastBrushSize+(this.maxBrushSize-c*(this.maxBrushSize-this.minBrushSize)-this.lastBrushSize)*this.brushSmoothing;return this.lastBrushSize=w,w}drawBrushPoint(o,s,i){this.ctx.beginPath(),this.ctx.arc(o,s,i/2,0,2*Math.PI),this.ctx.fill()}drawBrushSegment(o,s){const i=this.calculateBrushSize(o,s);this.ctx.lineWidth=i,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.drawBrushPoint(s.x,s.y,i)}drawHarai(o){if(o.length<3)return;const s=Math.min(5,o.length),i=o.slice(-s),t=i[i.length-1],v=i[0],g=t.x-v.x,r=t.y-v.y,c=Math.sqrt(g*g+r*r);if(c<5)return;const l=g/c,w=r/c,h=Math.max(t.t-v.t,1),p=Math.min(c/h*20,40);if(p<8)return;const z=this.lastBrushSize;for(let k=0;k<8;k++){const V=(k+1)/8,C=1-Math.pow(1-k/8,2),M=1-Math.pow(1-V,2),f=t.x+l*p*C,L=t.y+w*p*C,O=t.x+l*p*M,I=t.y+w*p*M,_=z*(1-V);_>.5&&(this.ctx.lineWidth=_,this.ctx.beginPath(),this.ctx.moveTo(f,L),this.ctx.lineTo(O,I),this.ctx.stroke())}}onCheck(){var o=this;return(0,j.A)(function*(){if(0!==o.strokes.length&&o.currentCard){o.isChecking=!0;try{const s=o.canvasRef.nativeElement,i=Math.max(...o.currentCard.answers.map(c=>[...c.replace(/\s+/g,"")].length));if(o.lastSortedCells=[],i>1){o.segmentationResult||(o.segmentationResult=o.segmentationService.segment(o.strokes,s.width,s.height));const l=o.segmentationResult.grid.cells.filter(w=>w.strokeIndices.length>0);o.lastSortedCells=[...l].sort((w,h)=>w.column!==h.column?w.column-h.column:w.row-h.row)}let t;if(o.lastSortedCells.length<=1)o.lastBatchResults=[],t=yield o.strokeRecognition.recognize(o.strokes,s.width,s.height);else{const c=o.lastSortedCells.map(h=>({strokes:h.strokeIndices.map(z=>o.strokes[z]),bounds:{width:h.bounds.maxX-h.bounds.minX,height:h.bounds.maxY-h.bounds.minY}})),l=yield o.strokeRecognition.recognizeBatch(c);o.lastBatchResults=l,t=[{character:l.map(h=>h[0]?.character||"?").join(""),score:100}],console.log("Cell interpretations (Japanese reading order):",l.map((h,m)=>({cell:m,position:`col ${o.lastSortedCells[m].column}, row ${o.lastSortedCells[m].row}`,top5:h.slice(0,5).map(p=>p.character)})))}o.topMatches=t.slice(0,5);const v=o.currentCard.answers.map(c=>c.replace(/\s+/g,""));let g=!1;if(o.lastBatchResults.length>0)g=v.some(c=>{const l=[...c];return l.length===o.lastBatchResults.length&&l.every((w,h)=>{const m=o.lastBatchResults[h].slice(0,5).map(x=>x.character),p=m.some(x=>o.kanaMatch(w,x));return console.log(`  Cell ${h}: target='${w}' (code=${w.charCodeAt(0)}), candidates=[${m.map(x=>`'${x}'(${x.charCodeAt(0)})`).join(", ")}], matched=${p}`),p})}),console.log("Grading multi-char:",{targets:v,cellResults:o.lastBatchResults.map(c=>c.slice(0,5).map(l=>l.character)),isCorrect:g});else{const c=o.topMatches.map(l=>l.character);g=v.some(l=>c.some(w=>o.kanaMatch(l,w)))}if(g)o.resultStatus="correct",o.resultFeedback=o.randomFrom(o.correctFeedback),o.displayMatches=o.topMatches.slice(0,1),o.correctAnswer="",o.cardsService.advanceCard(o.currentCard.id);else{let c;if(o.lastBatchResults.length>0)console.log("Checking befuddlers:",o.currentCard.befuddlers.map(l=>({answers:l.answers,toast:l.toast.slice(0,30)}))),c=o.currentCard.befuddlers.find(l=>(console.log("  Befuddler answers:",l.answers),l.answers.some(w=>{const h=[...w.replace(/\s+/g,"")];if(console.log(`    Checking "${w}": ${h.length} chars vs ${o.lastBatchResults.length} cells`),h.length!==o.lastBatchResults.length)return!1;const m=h.every((p,x)=>{const z=o.lastBatchResults[x].slice(0,5).map(u=>u.character),k=z.some(u=>o.kanaMatch(p,u));return console.log(`      Cell ${x}: '${p}' vs [${z.join(",")}] = ${k}`),k});return console.log(`    Result: ${m}`),m})));else{const l=o.topMatches.map(w=>w.character);c=o.currentCard.befuddlers.find(w=>w.answers.some(h=>l.some(m=>o.kanaMatch(h.replace(/\s+/g,""),m))))}c?(o.resultStatus="befuddled",o.resultFeedback=c.toast,o.displayMatches=o.topMatches,o.correctAnswer=""):(o.resultStatus="wrong",o.resultFeedback=o.randomFrom(o.wrongFeedback),o.displayMatches=o.topMatches,o.correctAnswer=o.currentCard.answers[0])}const r=o.strokeRecognition.getExpectedStrokeCount(o.currentCharacter);o.strokeCountInfo=`Strokes: ${o.strokes.length}/${r}`,o.exportCollectionSample(g)}catch(s){console.error("Recognition error:",s),o.resultStatus="wrong",o.resultFeedback=s.message||"Recognition failed. Please try on a device.",o.topMatches=[],o.displayMatches=[],o.strokeCountInfo=""}o.isChecking=!1,o.checkButtonText=o.randomFrom(o.checkButtonLabels),o.dismissButtonText=o.randomFrom(o.dismissButtonLabels),o.showResults=!0}})()}dismissResults(){this.showResults=!1,this.clearCanvas(),("correct"===this.resultStatus||"wrong"===this.resultStatus)&&this.loadRandomCard()}onUndo(){this.strokes.length>0&&(this.strokes.pop(),this.redrawStrokes(),this.scheduleSegmentation())}redrawStrokes(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.setCanvasStyle();for(const s of this.strokes)if(0!==s.length){this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s[0].x,s[0].y,1.5*this.minBrushSize);for(let i=1;i<s.length;i++)this.drawBrushSegment(s[i-1],s[i]);this.drawHarai(s)}}clearCanvas(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.strokes=[],this.drawStartTime=0,this.cancelSegmentation(),this.segmentationResult=null}randomFrom(o){return o[Math.floor(Math.random()*o.length)]}scheduleSegmentation(){this.cancelSegmentation(),0!==this.strokes.length?this.segmentationTimer=setTimeout(()=>{this.analyzeAndVisualize()},this.SEGMENTATION_DELAY_MS):this.segmentationResult=null}cancelSegmentation(){null!==this.segmentationTimer&&(clearTimeout(this.segmentationTimer),this.segmentationTimer=null)}analyzeAndVisualize(){if(0===this.strokes.length)return void(this.segmentationResult=null);if(this.currentCard&&Math.max(...this.currentCard.answers.map(i=>[...i.replace(/\s+/g,"")].length))<=1)return this.segmentationResult=null,void this.redrawStrokes();const o=this.canvasRef.nativeElement;this.segmentationResult=this.segmentationService.segment(this.strokes,o.width,o.height),this.redrawWithBoundaries()}redrawWithBoundaries(){if(this.redrawStrokes(),this.segmentationResult){const o=this.segmentationResult.grid;(o.columnDividers.length>0||o.rowDividers.some(i=>i.length>0))&&this.drawDividers(o)}}drawDividers(o){this.ctx.save(),this.ctx.strokeStyle="rgba(128, 128, 128, 0.4)",this.ctx.lineWidth=1,this.ctx.setLineDash([4,4]);for(const s of o.columnDividers){const i=s.start,t=s.end,v=s.slope*i+s.intercept,g=s.slope*t+s.intercept;this.ctx.beginPath(),this.ctx.moveTo(v,i),this.ctx.lineTo(g,t),this.ctx.stroke()}for(const s of o.rowDividers)for(const i of s){const t=i.start,v=i.end,g=i.slope*t+i.intercept,r=i.slope*v+i.intercept;this.ctx.beginPath(),this.ctx.moveTo(t,g),this.ctx.lineTo(v,r),this.ctx.stroke()}this.ctx.restore()}exportCollectionSample(o){if(!this.currentCard)return;const s=this.canvasRef.nativeElement;let i=null;this.lastBatchResults.length>0?i=this.lastBatchResults:this.topMatches.length>0&&(i=[this.topMatches]),this.collectionService.exportSample({strokes:this.strokes,canvasWidth:s.width,canvasHeight:s.height,segmentationResult:this.segmentationResult,sortedCells:this.lastSortedCells,answers:this.currentCard.answers,recognitionResults:i,success:o,cardId:this.currentCard.id})}static#o=n=()=>(this.SMALL_TO_BIG_KANA={\u3063:"\u3064",\u3083:"\u3084",\u3085:"\u3086",\u3087:"\u3088",\u3041:"\u3042",\u3043:"\u3044",\u3045:"\u3046",\u3047:"\u3048",\u3049:"\u304a",\u308e:"\u308f",\u30c3:"\u30c4",\u30e3:"\u30e4",\u30e5:"\u30e6",\u30e7:"\u30e8",\u30a1:"\u30a2",\u30a3:"\u30a4",\u30a5:"\u30a6",\u30a7:"\u30a8",\u30a9:"\u30aa",\u30ee:"\u30ef"},this.\u0275fac=function(s){return new(s||e)(a.rXU(a1),a.rXU(Y.D),a.rXU(i1),a.rXU(n1))},this.\u0275cmp=a.VBU({type:e,selectors:[["app-workbook"]],viewQuery:function(s,i){if(1&s&&a.GBs(t1,5),2&s){let t;a.mGM(t=a.lsd())&&(i.canvasRef=t.first)}},decls:11,vars:10,consts:[["canvas",""],[1,"workbook-content",3,"fullscreen","scrollY"],[1,"prompt-bar"],["color","light"],[1,"prompt-text"],[1,"canvas-wrapper"],["class","drawing-canvas",4,"ngIf"],["class","undo-btn","fill","clear",3,"click",4,"ngIf"],["class","caught-up-box",4,"ngIf"],["class","check-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","results-overlay",3,"click",4,"ngIf"],[1,"drawing-canvas"],["fill","clear",1,"undo-btn",3,"click"],["name","backspace"],[1,"caught-up-box"],[1,"caught-up-title"],[1,"caught-up-message"],["color","primary",1,"check-btn",3,"click","disabled"],["name","crescent",4,"ngIf"],[4,"ngIf"],["name","crescent"],[1,"results-overlay",3,"click"],[1,"results-card",3,"click"],[1,"status-display"],[1,"feedback"],[1,"stroke-info"],["class","matches-section",4,"ngIf"],["class","correct-answer-section",4,"ngIf"],["expand","block",3,"click"],[1,"matches-section"],[1,"matches-title"],[1,"matches-list"],["class","match-item",4,"ngFor","ngForOf"],[1,"match-item"],[1,"match-char"],[1,"correct-answer-section"],[1,"correct-answer-title"],[1,"correct-answer"]],template:function(s,i){1&s&&(a.j41(0,"ion-content",1)(1,"div",2),a.nrm(2,"ion-menu-button",3),a.j41(3,"span",4),a.EFF(4),a.k0s()(),a.j41(5,"div",5),a.DNE(6,l1,2,0,"canvas",6)(7,c1,2,0,"ion-button",7)(8,e1,5,0,"div",8),a.k0s(),a.DNE(9,g1,3,3,"ion-button",9)(10,u1,14,10,"div",10),a.k0s()),2&s&&(a.Y8G("fullscreen",!0)("scrollY",!1),a.R7$(3),a.xc7("color",i.promptColor),a.R7$(),a.JRh(i.promptText),a.R7$(2),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",!i.noCardsAvailable),a.R7$(),a.Y8G("ngIf",i.showResults))},dependencies:[b.W9,b.MC,b.Jm,b.iq,b.w2,q.MD,q.Sq,q.bT],styles:[".workbook-content[_ngcontent-%COMP%]{--background: #000}.prompt-bar[_ngcontent-%COMP%]{display:flex;align-items:center;height:144px;background:#111;padding:0 8px}.prompt-text[_ngcontent-%COMP%]{flex:1;text-align:center;font-size:24px;color:#fff;margin-right:40px;white-space:pre-line}.canvas-wrapper[_ngcontent-%COMP%]{position:absolute;inset:144px 0 0;background:#000}.drawing-canvas[_ngcontent-%COMP%]{width:100%;height:100%;touch-action:none;display:block}.undo-btn[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:24px}.results-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000e6;display:flex;align-items:center;justify-content:center;z-index:100}.results-card[_ngcontent-%COMP%]{background:#1a1a1a;border-radius:16px;padding:24px;min-width:280px;max-width:90%;text-align:center}.results-card.correct[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.correct[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#e63946}.results-card.befuddled[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.befuddled[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#f7b731}.results-card.wrong[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.wrong[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#4a90d9}.status-display[_ngcontent-%COMP%]{font-size:64px;font-weight:700;margin-bottom:8px}.feedback[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-size:18px;margin-bottom:16px;white-space:pre-line}.stroke-info[_ngcontent-%COMP%]{font-size:14px;color:#888;margin-bottom:20px}.matches-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.matches-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.matches-list[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:16px}.match-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.match-char[_ngcontent-%COMP%]{font-size:32px;color:#fff}.correct-answer-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.correct-answer-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.correct-answer[_ngcontent-%COMP%]{font-size:36px;color:#4a90d9}.check-btn[_ngcontent-%COMP%]{position:absolute;bottom:32px;left:50%;transform:translate(-50%);--background: #222;--background-hover: #333;--color: #fff;--border-radius: 32px;--padding-start: 12vw;--padding-end: 12vw;--padding-top: 16px;--padding-bottom: 16px;min-height:60px;font-family:Shippori Mincho,serif;font-size:clamp(20px,5vw,28px);font-weight:600;letter-spacing:2px}.results-card[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-weight:700}.caught-up-box[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border-radius:16px;padding:32px;text-align:center;max-width:90%;width:320px}.caught-up-title[_ngcontent-%COMP%]{font-size:36px;margin-bottom:16px}.caught-up-message[_ngcontent-%COMP%]{font-size:16px;color:#ccc;line-height:1.5}"]}))}return n(),e})();const M1=[{path:"",component:W}];let z1=(()=>{var n;class e{static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275mod=a.$C({type:e}),this.\u0275inj=H.G2t({imports:[P.iI.forChild(M1),P.iI]}))}return n(),e})(),k1=(()=>{var n;class e{static#o=n=()=>(this.\u0275fac=function(s){return new(s||e)},this.\u0275mod=a.$C({type:e}),this.\u0275inj=H.G2t({imports:[q.MD,J.YN,K.bv,z1,W]}))}return n(),e})()}}]);