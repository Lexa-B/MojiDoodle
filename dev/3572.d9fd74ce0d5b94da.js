"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3572],{3572(m1,P,L){L.d(P,{WorkbookPageModule:()=>g1});var j,A=L(2200),E=L(4341),U=L(7343),_=L(8132),y=L(467),V=L(6299),R=function(c,g){var d=function(){if(typeof window>"u")return new Map;if(!j){var c=window;c.Ionicons=c.Ionicons||{},j=c.Ionicons.map=c.Ionicons.map||new Map}return j}(),o=d.get(c);void 0===o?d.set(c,g):o!==g&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(c,'". Ensure that multiple icons are not mapped to the same icon name.'))},i=L(3664),f=L(2615),F=L(4185);let W=(()=>{var c;class g{constructor(o){this.cardsService=o,this.API_URL="https://inputtools.google.com/request?itc=ja-t-i0-handwrit&app=translate"}recognize(o,s,a){var t=this;return(0,y.A)(function*(){if(0===o.length)return[];const l=o.map(v=>{const n=[],r=[],w=[];for(const h of v)n.push(Math.round(h.x)),r.push(Math.round(h.y)),w.push(h.t);return[n,r,w]}),e={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:[{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:a,writing_area_width:s},ink:l}]};try{const n=yield(yield fetch(t.API_URL,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}})).json();return t.parseResponse(n)}catch(v){throw console.error("Recognition failed:",v),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}recognizeBatch(o){var s=this;return(0,y.A)(function*(){if(0===o.length)return[];const a=o.map(l=>{const e=l.strokes.map(v=>{const n=[],r=[],w=[];for(const h of v)n.push(Math.round(h.x)),r.push(Math.round(h.y)),w.push(h.t);return[n,r,w]});return{max_completions:0,max_num_results:10,pre_context:"",writing_guide:{writing_area_height:Math.round(l.bounds.height),writing_area_width:Math.round(l.bounds.width)},ink:e}}),t={app_version:.4,api_level:"537.36",device:navigator.userAgent,input_type:0,options:"enable_pre_space",requests:a};try{const e=yield(yield fetch(s.API_URL,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json();return s.parseBatchResponse(e,o.length)}catch(l){throw console.error("Batch recognition failed:",l),new Error("Handwriting recognition failed. Please check your internet connection.")}})()}parseBatchResponse(o,s){if(!o||"SUCCESS"!==o[0])return Array(s).fill([]);const a=[],t=o[1]||[];for(let l=0;l<s;l++){const e=t[l]?.[1];if(!e||0===e.length){a.push([]);continue}const v=/^[\p{P}\p{S}\p{M}]$/u,n=e.map(r=>r.replace(/\s+/g,"")).filter(r=>{const w=[...r];return!(1!==w.length||v.test(w[0]))}).map((r,w)=>({character:r,score:Math.max(100-10*w,10)}));a.push(n)}return a}parseResponse(o){if(!o||"SUCCESS"!==o[0])return[];const s=o[1]?.[0]?.[1];return s&&0!==s.length?s.map((a,t)=>({character:a.replace(/\s+/g,""),score:Math.max(100-10*t,10)})):[]}getExpectedStrokeCount(o){return this.cardsService.getStrokeCount(o)}static#o=c=()=>(this.\u0275fac=function(s){return new(s||g)(f.KVO(F.D))},this.\u0275prov=f.jDH({token:g,factory:g.\u0275fac,providedIn:"root"}))}return c(),g})(),$=(()=>{var c;class g{constructor(){this.MIN_CHAR_SIZE_RATIO=.06,this.MAX_CHAR_SIZE_RATIO=.3,this.DENSITY_BIN_DIVISOR=10,this.VALLEY_THRESHOLD_RATIO=.5,this.MIN_CELL_SIZE_RATIO=.25,this.MAX_CELL_SIZE_RATIO=3,this.CELL_PADDING=10,this.DEFORM_ITERATIONS=5,this.DEFORM_STRENGTH=.6}segment(o,s,a){if(0===o.length)return{mesh:{vertices:[],cells:[],columns:0,maxRows:0,estimatedCharSize:0},estimatedCharSize:0,gridColumns:0};const t=this.calculateStrokeBounds(o),l=this.estimateCharacterSize(t,a);let{columnBoundaries:e,rowBoundaries:v}=this.findGridDivisions(t,l),n=this.createDeformableMesh(e,v,t,l);this.assignStrokesToCells(n,t);let r=0;for(;r<10&&!this.isValidMesh(n);){const w=this.simplifyGrid(e,v,n,t);e=w.columnBoundaries,v=w.rowBoundaries,n=this.createDeformableMesh(e,v,t,l),this.assignStrokesToCells(n,t),r++}return this.deformMeshToContent(n,t),{mesh:n,estimatedCharSize:l,gridColumns:n.columns}}isValidMesh(o){return!(this.hasEmptyInteriorCells(o)||!this.hasSizeUniformity(o))}hasSizeUniformity(o){const s=[];for(const l of o.cells){if(0===l.strokeIndices.length)continue;const[e,v,n,r]=l.vertexIndices.map(m=>o.vertices[m]),w=Math.max(Math.abs(v.x-e.x),Math.abs(n.x-r.x)),h=Math.max(Math.abs(r.y-e.y),Math.abs(n.y-v.y)),p=Math.max(w,h);s.push(p)}if(s.length<=1)return!0;const a=Math.min(...s);return Math.max(...s)<=1.75*a}hasEmptyInteriorCells(o){const s=new Map;for(const a of o.cells)s.set(`${a.column},${a.row}`,a.strokeIndices.length>0);for(const a of o.cells){if(a.strokeIndices.length>0)continue;let t=!1,l=!1;for(let n=0;n<a.column;n++)s.get(`${n},${a.row}`)&&(t=!0);for(let n=a.column+1;n<o.columns;n++)s.get(`${n},${a.row}`)&&(l=!0);let e=!1,v=!1;for(let n=0;n<a.row;n++)s.get(`${a.column},${n}`)&&(e=!0);for(let n=a.row+1;n<o.maxRows;n++)s.get(`${a.column},${n}`)&&(v=!0);if(t&&l||e&&v)return!0}return!1}simplifyGrid(o,s,a,t){if(o.length>2)for(let l=1;l<o.length-1;l++){const e=[...o.slice(0,l),...o.slice(l+1)],v=this.createDeformableMesh(e,s,t,a.estimatedCharSize);if(this.assignStrokesToCells(v,t),!this.hasEmptyInteriorCells(v))return{columnBoundaries:e,rowBoundaries:s}}if(s.length>2)for(let l=1;l<s.length-1;l++){const e=[...s.slice(0,l),...s.slice(l+1)],v=this.createDeformableMesh(o,e,t,a.estimatedCharSize);if(this.assignStrokesToCells(v,t),!this.hasEmptyInteriorCells(v))return{columnBoundaries:o,rowBoundaries:e}}return o.length>2?{columnBoundaries:[o[0],o[o.length-1]],rowBoundaries:s}:s.length>2?{columnBoundaries:o,rowBoundaries:[s[0],s[s.length-1]]}:{columnBoundaries:o,rowBoundaries:s}}calculateStrokeBounds(o){return o.map((s,a)=>({index:a,stroke:s,bounds:this.calculateBoundingBox(s)}))}calculateBoundingBox(o){if(0===o.length)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0,centerX:0,centerY:0};let s=1/0,a=1/0,t=-1/0,l=-1/0;for(const n of o)s=Math.min(s,n.x),a=Math.min(a,n.y),t=Math.max(t,n.x),l=Math.max(l,n.y);const e=t-s,v=l-a;return{minX:s,minY:a,maxX:t,maxY:l,width:e,height:v,centerX:s+e/2,centerY:a+v/2}}estimateCharacterSize(o,s){if(0===o.length)return.15*s;const a=o.map(r=>Math.max(r.bounds.width,r.bounds.height));a.sort((r,w)=>r-w);let e=2*(a[Math.floor(.6*a.length)]||a[0]);if(o.length>1){const r=this.findStrokeGaps(o);if(r.length>0){r.sort((h,p)=>h-p);const w=r[Math.floor(r.length/2)];w>.5*e&&(e=Math.min(e,1.5*w))}}return Math.max(s*this.MIN_CHAR_SIZE_RATIO,Math.min(s*this.MAX_CHAR_SIZE_RATIO,e))}findStrokeGaps(o){const s=[];for(let a=0;a<o.length;a++)for(let t=a+1;t<o.length;t++){const l=o[a].bounds,e=o[t].bounds,v=Math.max(0,Math.max(l.minX,e.minX)-Math.min(l.maxX,e.maxX)),n=Math.max(0,Math.max(l.minY,e.minY)-Math.min(l.maxY,e.maxY)),r=Math.sqrt(v*v+n*n);r>0&&s.push(r)}return s}findGridDivisions(o,s){const a=o.flatMap(r=>r.stroke),t=this.calculateBoundingBox(a),l=this.findDensityValleys(o,"x",t.minX,t.maxX,s),e=[t.minX-this.CELL_PADDING,...l,t.maxX+this.CELL_PADDING],v=this.findDensityValleys(o,"y",t.minY,t.maxY,s);return{columnBoundaries:e,rowBoundaries:[t.minY-this.CELL_PADDING,...v,t.maxY+this.CELL_PADDING]}}findDensityValleys(o,s,a,t,l){const e=t-a;if(e<.9*l)return[];const v=Math.max(l/this.DENSITY_BIN_DIVISOR,2),n=Math.ceil(e/v);if(n<4)return[];const r=new Array(n).fill(0);for(const u of o)for(const z of u.stroke){const M=Math.floor((("x"===s?z.x:z.y)-a)/v);M>=0&&M<n&&r[M]++}const w=this.smoothArray(r,2),p=Math.max(...w)*this.VALLEY_THRESHOLD_RATIO,m=[],x=l*this.MIN_CELL_SIZE_RATIO;for(let u=1;u<w.length-1;u++){const z=w[u];if(z>=w[u-1]||z>=w[u+1]||z>p)continue;const k=a+(u+.5)*v,M=k-a;M<x||t-k<x||(m.length>0?k-m[m.length-1]:M)<x||m.push(k)}const B=[];for(const u of m){const z=o.some(M=>("x"===s?M.bounds.centerX:M.bounds.centerY)<u),k=o.some(M=>("x"===s?M.bounds.centerX:M.bounds.centerY)>u);z&&k&&B.push(u)}return B}smoothArray(o,s){const a=[],t=Math.floor(s/2);for(let l=0;l<o.length;l++){let e=0,v=0;for(let n=Math.max(0,l-t);n<=Math.min(o.length-1,l+t);n++)e+=o[n],v++;a.push(e/v)}return a}createDeformableMesh(o,s,a,t){const l=o.length-1,e=s.length-1;if(l<=0||e<=0)return this.createSingleCellMesh(a,t);const v=[],n=[];for(let h=0;h<=l;h++){n[h]=[];const p=o[h];for(let m=0;m<=e;m++){const x=s[m];n[h][m]=v.length,v.push({x:p,y:x})}}const r=[],w=Array.from({length:l},(h,p)=>p).sort((h,p)=>o[p]-o[h]);for(let h=0;h<w.length;h++){const p=w[h];for(let m=0;m<e;m++)r.push({column:h,row:m,vertexIndices:[n[p][m],n[p+1][m],n[p+1][m+1],n[p][m+1]],strokeIndices:[]})}return{vertices:v,cells:r,columns:l,maxRows:e,estimatedCharSize:t}}createSingleCellMesh(o,s){const a=o.flatMap(n=>n.stroke),t=this.calculateBoundingBox(a),l=this.CELL_PADDING;return{vertices:[{x:t.minX-l,y:t.minY-l},{x:t.maxX+l,y:t.minY-l},{x:t.maxX+l,y:t.maxY+l},{x:t.minX-l,y:t.maxY+l}],cells:[{column:0,row:0,vertexIndices:[0,1,2,3],strokeIndices:[]}],columns:1,maxRows:1,estimatedCharSize:s}}assignStrokesToCells(o,s){for(const a of s){const{centerX:t,centerY:l}=a.bounds;let e=null,v=1/0;for(const n of o.cells){const[r,w,h,p]=n.vertexIndices.map(C=>o.vertices[C]),m=(r.x+w.x+h.x+p.x)/4,x=(r.y+w.y+h.y+p.y)/4,B=Math.min(r.x,w.x,h.x,p.x),u=Math.max(r.x,w.x,h.x,p.x),z=Math.min(r.y,w.y,h.y,p.y),k=Math.max(r.y,w.y,h.y,p.y);if(t>=B&&t<=u&&l>=z&&l<=k){e=n;break}const M=Math.hypot(t-m,l-x);M<v&&(v=M,e=n)}e&&e.strokeIndices.push(a.index)}}deformMeshToContent(o,s){for(let a=0;a<this.DEFORM_ITERATIONS;a++){const t=this.DEFORM_STRENGTH*(1-.15*a),l=new Map;for(const e of o.cells){if(0===e.strokeIndices.length)continue;const n=e.strokeIndices.map(h=>s[h]).flatMap(h=>h.stroke),r=this.CELL_PADDING,w=[this.findClosestContentCorner(n,"tl",r),this.findClosestContentCorner(n,"tr",r),this.findClosestContentCorner(n,"br",r),this.findClosestContentCorner(n,"bl",r)];for(let h=0;h<4;h++){const p=e.vertexIndices[h];l.has(p)||l.set(p,[]),l.get(p).push(w[h])}}for(const[e,v]of l){if(0===v.length)continue;const n=o.vertices[e],r=v.reduce((h,p)=>h+p.x,0)/v.length,w=v.reduce((h,p)=>h+p.y,0)/v.length;n.x+=(r-n.x)*t,n.y+=(w-n.y)*t}}this.ensureValidQuads(o)}findClosestContentCorner(o,s,a){if(0===o.length)return{x:0,y:0};let t=o[0],l=-1/0;for(const n of o){let r=0;switch(s){case"tl":r=-n.x-n.y;break;case"tr":r=n.x-n.y;break;case"br":r=n.x+n.y;break;case"bl":r=-n.x+n.y}r>l&&(l=r,t=n)}let e=0,v=0;switch(s){case"tl":e=-a,v=-a;break;case"tr":e=a,v=-a;break;case"br":e=a,v=a;break;case"bl":e=-a,v=a}return{x:t.x+e,y:t.y+v}}ensureValidQuads(o){for(const s of o.cells){const a=s.vertexIndices.map(w=>o.vertices[w]),[t,l,e,v]=a,n=(t.x+l.x+e.x+v.x)/4,r=(t.y+l.y+e.y+v.y)/4;t.x>n+5&&(t.x=n-5),t.y>r+5&&(t.y=r-5),l.x<n-5&&(l.x=n+5),l.y>r+5&&(l.y=r-5),e.x<n-5&&(e.x=n+5),e.y<r-5&&(e.y=r+5),v.x>n+5&&(v.x=n-5),v.y<r-5&&(v.y=r+5)}}static#o=c=()=>(this.\u0275fac=function(s){return new(s||g)},this.\u0275prov=f.jDH({token:g,factory:g.\u0275fac,providedIn:"root"}))}return c(),g})();const J=["canvas"];function Z(c,g){1&c&&i.nrm(0,"canvas",11,0)}function Q(c,g){if(1&c){const d=i.RV6();i.j41(0,"ion-button",12),i.bIt("click",function(){f.eBV(d);const s=i.XpG();return f.Njj(s.onUndo())}),i.nrm(1,"ion-icon",13),i.k0s()}}function K(c,g){1&c&&(i.j41(0,"div",14)(1,"div",15),i.EFF(2,"\u304a\u3081\u3067\u3068\u3046\u{1f973}"),i.k0s(),i.j41(3,"div",16),i.EFF(4,"You're all caught up. Come back again soon for more lessons!"),i.k0s()())}function o1(c,g){1&c&&i.nrm(0,"ion-spinner",20)}function s1(c,g){if(1&c&&(i.j41(0,"span"),i.EFF(1),i.k0s()),2&c){const d=i.XpG(2);i.R7$(),i.JRh(d.checkButtonText)}}function a1(c,g){if(1&c){const d=i.RV6();i.j41(0,"ion-button",17),i.bIt("click",function(){f.eBV(d);const s=i.XpG();return f.Njj(s.onCheck())}),i.DNE(1,o1,1,0,"ion-spinner",18)(2,s1,2,1,"span",19),i.k0s()}if(2&c){const d=i.XpG();i.Y8G("disabled",d.isChecking),i.R7$(),i.Y8G("ngIf",d.isChecking),i.R7$(),i.Y8G("ngIf",!d.isChecking)}}function i1(c,g){1&c&&(i.j41(0,"span"),i.EFF(1,"\u25ef"),i.k0s())}function n1(c,g){1&c&&(i.j41(0,"span"),i.EFF(1,"\uff1f"),i.k0s())}function t1(c,g){1&c&&(i.j41(0,"span"),i.EFF(1,"\u2715"),i.k0s())}function l1(c,g){if(1&c&&(i.j41(0,"div",32)(1,"span",33),i.EFF(2),i.k0s()()),2&c){const d=g.$implicit;i.R7$(2),i.JRh(d.character)}}function c1(c,g){if(1&c&&(i.j41(0,"div",28)(1,"div",29),i.EFF(2,"Recognized:"),i.k0s(),i.j41(3,"div",30),i.DNE(4,l1,3,1,"div",31),i.k0s()()),2&c){const d=i.XpG(2);i.R7$(4),i.Y8G("ngForOf",d.displayMatches)}}function e1(c,g){if(1&c){const d=i.RV6();i.j41(0,"div",21),i.bIt("click",function(){f.eBV(d);const s=i.XpG();return f.Njj(s.dismissResults())}),i.j41(1,"div",22),i.bIt("click",function(s){return f.eBV(d),f.Njj(s.stopPropagation())}),i.j41(2,"div",23),i.DNE(3,i1,2,0,"span",19)(4,n1,2,0,"span",19)(5,t1,2,0,"span",19),i.k0s(),i.j41(6,"div",24),i.EFF(7),i.k0s(),i.j41(8,"div",25),i.EFF(9),i.k0s(),i.DNE(10,c1,5,1,"div",26),i.j41(11,"ion-button",27),i.bIt("click",function(){f.eBV(d);const s=i.XpG();return f.Njj(s.dismissResults())}),i.EFF(12),i.k0s()()()}if(2&c){const d=i.XpG();i.R7$(),i.HbH(d.resultStatus),i.R7$(2),i.Y8G("ngIf","correct"===d.resultStatus),i.R7$(),i.Y8G("ngIf","befuddled"===d.resultStatus),i.R7$(),i.Y8G("ngIf","wrong"===d.resultStatus),i.R7$(2),i.JRh(d.resultFeedback),i.R7$(2),i.JRh(d.strokeCountInfo),i.R7$(),i.Y8G("ngIf",d.displayMatches.length>0),i.R7$(2),i.JRh(d.dismissButtonText)}}let T=(()=>{var c;class g{constructor(o,s,a){this.strokeRecognition=o,this.cardsService=s,this.segmentationService=a,this.isDrawing=!1,this.strokes=[],this.currentStroke=[],this.drawStartTime=0,this.currentCharacter="",this.promptText="",this.promptColor="#FFFFFF",this.noCardsAvailable=!1,this.isChecking=!1,this.showResults=!1,this.resultStatus="",this.resultFeedback="",this.strokeCountInfo="",this.topMatches=[],this.displayMatches=[],this.cardAvailabilitySubscription=null,this.segmentationTimer=null,this.segmentationResult=null,this.SEGMENTATION_DELAY_MS=500,this.lastBatchResults=[],this.correctFeedback=["\u6b63\u89e3!","\u307e\u308b!","\u306f\u306a\u307e\u308b!","\u3088\u304f\u3084\u3063\u305f!","\u3059\u3054\u3044!","\u304b\u3093\u307a\u304d!","\u3070\u3063\u3061\u308a!","\u305d\u306e\u8abf\u5b50!"],this.wrongFeedback=["\u3061\u304c\u3046!","\u3056\u3093\u306d\u3093!","\u306f\u305a\u308c!","\u3075\u305b\u3044\u304b\u3044!","\u30d0\u30c4!"],this.checkButtonLabels=["\u3088\u3057!","\u5224\u5b9a!","\u3067\u304d\u305f!","\u3044\u3056!","\u78ba\u8a8d"],this.dismissButtonLabels=["\u6b21!","\u3064\u304e!","\u3088\u3057!","\u30aa\u30c3\u30b1\u30fc!","\u306f\u3044!","\u4e86\u89e3!","\u3044\u304f\u305e!"],this.checkButtonText="",this.dismissButtonText="",this.minBrushSize=3,this.maxBrushSize=24,this.brushSmoothing=.05,this.lastBrushSize=0,function(c){Object.keys(c).forEach(function(g){R(g,c[g]);var d=g.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();g!==d&&R(d,c[g])})}({backspace:"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M403.13 96H156.87a44.9 44.9 0 00-33.68 15.27 15.88 15.88 0 00-1.91 2.7L32 247.75a16 16 0 000 16.5l89.15 133.57a16.24 16.24 0 002 2.88 44.89 44.89 0 0033.7 15.3h246.28A44.92 44.92 0 00448 371.13V140.87A44.92 44.92 0 00403.13 96zM348 311a16 16 0 11-22.63 22.62L271.67 280 218 333.65A16 16 0 01195.35 311L249 257.33l-53.69-53.69A16 16 0 01218 181l53.69 53.7 53.67-53.7A16 16 0 01348 203.64l-53.7 53.69z'/></svg>"})}ngOnInit(){var o=this;return(0,y.A)(function*(){o.checkButtonText=o.randomFrom(o.checkButtonLabels),yield o.cardsService.initialize(),o.loadRandomCard(),o.cardAvailabilitySubscription=o.cardsService.cardAvailability$.subscribe(s=>{o.noCardsAvailable&&s>0&&o.loadRandomCard()})})()}loadRandomCard(){this.currentCard=this.cardsService.getRandomUnlockedCard(),this.currentCard?(this.currentCharacter=this.currentCard.answer,this.promptText=this.currentCard.prompt,this.promptColor=this.cardsService.getStageColor(this.currentCard.stage),this.noCardsAvailable=!1):(this.noCardsAvailable=!0,this.promptText="",this.promptColor="#FFFFFF")}ngAfterViewInit(){setTimeout(()=>this.setupCanvas(),100)}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.cardAvailabilitySubscription&&this.cardAvailabilitySubscription.unsubscribe(),this.cancelSegmentation()}setupCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(s),this.ctx=o.getContext("2d"),this.setCanvasStyle(),o.addEventListener("mousedown",this.handleMouseDown.bind(this)),o.addEventListener("mousemove",this.handleMouseMove.bind(this)),o.addEventListener("mouseup",this.handleMouseUp.bind(this)),o.addEventListener("mouseleave",this.handleMouseUp.bind(this)),o.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),o.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),o.addEventListener("touchend",this.handleTouchEnd.bind(this)))}resizeCanvas(){const o=this.canvasRef.nativeElement,s=o.parentElement;s&&(o.width=s.clientWidth,o.height=s.clientHeight,this.ctx&&this.setCanvasStyle())}setCanvasStyle(){this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff",this.ctx.lineCap="round",this.ctx.lineJoin="round"}handleMouseDown(o){this.cancelSegmentation(),this.isDrawing=!0;const s=this.getMousePos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleMouseMove(o){if(!this.isDrawing)return;const s=this.getMousePos(o),a=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(a,s)}handleMouseUp(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}handleTouchStart(o){o.preventDefault(),this.cancelSegmentation(),this.isDrawing=!0;const s=this.getTouchPos(o);this.currentStroke=[s],this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s.x,s.y,1.5*this.minBrushSize)}handleTouchMove(o){if(!this.isDrawing)return;o.preventDefault();const s=this.getTouchPos(o),a=this.currentStroke[this.currentStroke.length-1];this.currentStroke.push(s),this.drawBrushSegment(a,s)}handleTouchEnd(){this.isDrawing&&this.currentStroke.length>0&&(this.drawHarai(this.currentStroke),this.strokes.push([...this.currentStroke]),this.currentStroke=[],this.scheduleSegmentation()),this.isDrawing=!1}getMousePos(o){const s=this.canvasRef.nativeElement,a=s.getBoundingClientRect(),t=s.width/a.width,l=s.height/a.height,e=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=e),{x:(o.clientX-a.left)*t,y:(o.clientY-a.top)*l,t:e-this.drawStartTime}}getTouchPos(o){const s=this.canvasRef.nativeElement,a=s.getBoundingClientRect(),t=s.width/a.width,l=s.height/a.height,e=Date.now();return 0===this.drawStartTime&&(this.drawStartTime=e),{x:(o.touches[0].clientX-a.left)*t,y:(o.touches[0].clientY-a.top)*l,t:e-this.drawStartTime}}calculateBrushSize(o,s){const a=s.x-o.x,t=s.y-o.y,l=Math.max(s.t-o.t,1),v=Math.sqrt(a*a+t*t)/l,n=Math.min(v/1.5,1),w=this.lastBrushSize+(this.maxBrushSize-n*(this.maxBrushSize-this.minBrushSize)-this.lastBrushSize)*this.brushSmoothing;return this.lastBrushSize=w,w}drawBrushPoint(o,s,a){this.ctx.beginPath(),this.ctx.arc(o,s,a/2,0,2*Math.PI),this.ctx.fill()}drawBrushSegment(o,s){const a=this.calculateBrushSize(o,s);this.ctx.lineWidth=a,this.ctx.beginPath(),this.ctx.moveTo(o.x,o.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.drawBrushPoint(s.x,s.y,a)}drawHarai(o){if(o.length<3)return;const s=Math.min(5,o.length),a=o.slice(-s),t=a[a.length-1],l=a[0],e=t.x-l.x,v=t.y-l.y,n=Math.sqrt(e*e+v*v);if(n<5)return;const r=e/n,w=v/n,h=Math.max(t.t-l.t,1),m=Math.min(n/h*20,40);if(m<8)return;const B=this.lastBrushSize;for(let u=0;u<8;u++){const k=(u+1)/8,M=1-Math.pow(1-u/8,2),C=1-Math.pow(1-k,2),H=t.x+r*m*M,h1=t.y+w*m*M,w1=t.x+r*m*C,d1=t.y+w*m*C,I=B*(1-k);I>.5&&(this.ctx.lineWidth=I,this.ctx.beginPath(),this.ctx.moveTo(H,h1),this.ctx.lineTo(w1,d1),this.ctx.stroke())}}onCheck(){var o=this;return(0,y.A)(function*(){if(0!==o.strokes.length&&o.currentCard){o.isChecking=!0;try{const s=o.canvasRef.nativeElement;o.segmentationResult||(o.segmentationResult=o.segmentationService.segment(o.strokes,s.width,s.height));const a=o.segmentationResult.mesh,t=a.cells.filter(r=>r.strokeIndices.length>0);let l;if(t.length<=1)o.lastBatchResults=[],l=yield o.strokeRecognition.recognize(o.strokes,s.width,s.height);else{const r=[...t].sort((m,x)=>m.column!==x.column?m.column-x.column:m.row-x.row),w=r.map(m=>{const x=m.strokeIndices.map(H=>o.strokes[H]),[B,u,z,k]=m.vertexIndices.map(H=>a.vertices[H]);return{strokes:x,bounds:{width:Math.max(Math.abs(u.x-B.x),Math.abs(z.x-k.x)),height:Math.max(Math.abs(k.y-B.y),Math.abs(z.y-u.y))}}}),h=yield o.strokeRecognition.recognizeBatch(w);o.lastBatchResults=h,l=[{character:h.map(m=>m[0]?.character||"?").join(""),score:100}],console.log("Cell interpretations (Japanese reading order):",h.map((m,x)=>({cell:x,position:`col ${r[x].column}, row ${r[x].row}`,top5:m.slice(0,5).map(B=>B.character)})))}o.topMatches=l.slice(0,5);const e=o.currentCharacter.replace(/\s+/g,"");let v=!1;if(o.lastBatchResults.length>0){const r=[...e];r.length===o.lastBatchResults.length&&(v=r.every((w,h)=>o.lastBatchResults[h].slice(0,5).map(m=>m.character).includes(w))),console.log("Grading multi-char:",{target:e,targetChars:r,cellResults:o.lastBatchResults.map(w=>w.slice(0,5).map(h=>h.character)),isCorrect:v})}else v=o.topMatches.map(w=>w.character).includes(e);if(v)o.resultStatus="correct",o.resultFeedback=o.randomFrom(o.correctFeedback),o.displayMatches=o.topMatches.slice(0,1),o.cardsService.advanceCard(o.currentCard.id);else{let r;if(o.lastBatchResults.length>0)r=o.currentCard.befuddlers.find(w=>{const h=[...w.answer.replace(/\s+/g,"")];return h.length===o.lastBatchResults.length&&h.every((p,m)=>o.lastBatchResults[m].slice(0,5).map(B=>B.character).includes(p))});else{const w=o.topMatches.map(h=>h.character);r=o.currentCard.befuddlers.find(h=>w.includes(h.answer.replace(/\s+/g,"")))}r?(o.resultStatus="befuddled",o.resultFeedback=r.toast,o.displayMatches=o.topMatches):(o.resultStatus="wrong",o.resultFeedback=o.randomFrom(o.wrongFeedback),o.displayMatches=o.topMatches)}const n=o.strokeRecognition.getExpectedStrokeCount(o.currentCharacter);o.strokeCountInfo=`Strokes: ${o.strokes.length}/${n}`}catch(s){console.error("Recognition error:",s),o.resultStatus="wrong",o.resultFeedback=s.message||"Recognition failed. Please try on a device.",o.topMatches=[],o.displayMatches=[],o.strokeCountInfo=""}o.isChecking=!1,o.checkButtonText=o.randomFrom(o.checkButtonLabels),o.dismissButtonText=o.randomFrom(o.dismissButtonLabels),o.showResults=!0}})()}dismissResults(){this.showResults=!1,this.clearCanvas(),("correct"===this.resultStatus||"wrong"===this.resultStatus)&&this.loadRandomCard()}onUndo(){this.strokes.length>0&&(this.strokes.pop(),this.redrawStrokes(),this.scheduleSegmentation())}redrawStrokes(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.setCanvasStyle();for(const s of this.strokes)if(0!==s.length){this.lastBrushSize=(this.minBrushSize+this.maxBrushSize)/2,this.drawBrushPoint(s[0].x,s[0].y,1.5*this.minBrushSize);for(let a=1;a<s.length;a++)this.drawBrushSegment(s[a-1],s[a]);this.drawHarai(s)}}clearCanvas(){const o=this.canvasRef.nativeElement;this.ctx.clearRect(0,0,o.width,o.height),this.strokes=[],this.drawStartTime=0,this.cancelSegmentation(),this.segmentationResult=null}randomFrom(o){return o[Math.floor(Math.random()*o.length)]}scheduleSegmentation(){this.cancelSegmentation(),0!==this.strokes.length?this.segmentationTimer=setTimeout(()=>{this.analyzeAndVisualize()},this.SEGMENTATION_DELAY_MS):this.segmentationResult=null}cancelSegmentation(){null!==this.segmentationTimer&&(clearTimeout(this.segmentationTimer),this.segmentationTimer=null)}analyzeAndVisualize(){if(0===this.strokes.length)return void(this.segmentationResult=null);const o=this.canvasRef.nativeElement;this.segmentationResult=this.segmentationService.segment(this.strokes,o.width,o.height),this.redrawWithBoundaries()}redrawWithBoundaries(){this.redrawStrokes(),this.segmentationResult&&this.segmentationResult.mesh.cells.length>0&&this.drawMeshGrid(this.segmentationResult.mesh)}drawMeshGrid(o){this.ctx.save(),this.ctx.strokeStyle="rgba(128, 128, 128, 0.5)",this.ctx.lineWidth=2,this.ctx.setLineDash([6,4]);const s=new Set,a=(t,l)=>{s.add(t<l?`${t}-${l}`:`${l}-${t}`)};for(const t of o.cells){const[l,e,v,n]=t.vertexIndices;a(l,e),a(e,v),a(v,n),a(n,l)}this.ctx.beginPath();for(const t of s){const[l,e]=t.split("-").map(Number),v=o.vertices[l],n=o.vertices[e];v&&n&&(this.ctx.moveTo(v.x,v.y),this.ctx.lineTo(n.x,n.y))}this.ctx.stroke(),this.ctx.restore()}static#o=c=()=>(this.\u0275fac=function(s){return new(s||g)(i.rXU(W),i.rXU(F.D),i.rXU($))},this.\u0275cmp=i.VBU({type:g,selectors:[["app-workbook"]],viewQuery:function(s,a){if(1&s&&i.GBs(J,5),2&s){let t;i.mGM(t=i.lsd())&&(a.canvasRef=t.first)}},decls:11,vars:10,consts:[["canvas",""],[1,"workbook-content",3,"fullscreen","scrollY"],[1,"prompt-bar"],["color","light"],[1,"prompt-text"],[1,"canvas-wrapper"],["class","drawing-canvas",4,"ngIf"],["class","undo-btn","fill","clear",3,"click",4,"ngIf"],["class","caught-up-box",4,"ngIf"],["class","check-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","results-overlay",3,"click",4,"ngIf"],[1,"drawing-canvas"],["fill","clear",1,"undo-btn",3,"click"],["name","backspace"],[1,"caught-up-box"],[1,"caught-up-title"],[1,"caught-up-message"],["color","primary",1,"check-btn",3,"click","disabled"],["name","crescent",4,"ngIf"],[4,"ngIf"],["name","crescent"],[1,"results-overlay",3,"click"],[1,"results-card",3,"click"],[1,"status-display"],[1,"feedback"],[1,"stroke-info"],["class","matches-section",4,"ngIf"],["expand","block",3,"click"],[1,"matches-section"],[1,"matches-title"],[1,"matches-list"],["class","match-item",4,"ngFor","ngForOf"],[1,"match-item"],[1,"match-char"]],template:function(s,a){1&s&&(i.j41(0,"ion-content",1)(1,"div",2),i.nrm(2,"ion-menu-button",3),i.j41(3,"span",4),i.EFF(4),i.k0s()(),i.j41(5,"div",5),i.DNE(6,Z,2,0,"canvas",6)(7,Q,2,0,"ion-button",7)(8,K,5,0,"div",8),i.k0s(),i.DNE(9,a1,3,3,"ion-button",9)(10,e1,13,9,"div",10),i.k0s()),2&s&&(i.Y8G("fullscreen",!0)("scrollY",!1),i.R7$(3),i.xc7("color",a.promptColor),i.R7$(),i.JRh(a.promptText),i.R7$(2),i.Y8G("ngIf",!a.noCardsAvailable),i.R7$(),i.Y8G("ngIf",!a.noCardsAvailable),i.R7$(),i.Y8G("ngIf",a.noCardsAvailable),i.R7$(),i.Y8G("ngIf",!a.noCardsAvailable),i.R7$(),i.Y8G("ngIf",a.showResults))},dependencies:[V.W9,V.MC,V.Jm,V.iq,V.w2,A.MD,A.Sq,A.bT],styles:[".workbook-content[_ngcontent-%COMP%]{--background: #000}.prompt-bar[_ngcontent-%COMP%]{display:flex;align-items:center;height:144px;background:#111;padding:0 8px}.prompt-text[_ngcontent-%COMP%]{flex:1;text-align:center;font-size:28px;color:#fff;margin-right:40px}.canvas-wrapper[_ngcontent-%COMP%]{position:absolute;inset:144px 0 0;background:#000}.drawing-canvas[_ngcontent-%COMP%]{width:100%;height:100%;touch-action:none;display:block}.undo-btn[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;--color: #666;--padding-start: 8px;--padding-end: 8px;font-size:24px}.results-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000e6;display:flex;align-items:center;justify-content:center;z-index:100}.results-card[_ngcontent-%COMP%]{background:#1a1a1a;border-radius:16px;padding:24px;min-width:280px;max-width:90%;text-align:center}.results-card.correct[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.correct[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#e63946}.results-card.befuddled[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.befuddled[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#f7b731}.results-card.wrong[_ngcontent-%COMP%]   .status-display[_ngcontent-%COMP%], .results-card.wrong[_ngcontent-%COMP%]   .feedback[_ngcontent-%COMP%]{color:#4a90d9}.status-display[_ngcontent-%COMP%]{font-size:64px;font-weight:700;margin-bottom:8px}.feedback[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-size:18px;margin-bottom:16px;white-space:pre-line}.stroke-info[_ngcontent-%COMP%]{font-size:14px;color:#888;margin-bottom:20px}.matches-section[_ngcontent-%COMP%]{border-top:1px solid #333;padding-top:16px;margin-bottom:20px}.matches-title[_ngcontent-%COMP%]{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.matches-list[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:16px}.match-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.match-char[_ngcontent-%COMP%]{font-size:32px;color:#fff}.check-btn[_ngcontent-%COMP%]{position:absolute;bottom:32px;left:50%;transform:translate(-50%);--background: #222;--background-hover: #333;--color: #fff;--border-radius: 32px;--padding-start: 12vw;--padding-end: 12vw;--padding-top: 16px;--padding-bottom: 16px;min-height:60px;font-family:Shippori Mincho,serif;font-size:clamp(20px,5vw,28px);font-weight:600;letter-spacing:2px}.results-card[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{font-family:Shippori Mincho,serif;font-weight:700}.caught-up-box[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border-radius:16px;padding:32px;text-align:center;max-width:90%;width:320px}.caught-up-title[_ngcontent-%COMP%]{font-size:36px;margin-bottom:16px}.caught-up-message[_ngcontent-%COMP%]{font-size:16px;color:#ccc;line-height:1.5}"]}))}return c(),g})();const r1=[{path:"",component:T}];let v1=(()=>{var c;class g{static#o=c=()=>(this.\u0275fac=function(s){return new(s||g)},this.\u0275mod=i.$C({type:g}),this.\u0275inj=f.G2t({imports:[_.iI.forChild(r1),_.iI]}))}return c(),g})(),g1=(()=>{var c;class g{static#o=c=()=>(this.\u0275fac=function(s){return new(s||g)},this.\u0275mod=i.$C({type:g}),this.\u0275inj=f.G2t({imports:[A.MD,E.YN,U.bv,v1,T]}))}return c(),g})()}}]);